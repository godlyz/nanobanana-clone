# è®¢é˜…ç®¡ç† API è®¾è®¡æ–‡æ¡£

> åˆ›å»ºæ—¶é—´: 2025-11-09
> ä½œè€…: è€ç‹
> çŠ¶æ€: è®¾è®¡ä¸­

## 1. èƒŒæ™¯

å½“å‰é¡¹ç›®å·²å®ç°ï¼š
- âœ… è®¢é˜…åˆ›å»ºï¼ˆ`POST /api/checkout`ï¼‰
- âœ… è®¢é˜…çŠ¶æ€æŸ¥è¯¢ï¼ˆ`GET /api/subscription/status`ï¼‰
- âœ… Webhookäº‹ä»¶å¤„ç†ï¼ˆ`POST /api/webhooks/creem`ï¼‰

å¾…å®ç°åŠŸèƒ½ï¼š
- âŒ è®¢é˜…å‡çº§
- âŒ è®¢é˜…é™çº§
- âŒ è®¢é˜…ç»­è®¢
- âŒ è®¢é˜…å–æ¶ˆ

## 2. è®¢é˜…è®¡åˆ’å±‚çº§

```
Free (å…è´¹) â†’ Basic (åŸºç¡€) â†’ Pro (ä¸“ä¸š) â†’ Max (è‡³å°Š)
```

### 2.1 ç§¯åˆ†è§„åˆ™

| è®¡åˆ’ | æœˆä»˜ç§¯åˆ† | å¹´ä»˜ç§¯åˆ† | å¹´ä»˜ä¼˜æƒ  |
|------|---------|---------|---------|
| Free | 20 | - | - |
| Basic | 150 | 1800 (150Ã—12) | åŒ…å«åœ¨å¹´è´¹ä¸­ |
| Pro | 800 | 9600 (800Ã—12) | åŒ…å«åœ¨å¹´è´¹ä¸­ |
| Max | 1600 | 19200 (1600Ã—12) | åŒ…å«åœ¨å¹´è´¹ä¸­ |

### 2.2 å®šä»·è§„åˆ™

| è®¡åˆ’ | æœˆä»˜ä»·æ ¼ | å¹´ä»˜ä»·æ ¼ | å¹´ä»˜ä¼˜æƒ  |
|------|---------|---------|---------|
| Basic | $12/æœˆ | $144/å¹´ | åŸä»·$180ï¼Œä¼˜æƒ 20% |
| Pro | $19.50/æœˆ | $234/å¹´ | åŸä»·$468ï¼Œä¼˜æƒ 50% |
| Max | $80/æœˆ | $960/å¹´ | åŸä»·$1920ï¼Œä¼˜æƒ 50% |

## 3. API è®¾è®¡

### 3.1 è®¢é˜…å‡çº§ API

**è·¯å¾„**ï¼š`POST /api/subscription/upgrade`

**æè¿°**ï¼šç”¨æˆ·å‡çº§åˆ°æ›´é«˜çº§åˆ«çš„è®¢é˜…è®¡åˆ’ã€‚

**è¯·æ±‚å‚æ•°**ï¼š
```json
{
  "targetPlan": "pro",           // ç›®æ ‡è®¡åˆ’: "basic" | "pro" | "max"
  "billingPeriod": "monthly"     // è®¡è´¹å‘¨æœŸ: "monthly" | "yearly"
}
```

**ä¸šåŠ¡é€»è¾‘**ï¼š
1. éªŒè¯ç”¨æˆ·ç™»å½•çŠ¶æ€
2. è·å–ç”¨æˆ·å½“å‰è®¢é˜…çŠ¶æ€
3. éªŒè¯å‡çº§æœ‰æ•ˆæ€§ï¼ˆç›®æ ‡è®¡åˆ’ > å½“å‰è®¡åˆ’ï¼‰
4. è·å–ç›®æ ‡è®¡åˆ’çš„Creemäº§å“ID
5. åˆ›å»ºCreem checkout session
6. è¿”å›æ”¯ä»˜URL

**è¿”å›æ•°æ®**ï¼š
```json
{
  "success": true,
  "checkoutUrl": "https://checkout.creem.io/xxx",
  "sessionId": "checkout_xxx",
  "currentPlan": "basic",
  "targetPlan": "pro",
  "billingPeriod": "monthly"
}
```

**é”™è¯¯æƒ…å†µ**ï¼š
- `401`: ç”¨æˆ·æœªç™»å½•
- `400`: å‚æ•°é”™è¯¯ï¼ˆç›®æ ‡è®¡åˆ’æ— æ•ˆã€ä¸æ˜¯å‡çº§æ“ä½œï¼‰
- `400`: ç”¨æˆ·æ²¡æœ‰å½“å‰è®¢é˜…
- `500`: Creem APIè°ƒç”¨å¤±è´¥

### 3.2 è®¢é˜…é™çº§ API

**è·¯å¾„**ï¼š`POST /api/subscription/downgrade`

**æè¿°**ï¼šç”¨æˆ·é™çº§åˆ°æ›´ä½çº§åˆ«çš„è®¢é˜…è®¡åˆ’ï¼ˆåœ¨å½“å‰å‘¨æœŸç»“æŸæ—¶ç”Ÿæ•ˆï¼‰ã€‚

**è¯·æ±‚å‚æ•°**ï¼š
```json
{
  "targetPlan": "basic",         // ç›®æ ‡è®¡åˆ’: "basic" | "pro"
  "billingPeriod": "monthly"     // è®¡è´¹å‘¨æœŸ: "monthly" | "yearly"
}
```

**ä¸šåŠ¡é€»è¾‘**ï¼š
1. éªŒè¯ç”¨æˆ·ç™»å½•çŠ¶æ€
2. è·å–ç”¨æˆ·å½“å‰è®¢é˜…çŠ¶æ€
3. éªŒè¯é™çº§æœ‰æ•ˆæ€§ï¼ˆç›®æ ‡è®¡åˆ’ < å½“å‰è®¡åˆ’ï¼‰
4. **é‡è¦**ï¼šé™çº§åœ¨å½“å‰è®¢é˜…å‘¨æœŸç»“æŸåç”Ÿæ•ˆ
5. åœ¨æ•°æ®åº“ä¸­è®°å½•é™çº§è®¡åˆ’ï¼ˆ`user_subscriptions.downgrade_to_plan`ï¼‰
6. è¿”å›é™çº§ç¡®è®¤ä¿¡æ¯

**è¿”å›æ•°æ®**ï¼š
```json
{
  "success": true,
  "currentPlan": "pro",
  "targetPlan": "basic",
  "currentPeriodEnd": "2025-12-09T00:00:00Z",
  "effectiveDate": "2025-12-09T00:00:00Z",
  "message": "é™çº§å°†åœ¨å½“å‰è®¢é˜…å‘¨æœŸç»“æŸåç”Ÿæ•ˆ"
}
```

**é”™è¯¯æƒ…å†µ**ï¼š
- `401`: ç”¨æˆ·æœªç™»å½•
- `400`: å‚æ•°é”™è¯¯ï¼ˆç›®æ ‡è®¡åˆ’æ— æ•ˆã€ä¸æ˜¯é™çº§æ“ä½œï¼‰
- `400`: ç”¨æˆ·æ²¡æœ‰å½“å‰è®¢é˜…
- `500`: æ•°æ®åº“æ›´æ–°å¤±è´¥

**Cron Jobï¼ˆå®šæ—¶ä»»åŠ¡ï¼‰**ï¼š
- éœ€è¦å®ç°å®šæ—¶ä»»åŠ¡ï¼Œæ£€æŸ¥åˆ°æœŸçš„è®¢é˜…
- å¦‚æœè®¢é˜…æœ‰é™çº§è®¡åˆ’ï¼Œåˆ™è‡ªåŠ¨åˆ›å»ºæ–°çš„checkout session
- æˆ–è€…ï¼šåœ¨Webhookçš„`subscription.expired`äº‹ä»¶ä¸­å¤„ç†

### 3.3 è®¢é˜…ç»­è®¢ API

**è·¯å¾„**ï¼š`POST /api/subscription/renew`

**æè¿°**ï¼šç”¨æˆ·ç»­è®¢å·²åˆ°æœŸçš„è®¢é˜…ã€‚

**è¯·æ±‚å‚æ•°**ï¼š
```json
{
  "billingPeriod": "monthly"     // è®¡è´¹å‘¨æœŸ: "monthly" | "yearly"ï¼ˆå¯é€‰ï¼Œé»˜è®¤ä½¿ç”¨åŸå‘¨æœŸï¼‰
}
```

**ä¸šåŠ¡é€»è¾‘**ï¼š
1. éªŒè¯ç”¨æˆ·ç™»å½•çŠ¶æ€
2. è·å–ç”¨æˆ·å½“å‰è®¢é˜…çŠ¶æ€
3. éªŒè¯è®¢é˜…æ˜¯å¦å·²åˆ°æœŸæˆ–å³å°†åˆ°æœŸ
4. è·å–åŸè®¢é˜…è®¡åˆ’çš„Creemäº§å“ID
5. åˆ›å»ºCreem checkout session
6. è¿”å›æ”¯ä»˜URL

**è¿”å›æ•°æ®**ï¼š
```json
{
  "success": true,
  "checkoutUrl": "https://checkout.creem.io/xxx",
  "sessionId": "checkout_xxx",
  "plan": "pro",
  "billingPeriod": "monthly",
  "expiredAt": "2025-11-01T00:00:00Z"
}
```

**é”™è¯¯æƒ…å†µ**ï¼š
- `401`: ç”¨æˆ·æœªç™»å½•
- `400`: è®¢é˜…å°šæœªåˆ°æœŸ
- `400`: ç”¨æˆ·æ²¡æœ‰å†å²è®¢é˜…è®°å½•
- `500`: Creem APIè°ƒç”¨å¤±è´¥

### 3.4 è®¢é˜…å–æ¶ˆ API

**è·¯å¾„**ï¼š`POST /api/subscription/cancel`

**æè¿°**ï¼šç”¨æˆ·å–æ¶ˆå½“å‰è®¢é˜…ï¼ˆåœ¨å½“å‰å‘¨æœŸç»“æŸæ—¶ç”Ÿæ•ˆï¼‰ã€‚

**è¯·æ±‚å‚æ•°**ï¼š
```json
{
  "reason": "å¤ªè´µäº†",            // å–æ¶ˆåŸå› ï¼ˆå¯é€‰ï¼‰
  "feedback": "å¸Œæœ›æœ‰æ›´ä¾¿å®œçš„å¥—é¤" // ç”¨æˆ·åé¦ˆï¼ˆå¯é€‰ï¼‰
}
```

**ä¸šåŠ¡é€»è¾‘**ï¼š
1. éªŒè¯ç”¨æˆ·ç™»å½•çŠ¶æ€
2. è·å–ç”¨æˆ·å½“å‰è®¢é˜…çŠ¶æ€
3. éªŒè¯è®¢é˜…æ˜¯å¦å¯å–æ¶ˆ
4. **è°ƒç”¨Creem APIå–æ¶ˆè®¢é˜…**ï¼ˆæˆ–åœ¨æ•°æ®åº“æ ‡è®°ä¸ºå¾…å–æ¶ˆï¼‰
5. æ›´æ–°æ•°æ®åº“çŠ¶æ€
6. è¿”å›å–æ¶ˆç¡®è®¤ä¿¡æ¯

**è¿”å›æ•°æ®**ï¼š
```json
{
  "success": true,
  "currentPlan": "pro",
  "cancelledAt": "2025-11-09T00:00:00Z",
  "currentPeriodEnd": "2025-12-09T00:00:00Z",
  "message": "è®¢é˜…å°†åœ¨å½“å‰å‘¨æœŸç»“æŸåå–æ¶ˆ"
}
```

**é”™è¯¯æƒ…å†µ**ï¼š
- `401`: ç”¨æˆ·æœªç™»å½•
- `400`: ç”¨æˆ·æ²¡æœ‰å½“å‰è®¢é˜…
- `400`: è®¢é˜…å·²è¢«å–æ¶ˆ
- `500`: Creem APIè°ƒç”¨å¤±è´¥

## 4. æ•°æ®åº“Schemaæ‰©å±•

éœ€è¦åœ¨`user_subscriptions`è¡¨ä¸­æ·»åŠ å­—æ®µï¼š

```sql
ALTER TABLE user_subscriptions ADD COLUMN IF NOT EXISTS downgrade_to_plan TEXT;
ALTER TABLE user_subscriptions ADD COLUMN IF NOT EXISTS downgrade_to_billing_cycle TEXT;
ALTER TABLE user_subscriptions ADD COLUMN IF NOT EXISTS cancel_reason TEXT;
ALTER TABLE user_subscriptions ADD COLUMN IF NOT EXISTS cancel_feedback TEXT;
ALTER TABLE user_subscriptions ADD COLUMN IF NOT EXISTS cancel_requested_at TIMESTAMPTZ;
```

## 5. å‰ç«¯ç•Œé¢ä¿®æ”¹

### 5.1 ç”¨æˆ·ä¸ªäººä¸­å¿ƒé¡µé¢ï¼ˆ`/profile`ï¼‰

**å½“å‰è®¢é˜…ä¿¡æ¯åŒºå—**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å½“å‰è®¢é˜…: Pro (ä¸“ä¸šç‰ˆ)                            â”‚
â”‚ è®¡è´¹å‘¨æœŸ: æœˆä»˜                                   â”‚
â”‚ åˆ°æœŸæ—¶é—´: 2025-12-09                             â”‚
â”‚ çŠ¶æ€: æ´»è·ƒ                                       â”‚
â”‚                                                  â”‚
â”‚ [å‡çº§åˆ°Max] [é™çº§åˆ°Basic] [å–æ¶ˆè®¢é˜…] [ç»­è®¢]      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 æŒ‰é’®æ˜¾ç¤ºé€»è¾‘

| å½“å‰çŠ¶æ€ | æ˜¾ç¤ºçš„æŒ‰é’® |
|---------|-----------|
| Free | [å‡çº§åˆ°Basic] [å‡çº§åˆ°Pro] [å‡çº§åˆ°Max] |
| Basic (æ´»è·ƒ) | [å‡çº§åˆ°Pro] [å‡çº§åˆ°Max] [å–æ¶ˆè®¢é˜…] |
| Pro (æ´»è·ƒ) | [å‡çº§åˆ°Max] [é™çº§åˆ°Basic] [å–æ¶ˆè®¢é˜…] |
| Max (æ´»è·ƒ) | [é™çº§åˆ°Pro] [é™çº§åˆ°Basic] [å–æ¶ˆè®¢é˜…] |
| ä»»ä½• (å·²åˆ°æœŸ) | [ç»­è®¢] |

### 5.3 ç¡®è®¤å¯¹è¯æ¡†

å‡çº§/é™çº§/å–æ¶ˆæ—¶éƒ½åº”å¼¹å‡ºç¡®è®¤å¯¹è¯æ¡†ï¼Œæ˜¾ç¤ºï¼š
- å½“å‰è®¡åˆ’ vs ç›®æ ‡è®¡åˆ’
- ä»·æ ¼å˜åŒ–
- ç”Ÿæ•ˆæ—¶é—´
- æ³¨æ„äº‹é¡¹

## 6. å®ç°æ­¥éª¤

### Phase 1: APIå®ç°ï¼ˆé¢„è®¡2å°æ—¶ï¼‰
1. âœ… åˆ›å»º`/api/subscription/upgrade/route.ts`
2. âœ… åˆ›å»º`/api/subscription/downgrade/route.ts`
3. âœ… åˆ›å»º`/api/subscription/renew/route.ts`
4. âœ… åˆ›å»º`/api/subscription/cancel/route.ts`

### Phase 2: æ•°æ®åº“è¿ç§»ï¼ˆé¢„è®¡30åˆ†é’Ÿï¼‰
1. âœ… åˆ›å»ºæ•°æ®åº“è¿ç§»è„šæœ¬
2. âœ… æ·»åŠ æ–°å­—æ®µåˆ°`user_subscriptions`è¡¨

### Phase 3: å‰ç«¯ç•Œé¢ï¼ˆé¢„è®¡2å°æ—¶ï¼‰
1. âœ… ä¿®æ”¹`/app/profile/page.tsx`
2. âœ… æ·»åŠ è®¢é˜…ç®¡ç†ç»„ä»¶
3. âœ… å®ç°å‡çº§/é™çº§/ç»­è®¢/å–æ¶ˆæŒ‰é’®
4. âœ… æ·»åŠ ç¡®è®¤å¯¹è¯æ¡†

### Phase 4: æµ‹è¯•ï¼ˆé¢„è®¡1å°æ—¶ï¼‰
1. âœ… å•å…ƒæµ‹è¯•ï¼šAPIè·¯ç”±æµ‹è¯•
2. âœ… é›†æˆæµ‹è¯•ï¼šå®Œæ•´è®¢é˜…æµç¨‹æµ‹è¯•
3. âœ… æ‰‹åŠ¨æµ‹è¯•ï¼šUIäº¤äº’æµ‹è¯•

## 7. æ³¨æ„äº‹é¡¹

### 7.1 Creem APIé™åˆ¶
- éœ€è¦ç¡®è®¤Creemæ˜¯å¦æ”¯æŒè®¢é˜…å‡çº§/é™çº§API
- å¦‚æœä¸æ”¯æŒï¼Œå¯èƒ½éœ€è¦ï¼š
  1. å–æ¶ˆå½“å‰è®¢é˜…
  2. åˆ›å»ºæ–°è®¢é˜…
  3. æ‰‹åŠ¨å¤„ç†ç§¯åˆ†è½¬ç§»

### 7.2 ç§¯åˆ†å¤„ç†
- **å‡çº§**ï¼šç«‹å³å¢åŠ ç§¯åˆ†å·®é¢
- **é™çº§**ï¼šå½“å‰å‘¨æœŸç»“æŸåæ‰å‡å°‘ç§¯åˆ†ï¼ˆä¿ç•™å‰©ä½™ç§¯åˆ†ï¼‰
- **å–æ¶ˆ**ï¼šå‰©ä½™ç§¯åˆ†ä¿ç•™åˆ°è®¢é˜…åˆ°æœŸ

### 7.3 é€€æ¬¾æ”¿ç­–
- é™çº§ï¼šä¸é€€æ¬¾ï¼Œå½“å‰å‘¨æœŸç»§ç»­ä½¿ç”¨
- å–æ¶ˆï¼šä¸é€€æ¬¾ï¼Œå½“å‰å‘¨æœŸç»§ç»­ä½¿ç”¨
- å‡çº§ï¼šç«‹å³ç”Ÿæ•ˆï¼ŒæŒ‰æ¯”ä¾‹è®¡è´¹ï¼ˆCreemå¤„ç†ï¼‰

## 8. åç»­ä¼˜åŒ–

- [ ] æ·»åŠ è®¢é˜…æš‚åœåŠŸèƒ½
- [ ] æ·»åŠ è®¢é˜…å†»ç»“åŠŸèƒ½
- [ ] å®ç°è‡ªåŠ¨ç»­è®¢å¼€å…³
- [ ] æ·»åŠ è´¦å•å†å²é¡µé¢
- [ ] å®ç°å‘ç¥¨ä¸‹è½½åŠŸèƒ½
- [ ] æ·»åŠ é‚®ä»¶é€šçŸ¥ï¼ˆè®¢é˜…åˆ°æœŸæé†’ï¼‰

---

**è€ç‹ç­¾å** ğŸ”¥
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2025-11-09
