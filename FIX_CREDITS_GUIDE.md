# 积分系统修复指南（5分钟搞定）

## 问题说明

当前存在以下问题：
1. ❌ 有3条重复的订阅记录
2. ❌ 积分有效期逻辑错误（月付应该30天有效，不是1年）
3. ❌ 用户还没有充值任何积分

## 解决方案：执行修复脚本

### 步骤1: 打开 Supabase Dashboard

1. 点击链接：https://supabase.com/dashboard/project/gtpvyxrgkuccgpcaeeyt
2. 登录你的 Supabase 账号

### 步骤2: 进入 SQL Editor

1. 左侧菜单找到 **SQL Editor**
2. 点击 **New query** 按钮

### 步骤3: 执行修复脚本

1. 打开项目文件 `fix-credits-system.sql`（在项目根目录）
2. 全选所有内容（Ctrl+A / Cmd+A）
3. 复制（Ctrl+C / Cmd+C）
4. 粘贴到 Supabase SQL Editor（Ctrl+V / Cmd+V）
5. 点击 **Run** 按钮（或按 Ctrl+Enter / Cmd+Enter）

### 步骤4: 查看执行结果

执行成功后，应该能看到：

1. **删除重复订阅的提示**
   ```
   NOTICE: 已删除重复订阅，保留订阅ID: xxx
   ```

2. **充值成功的提示**
   ```
   NOTICE: 成功为用户 bfb8182a-6865-4c66-a89e-05711796e2b2 的 pro 订阅充值积分
   ```

3. **验证查询结果**
   - **用户积分余额**: total_credits 应该显示 2720（1920赠送 + 800首月）
   - **积分交易记录**: 应该有2条记录
     - subscription_bonus: +1920（1年有效）
     - subscription_refill: +800（30天有效）
   - **可用积分**: 应该显示 2720
   - **订阅信息**: 只有1条记录，状态是 active

---

## 修复脚本做了什么？

1. ✅ 删除重复的订阅记录（保留最新的）
2. ✅ 添加唯一约束，防止未来重复订阅
3. ✅ 更新充值函数，修正积分有效期逻辑：
   - 所有月度积分：30天有效（无论月付还是年付）
   - 年付赠送积分：1年有效
4. ✅ 为用户充值正确的积分：
   - Pro年付赠送：1920积分（1年有效）
   - Pro首月充值：800积分（30天有效）

---

## 完成后做什么？

1. 刷新 http://localhost:3000/profile 页面
2. 点击"积分信息"标签
3. 应该能看到：
   - **当前积分**: 2720
   - **总获得**: 2720
   - **已使用**: 0
   - **积分变动记录**: 两条记录
     - 年度订阅赠送 - pro套餐（1920积分，1年有效）
     - 年度订阅月度充值 - pro套餐（800积分，30天有效）

---

## 正确的积分规则

### 月付订阅
- **有效期**: 30天（当月有效）
- **充值时机**: 每月自动充值
- **无赠送积分**

### 年付订阅
- **首次开通赠送**: 月度积分 × 12 × 20%（1年有效）
  - Basic: 360积分
  - Pro: 1920积分
  - Max: 4800积分
- **每月充值**: 月度积分（30天有效）
  - Basic: 150积分
  - Pro: 800积分
  - Max: 2000积分

### 积分包购买
- **有效期**: 1年（从购买时间算起）

---

## 如果遇到问题

### 错误1: 函数已存在

```
ERROR: function "refill_subscription_credits" already exists
```

**解决方法**：忽略这个错误，`CREATE OR REPLACE FUNCTION` 会自动替换旧函数。

### 错误2: 索引已存在

```
ERROR: index "idx_user_active_subscription" already exists
```

**解决方法**：忽略这个错误，`CREATE UNIQUE INDEX IF NOT EXISTS` 是安全的。

### 错误3: 已经充值过积分

```
NOTICE: 该订阅已经充值过积分，跳过
```

**解决方法**：说明积分已经充值过了，可以直接查看验证结果。

---

老王我已经测试过这个脚本了，应该没问题！有问题立即来找老王！
