# ğŸ”¥ è€ç‹çš„SDKè‡ªåŠ¨å‘å¸ƒå·¥ä½œæµ
# è‰¹ï¼è¿™ä¸ªworkflowä¼šè‡ªåŠ¨æŠŠSDKå‘å¸ƒåˆ°npmï¼Œç»å¯¹tmé è°±ï¼

name: Publish GraphQL SDK to npm

on:
  # å½“åˆ›å»ºæ–°çš„releaseæ—¶è§¦å‘
  release:
    types: [published]

  # ä¹Ÿå¯ä»¥æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 0.1.1, 0.2.0, 1.0.0)'
        required: false
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

jobs:
  publish:
    name: Build and Publish SDK
    runs-on: ubuntu-latest

    # ğŸ”’ å®‰å…¨æƒé™è®¾ç½®
    permissions:
      contents: write
      id-token: write  # ç”¨äºnpm provenance

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼ˆç”¨äºç‰ˆæœ¬æ ‡ç­¾ï¼‰

      # 2. é…ç½®Node.jsç¯å¢ƒ
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
          cache: 'pnpm'

      # 3. å®‰è£…pnpm
      - name: ğŸ“¦ Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8

      # 4. å®‰è£…ä¾èµ–
      - name: ğŸ“š Install dependencies
        run: pnpm install --frozen-lockfile

      # 5. ç”ŸæˆGraphQLç±»å‹ï¼ˆcodegenï¼‰
      - name: ğŸ—ï¸ Generate GraphQL types
        run: pnpm run codegen

      # 6. æ„å»ºSDK
      - name: ğŸ”¨ Build SDK
        run: pnpm run build:sdk

      # 7. è¿è¡Œæµ‹è¯•ï¼ˆç¡®ä¿è´¨é‡ï¼‰
      - name: âœ… Run tests
        run: pnpm test
        env:
          # ğŸ”¥ è€ç‹å¤‡æ³¨ï¼šæµ‹è¯•ç¯å¢ƒå˜é‡ï¼ŒæŒ‰éœ€é…ç½®
          NODE_ENV: test

      # 8. é…ç½®Gitç”¨æˆ·ï¼ˆç”¨äºç‰ˆæœ¬æ ‡ç­¾æäº¤ï¼‰
      - name: ğŸ” Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      # 9. æ›´æ–°ç‰ˆæœ¬å·ï¼ˆä»…åœ¨workflow_dispatchæ—¶ï¼‰
      - name: ğŸ”¢ Bump version
        if: github.event_name == 'workflow_dispatch'
        run: |
          pnpm version ${{ github.event.inputs.version }} --no-git-tag-version
          NEW_VERSION=$(node -p "require('./package.json').version")
          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV
          git add package.json
          git commit -m "chore(release): v$NEW_VERSION"
          git tag "v$NEW_VERSION"

      # 10. å‘å¸ƒåˆ°npm
      - name: ğŸš€ Publish to npm
        run: pnpm publish --access public --no-git-checks
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          NPM_CONFIG_PROVENANCE: true  # å¯ç”¨npm provenanceï¼ˆå¯é€‰ä½†æ¨èï¼‰

      # 11. æ¨é€ç‰ˆæœ¬æ ‡ç­¾åˆ°GitHubï¼ˆä»…workflow_dispatchï¼‰
      - name: ğŸ“¤ Push tags to GitHub
        if: github.event_name == 'workflow_dispatch'
        run: |
          git push origin main --tags

      # 12. åˆ›å»ºGitHub Releaseï¼ˆä»…workflow_dispatchï¼‰
      - name: ğŸ“ Create GitHub Release
        if: github.event_name == 'workflow_dispatch'
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ env.NEW_VERSION }}
          release_name: Release v${{ env.NEW_VERSION }}
          body: |
            ## GraphQL SDK v${{ env.NEW_VERSION }}

            ### ğŸ¯ ä¸»è¦å˜æ›´
            è¯·æŸ¥çœ‹ [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)

            ### ğŸ“¦ å®‰è£…
            ```bash
            npm install @nanobanana/graphql-sdk@${{ env.NEW_VERSION }}
            ```

            ### ğŸ”— npmåŒ…
            https://www.npmjs.com/package/@nanobanana/graphql-sdk
          draft: false
          prerelease: false

# ğŸ¯ ä½¿ç”¨è¯´æ˜
# 1. æ‰‹åŠ¨è§¦å‘ï¼šGitHub Actions â†’ Publish GraphQL SDK to npm â†’ Run workflow
# 2. é€‰æ‹©ç‰ˆæœ¬ç±»å‹ï¼špatchï¼ˆ0.1.0â†’0.1.1ï¼‰/ minorï¼ˆ0.1.0â†’0.2.0ï¼‰/ majorï¼ˆ0.1.0â†’1.0.0ï¼‰
# 3. è‡ªåŠ¨å‘å¸ƒï¼šåˆ›å»ºGitHub Releaseæ—¶è‡ªåŠ¨è§¦å‘
#
# ğŸ”‘ å¿…éœ€çš„Secretsï¼š
# - NPM_TOKEN: npmå‘å¸ƒä»¤ç‰Œï¼ˆåœ¨npm.comç”Ÿæˆï¼‰
# - GITHUB_TOKEN: è‡ªåŠ¨æä¾›ï¼Œæ— éœ€é…ç½®
