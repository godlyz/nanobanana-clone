# 🔥 积分系统创建指南（5分钟搞定）

## 问题现状

当前有订阅但没有积分，无法测试图像编辑功能。

错误信息：
```
❌ Could not find the table 'public.credit_transactions' in the schema cache
```

## 解决方案：在Supabase Dashboard执行SQL脚本

### 步骤1: 打开Supabase Dashboard

1. 点击这个链接：https://supabase.com/dashboard/project/gtpvyxrgkuccgpcaeeyt
2. 如果需要登录，用你的Supabase账号登录

### 步骤2: 进入SQL Editor

1. 在左侧菜单找到 **SQL Editor** 图标（看起来像一个文档）
2. 点击进入SQL Editor页面
3. 点击页面上的 **New query** 按钮

### 步骤3: 复制粘贴SQL脚本

1. 打开项目文件 `manual-setup-credits.sql`（就在项目根目录）
2. 全选所有内容（Ctrl+A / Cmd+A）
3. 复制（Ctrl+C / Cmd+C）
4. 粘贴到Supabase SQL Editor里（Ctrl+V / Cmd+V）

### 步骤4: 执行SQL脚本

1. 点击右下角的 **Run** 按钮（或按 Ctrl+Enter / Cmd+Enter）
2. 等待几秒钟，SQL执行完毕
3. 如果看到最后有查询结果显示，说明执行成功了！

### 步骤5: 验证结果

执行成功后，应该能看到：

1. **当前用户的积分余额**（应该显示800积分）
2. **积分交易记录**（应该有一条"年度订阅充值"记录）
3. **可用积分数**（应该是800）

---

## 完成后做什么？

1. 回到网站：http://localhost:3000/profile
2. 刷新页面
3. 查看"积分信息"标签
4. 应该能看到：
   - **当前积分**: 800
   - **总获得**: 800
   - **已使用**: 0
   - **积分变动记录**: 一条"年度订阅充值 - pro套餐"记录

---

## 如果遇到问题

### 错误1: 表已存在

```
ERROR: relation "user_credits" already exists
```

**解决方法**：说明表已经创建过了，可以忽略这个错误，继续往下执行。

### 错误2: 策略已存在

```
ERROR: policy "Users can view own credits" already exists
```

**解决方法**：脚本中已经加了 `DROP POLICY IF EXISTS`，如果还报错，说明之前的执行可能不完整。可以忽略这个错误。

### 错误3: 触发器函数不存在

```
ERROR: function update_updated_at_column() does not exist
```

**解决方法**：你需要先执行 `manual-setup-subscription.sql` 脚本，那个脚本里创建了这个函数。

### 错误4: 没有生效的订阅

```
⚠️ 用户没有生效的订阅，跳过积分充值
```

**解决方法**：先执行 `manual-setup-subscription.sql` 创建订阅，然后再执行这个积分脚本。

---

## SQL脚本做了什么？

这个SQL脚本会：

1. ✅ 创建 `user_credits` 表（存储用户总积分）
2. ✅ 创建 `credit_transactions` 表（存储所有积分变动记录）
3. ✅ 创建 `credit_packages` 表（存储可购买的积分包配置）
4. ✅ 创建索引（加快查询速度）
5. ✅ 启用RLS（Row Level Security，确保用户只能看到自己的积分）
6. ✅ 创建RLS策略（安全规则）
7. ✅ 创建触发器（自动更新 `updated_at` 字段）
8. ✅ 创建函数 `get_user_available_credits`（查询可用积分）
9. ✅ 创建函数 `refill_subscription_credits`（订阅充值积分）
10. ✅ 为当前登录用户的专业版订阅自动充值800积分（有效期1年）

---

## 积分规则说明

### 1. 注册赠送积分
- **数量**: 50积分
- **有效期**: 15天
- **触发**: 新用户注册时自动赠送

### 2. 订阅套餐积分

#### 月付订阅
- **基础版 (Basic)**: 每月150积分
- **专业版 (Pro)**: 每月800积分
- **旗舰版 (Max)**: 每月2000积分
- **有效期**: **30天**（当月有效）
- **充值时机**: 每月自动充值

#### 年付订阅
- **基础版 (Basic)**:
  - 首次开通赠送: 360积分（1年有效）
  - 每月充值: 150积分（30天有效）
- **专业版 (Pro)**:
  - 首次开通赠送: 1920积分（1年有效）
  - 每月充值: 800积分（30天有效）
- **旗舰版 (Max)**:
  - 首次开通赠送: 4800积分（1年有效）
  - 每月充值: 2000积分（30天有效）

**年付赠送计算公式**: 月度积分 × 12 × 20%

### 3. 积分包（暂未实现购买功能）
- 入门包: 100积分，$9.90
- 成长包: 500积分，$39.90
- 专业包: 1200积分，$79.90
- 企业包: 5000积分，$299.90
- **有效期**: 1年（从购买时间算起）

### 4. 积分消费
- **文生图**: 1积分/张
- **图生图**: 2积分/张

### 5. 积分过期规则
- 优先消耗即将过期的积分
- 过期的积分自动作废

---

## 老王我的建议

执行完SQL脚本后，**立即**：

1. 刷新 http://localhost:3000/profile 页面
2. 点击"积分信息"标签
3. 应该能看到800积分，以及一条"年度订阅充值 - pro套餐"记录
4. 到期时间是 1 年后（2026年10月26日左右）

现在你就可以去测试图像编辑功能了！

如果还有问题，检查开发服务器的终端日志，看看是什么错误。
