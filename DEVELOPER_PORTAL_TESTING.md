# 开发者门户测试清单

## 🔥 老王说明：API密钥管理系统测试指南

这个文档提供了开发者门户的完整测试步骤和验收标准。老王我已经把代码都写好了，但需要先完成数据库设置才能测试！

---

## ⚠️ 测试前准备（必须完成！）

### 1. 执行数据库迁移

**艹，这一步必须先做！否则API会报错！**

按照 [API_KEYS_SETUP.md](./API_KEYS_SETUP.md) 的步骤：

1. 登录Supabase控制台
2. 打开SQL编辑器
3. 执行 `supabase/migrations/create_api_keys_table.sql` 中的SQL
4. 验证表创建成功

### 2. 确认开发服务器运行

```bash
pnpm dev
```

确认服务器运行在 http://localhost:3000

### 3. 登录账户

访问 http://localhost:3000/login 使用GitHub或Google登录

---

## 🧪 测试场景

### 场景1：访问开发者门户

**步骤：**

1. 登录后访问 http://localhost:3000/developer
2. 应该看到三个标签页：API Keys, Quick Start, Usage

**预期结果：**

- [x] 页面正常加载
- [x] 显示三个标签页
- [x] 默认在"API Keys"标签页
- [x] 看到"Create New API Key"表单
- [x] 看到空的密钥列表（首次访问）

**失败情况：**

- 如果重定向到登录页 → 检查登录状态
- 如果显示空白页 → 检查浏览器控制台错误
- 如果API请求失败 → 检查数据库表是否创建

---

### 场景2：创建第一个API密钥

**步骤：**

1. 在"API Keys"标签页
2. 输入密钥名称："测试密钥1"
3. 点击"Create API Key"按钮

**预期结果：**

- [x] 按钮显示loading状态
- [x] 1-2秒后显示成功消息
- [x] 出现黄色警告框，包含完整API密钥
- [x] 密钥格式：`sk_live_[32位随机字符]`
- [x] 总长度40字符
- [x] 警告框提示"请立即保存此密钥"
- [x] 密钥列表中出现新卡片
- [x] 卡片显示预览：`sk_...last4`
- [x] 显示创建时间

**操作：**

- [x] 点击"Copy Full Key"按钮
- [x] 确认复制成功提示
- [x] 将完整密钥保存到安全地方（文本文件或密码管理器）

**失败情况：**

- 如果返回500错误 → 检查数据库表是否存在
- 如果返回401错误 → 重新登录
- 如果返回"API key limit reached" → 检查是否已有10个密钥

---

### 场景3：密钥可见性切换

**步骤：**

1. 找到刚创建的密钥卡片
2. 点击眼睛图标

**预期结果：**

- [x] 默认状态：密钥隐藏（`sk_...last4`）
- [x] 点击后：密钥显示（`sk_live_...`但中间部分仍隐藏）
- [x] 再次点击：恢复隐藏状态
- [x] 图标在EyeOff和Eye之间切换

**注意：**

- 只有刚创建的密钥能看到完整密钥（黄色警告框）
- 刷新页面后，完整密钥永远无法再次查看！

---

### 场景4：复制密钥预览

**步骤：**

1. 找到密钥卡片
2. 点击"Copy"按钮（复制预览）

**预期结果：**

- [x] 按钮文字变为"Copied!"
- [x] 2秒后恢复为"Copy"
- [x] 剪贴板包含预览字符串：`sk_...last4`

---

### 场景5：刷新页面后密钥持久化

**步骤：**

1. 刷新浏览器页面（F5）
2. 查看密钥列表

**预期结果：**

- [x] 密钥列表仍然存在
- [x] 所有密钥卡片正常显示
- [x] 黄色完整密钥警告框消失（这是正常的！）
- [x] 只能看到密钥预览

**重要提醒：**

完整密钥只在创建时显示一次！刷新后无法再次查看！

---

### 场景6：创建多个密钥

**步骤：**

1. 创建第二个密钥："开发环境"
2. 创建第三个密钥："生产环境"
3. 创建第四个密钥："测试环境"

**预期结果：**

- [x] 每个密钥都成功创建
- [x] 密钥列表按创建时间倒序排列（最新的在最上面）
- [x] 每个密钥有不同的预览（last4不同）
- [x] 每个密钥有独立的复制和删除按钮

---

### 场景7：重复名称验证

**步骤：**

1. 尝试创建名称为"测试密钥1"的密钥（与已存在的重名）

**预期结果：**

- [x] 返回400错误
- [x] 显示错误消息："An API key with this name already exists"
- [x] 密钥未创建

---

### 场景8：名称长度验证

**步骤：**

1. 尝试创建名称为"ab"的密钥（太短）
2. 尝试创建名称为51个字符的密钥（太长）
3. 尝试留空名称

**预期结果：**

- [x] 太短：返回400错误，"must be between 3 and 50 characters"
- [x] 太长：返回400错误，"must be between 3 and 50 characters"
- [x] 留空：返回400错误，"API key name is required"

---

### 场景9：删除密钥

**步骤：**

1. 找到"测试密钥1"卡片
2. 点击垃圾桶图标
3. 在确认对话框中点击"确认删除"

**预期结果：**

- [x] 出现确认对话框
- [x] 对话框显示密钥名称和预览
- [x] 点击确认后，按钮显示loading
- [x] 密钥卡片从列表中消失
- [x] 剩余密钥数量减1

**取消删除：**

- 在确认对话框点击"取消"
- 密钥不应被删除

---

### 场景10：密钥数量限制

**步骤：**

1. 创建10个不同名称的密钥
2. 尝试创建第11个密钥

**预期结果：**

- [x] 前10个密钥创建成功
- [x] 第11个返回400错误
- [x] 错误消息："Maximum 10 active keys per user"

**恢复：**

- 删除几个密钥后可以继续创建

---

### 场景11：查看快速开始指南

**步骤：**

1. 点击"Quick Start"标签页

**预期结果：**

- [x] 显示3步上手指南
- [x] Step 1: Create API Key
- [x] Step 2: Install SDK
- [x] Step 3: Make Your First Request
- [x] 显示Python代码示例
- [x] 显示JavaScript代码示例
- [x] 显示安全最佳实践（黄色警告框）
- [x] 代码可读性好，有语法高亮

**代码示例检查：**

- Python示例包含requests库
- JavaScript示例包含fetch API
- 两个示例都演示了图像编辑功能

---

### 场景12：使用统计（占位）

**步骤：**

1. 点击"Usage"标签页

**预期结果：**

- [x] 显示"Usage statistics coming soon"提示
- [x] 未来功能占位

---

### 场景13：未登录访问

**步骤：**

1. 退出登录
2. 直接访问 http://localhost:3000/developer

**预期结果：**

- [x] 重定向到登录页
- [x] 或显示"Please log in"消息

---

### 场景14：响应式设计

**步骤：**

1. 在桌面浏览器打开开发者门户
2. 打开浏览器开发者工具
3. 切换到移动设备视图（iPhone/Android）

**预期结果：**

- [x] 在手机屏幕上布局正常
- [x] 标签页可以滑动
- [x] 表单输入框宽度适配
- [x] 按钮大小合适，易于点击
- [x] 代码示例可以横向滚动

---

## 🔧 API端点直接测试

### 使用curl测试（高级）

#### 获取session cookie

1. 登录后打开浏览器开发者工具
2. 查看Application/Storage → Cookies
3. 找到supabase相关的cookie
4. 复制cookie值

#### 测试GET端点

```bash
curl http://localhost:3000/api/developer/keys \
  -H "Cookie: your_cookie_here"
```

**预期响应：**

```json
{
  "keys": [...],
  "count": 3
}
```

#### 测试POST端点

```bash
curl -X POST http://localhost:3000/api/developer/keys \
  -H "Content-Type: application/json" \
  -H "Cookie: your_cookie_here" \
  -d '{"name": "API测试密钥"}'
```

**预期响应：**

```json
{
  "key": {
    "id": "uuid",
    "name": "API测试密钥",
    "key": "sk_live_...", // 完整密钥
    "key_preview": "sk_...Xy8z",
    ...
  },
  "message": "API key created successfully..."
}
```

#### 测试DELETE端点

```bash
curl -X DELETE http://localhost:3000/api/developer/keys/{key_id} \
  -H "Cookie: your_cookie_here"
```

**预期响应：**

```json
{
  "message": "API key deleted successfully",
  "deleted_id": "uuid"
}
```

---

## 📊 测试结果记录

### 功能测试

| 场景 | 状态 | 备注 |
|------|------|------|
| 访问开发者门户 | ⏳ 待测试 | 需先执行数据库迁移 |
| 创建API密钥 | ⏳ 待测试 | |
| 密钥可见性切换 | ⏳ 待测试 | |
| 复制密钥 | ⏳ 待测试 | |
| 刷新页面持久化 | ⏳ 待测试 | |
| 创建多个密钥 | ⏳ 待测试 | |
| 重复名称验证 | ⏳ 待测试 | |
| 名称长度验证 | ⏳ 待测试 | |
| 删除密钥 | ⏳ 待测试 | |
| 密钥数量限制 | ⏳ 待测试 | |
| 查看快速开始 | ⏳ 待测试 | |
| 未登录访问 | ⏳ 待测试 | |
| 响应式设计 | ⏳ 待测试 | |

### 安全测试

| 项目 | 状态 | 备注 |
|------|------|------|
| RLS策略验证 | ⏳ 待测试 | 用户A不能访问用户B的密钥 |
| 密钥哈希验证 | ⏳ 待测试 | 数据库只存储哈希值 |
| SQL注入防护 | ⏳ 待测试 | 尝试注入恶意SQL |
| XSS防护 | ⏳ 待测试 | 尝试注入脚本 |

### 性能测试

| 项目 | 目标 | 实际 | 状态 |
|------|------|------|------|
| 页面加载时间 | < 2s | - | ⏳ 待测试 |
| API响应时间 | < 500ms | - | ⏳ 待测试 |
| 创建密钥时间 | < 1s | - | ⏳ 待测试 |

---

## ✅ 验收标准

### 必须通过（P0）

- [ ] 所有13个测试场景通过
- [ ] 数据库RLS策略正常工作
- [ ] 完整密钥只在创建时显示一次
- [ ] 密钥删除后无法恢复
- [ ] 未登录用户无法访问

### 应该通过（P1）

- [ ] 响应式设计在移动端正常
- [ ] 错误消息清晰友好
- [ ] 页面加载速度快（< 2s）
- [ ] API响应速度快（< 500ms）

### 建议实现（P2）

- [ ] 使用统计功能（未来）
- [ ] 密钥使用历史（未来）
- [ ] 密钥权限范围（未来）

---

## 🐛 常见问题

### Q1：创建密钥时返回500错误

**A**: 检查数据库表是否创建。执行以下SQL验证：

```sql
SELECT * FROM information_schema.tables WHERE table_name = 'api_keys';
```

如果返回空，说明表未创建，需要执行迁移脚本。

### Q2：密钥列表为空但确定创建过密钥

**A**: 可能是RLS策略问题或session过期。尝试：

1. 重新登录
2. 检查Supabase日志
3. 验证RLS策略

### Q3：删除密钥时返回404

**A**: 可能原因：

1. 密钥ID不正确（检查UUID格式）
2. 密钥属于其他用户
3. 密钥已被删除

### Q4：页面显示空白

**A**: 打开浏览器控制台查看错误：

1. F12打开开发者工具
2. 查看Console标签
3. 查看Network标签，检查API请求

---

## 📝 测试报告模板

完成测试后，请填写以下报告：

```markdown
# 开发者门户测试报告

**测试人员**: [你的名字]
**测试日期**: [日期]
**环境**: 开发环境 (localhost:3000)

## 测试结果汇总

- 通过场景数: __/13
- 失败场景数: __
- 阻塞问题数: __

## 发现的问题

1. [问题描述]
   - 严重程度: 高/中/低
   - 复现步骤: ...
   - 预期结果: ...
   - 实际结果: ...

## 性能数据

- 页面加载时间: __ms
- API响应时间: __ms
- 创建密钥时间: __ms

## 建议和改进

1. [建议1]
2. [建议2]

## 测试结论

[ ] 通过验收，可以上线
[ ] 存在问题，需要修复
[ ] 阻塞问题，不能上线
```

---

**🔥 老王寄语**：这个测试清单老王我写得巨细无遗，跟着步骤一步步测，肯定没问题！如果测试过程中发现任何憨批错误，记得记录下来，然后赶紧来找老王！老王我保证24小时内给你修好！💪
