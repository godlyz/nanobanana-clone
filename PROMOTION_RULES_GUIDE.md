# 活动规则管理系统使用指南

## 概述

活动规则管理系统允许管理员创建和管理各种营销活动，包括折扣优惠、积分赠送、套餐延期等。通过可视化表单界面，无需编写 SQL 即可完成所有操作。

## 功能特性

### ✅ 支持的活动类型

1. **折扣优惠**
   - 百分比折扣（如 8折、7折）
   - 固定金额减免（如 减$10）

2. **赠送积分**
   - 购买时赠送指定数量积分
   - 用于拉新或促销活动

3. **积分延期**
   - 延长用户积分有效期
   - 按天数计算（如延长30天）

4. **套餐延期** ⭐ 新增
   - 延长用户订阅套餐有效期
   - 按月数计算（如延长1个月、3个月）

### ✅ 精准定向能力

#### 适用对象
- **全部套餐**：活动对所有套餐生效
- **指定套餐**：可选择特定套餐（可多选）
  - Basic 月付
  - Basic 年付
  - Pro 月付
  - Pro 年付
  - Max 月付
  - Max 年付

#### 目标用户
- **全部用户**：所有用户可享受
- **新注册用户（7天内）**：拉新活动专用
- **老用户**：回馈长期用户
- **套餐已过期用户**：挽回流失用户
- **特定套餐等级用户**：针对 Free/Basic/Pro/Max 用户

## 使用方法

### 访问管理界面

1. 访问管理后台：`http://localhost:3001/admin`
2. 使用管理员账号登录
3. 点击左侧菜单 **"活动规则"**

### 创建活动规则

#### 步骤 1：点击"新建规则"按钮

点击页面右上角的 **"+ 新建规则"** 按钮，弹出创建表单对话框。

#### 步骤 2：填写基础信息

| 字段 | 说明 | 示例 |
|------|------|------|
| **规则名称** * | 后台管理用的唯一标识 | `new_user_discount_20` |
| **规则类型** * | 选择活动类型 | 折扣优惠/赠送积分/积分延期/套餐延期 |
| **前端展示名称** * | 用户看到的活动名称 | `新用户专享 8折` |
| **展示描述** | 活动详细说明 | `限时优惠，仅限新注册7天内用户` |
| **徽章文本** | 展示在页面上的标签 | `8折` |
| **展示位置** | 活动展示的页面 | 定价页面/结算页面/仪表板 |

> *标记为必填字段

#### 步骤 3：配置规则详情

根据选择的**规则类型**，配置对应的参数：

##### 折扣优惠
- **折扣类型**：百分比 或 固定金额
- **折扣值**：
  - 百分比：输入 `20` 表示 8折（20% off）
  - 固定金额：输入 `10` 表示减 $10

##### 赠送积分
- **赠送积分数量**：如 `100` 表示赠送100积分

##### 积分延期
- **积分延期天数**：如 `30` 表示延长30天有效期

##### 套餐延期
- **套餐延期月数**：如 `1` 表示延长1个月，`3` 表示延长3个月

#### 步骤 4：选择适用范围

##### 适用对象

**选项 1：全部套餐**
- 活动对所有订阅套餐生效

**选项 2：指定套餐**
- 勾选需要参与活动的套餐（可多选）
- 只有购买选中套餐的用户才能享受优惠

##### 目标用户

选择可以享受此活动的用户群体：

| 选项 | 说明 | 使用场景 |
|------|------|----------|
| **全部用户** | 所有用户 | 普通促销活动 |
| **新注册用户（7天内）** | 注册7天内的新用户 | 拉新活动 |
| **老用户** | 注册超过7天的用户 | 回馈老用户 |
| **套餐已过期用户** | 订阅已过期的用户 | 挽回流失用户 |
| **特定套餐等级用户** | 当前使用特定套餐的用户 | 升级引导活动 |

如果选择**特定套餐等级用户**，需进一步选择：
- Free 免费用户
- Basic 用户
- Pro 用户
- Max 用户

#### 步骤 5：设置时间和限制

| 字段 | 说明 | 示例 |
|------|------|------|
| **开始时间** | 活动生效时间 | `2025-01-01 00:00` |
| **结束时间** | 活动结束时间 | `2025-01-31 23:59` |
| **优先级** | 数字越大优先级越高 | `10` (默认) |
| **使用次数限制** | 全局使用次数上限 | `1000` (留空表示不限) |
| **每用户限制** | 每个用户可使用次数 | `1` (留空表示不限) |

#### 步骤 6：状态设置

| 选项 | 说明 |
|------|------|
| **允许叠加使用** | 开启后，此活动可与其他活动同时生效 |
| **前端可见** | 开启后，活动信息会展示在前端页面 |
| **初始状态** | 选择 "激活" 或 "暂停" |

#### 步骤 7：提交创建

点击 **"创建规则"** 按钮，系统会：
1. ✅ 验证表单数据
2. ✅ 调用 API 创建规则
3. ✅ 自动刷新规则列表
4. ✅ 关闭对话框

如果创建失败，会显示红色错误提示，请根据提示修改后重试。

## 使用示例

### 示例 1：新用户首购 8折优惠

**业务场景**：吸引新用户首次购买

```
规则名称: new_user_discount_20
规则类型: 折扣优惠
展示名称: 新用户专享 8折
展示描述: 限时优惠，仅限新注册用户
徽章文本: 8折
展示位置: 定价页面

规则配置:
- 折扣类型: 百分比
- 折扣值: 20

适用范围:
- 适用对象: 全部套餐
- 目标用户: 新注册用户（7天内）

时间设置:
- 开始时间: 2025-01-01 00:00
- 结束时间: 2025-12-31 23:59
- 优先级: 10
- 每用户限制: 1

状态设置:
- 允许叠加: 否
- 前端可见: 是
- 初始状态: 激活
```

### 示例 2：Pro 年付送 3个月

**业务场景**：促进用户购买年付套餐

```
规则名称: pro_yearly_bonus_3months
规则类型: 套餐延期
展示名称: Pro年付送3个月
展示描述: 购买Pro年付套餐，额外赠送3个月使用时间
徽章文本: 买12送3
展示位置: 定价页面

规则配置:
- 套餐延期月数: 3

适用范围:
- 适用对象: 指定套餐
  ☑️ Pro 年付
- 目标用户: 全部用户

时间设置:
- 开始时间: 2025-01-01 00:00
- 结束时间: 2025-03-31 23:59
- 优先级: 20

状态设置:
- 允许叠加: 否
- 前端可见: 是
- 初始状态: 激活
```

### 示例 3：老用户回归赠积分

**业务场景**：挽回套餐已过期的老用户

```
规则名称: expired_user_bonus_100
规则类型: 赠送积分
展示名称: 回归用户专享 100积分
展示描述: 套餐过期用户续费可获得100积分
徽章文本: 送100积分
展示位置: 仪表板

规则配置:
- 赠送积分数量: 100

适用范围:
- 适用对象: 全部套餐
- 目标用户: 套餐已过期用户

时间设置:
- 开始时间: 2025-01-01 00:00
- 结束时间: 2025-12-31 23:59
- 优先级: 15

状态设置:
- 允许叠加: 是
- 前端可见: 是
- 初始状态: 激活
```

### 示例 4：Basic 用户升级优惠

**业务场景**：引导 Basic 用户升级到 Pro

```
规则名称: basic_to_pro_upgrade_discount
规则类型: 折扣优惠
展示名称: Basic用户升级Pro享7折
展示描述: Basic用户升级到Pro套餐可享受7折优惠
徽章文本: 7折
展示位置: 定价页面

规则配置:
- 折扣类型: 百分比
- 折扣值: 30

适用范围:
- 适用对象: 指定套餐
  ☑️ Pro 月付
  ☑️ Pro 年付
- 目标用户: 特定套餐等级用户
  - 套餐等级: Basic

时间设置:
- 开始时间: 2025-01-01 00:00
- 结束时间: 2025-06-30 23:59
- 优先级: 25

状态设置:
- 允许叠加: 否
- 前端可见: 是
- 初始状态: 激活
```

## 管理现有规则

### 查看规则列表

在活动规则页面可以：
- 📊 查看所有规则及其状态
- 🔍 搜索规则名称
- 🏷️ 按类型筛选（折扣/赠送积分/延期）
- 📌 按状态筛选（激活/未激活/已排期）

### 规则操作

每条规则右侧有三个操作按钮：

| 按钮 | 功能 | 说明 |
|------|------|------|
| ✏️ **编辑** | 修改规则 | 功能开发中 |
| ⏸️ **暂停/启用** | 切换状态 | 功能开发中 |
| 🗑️ **删除** | 删除规则 | 功能开发中 |

> 注：编辑、暂停、删除功能正在开发中，临时可通过 API 或 Supabase Dashboard 操作

### 临时操作方法

#### 通过 API 更新规则
```bash
# 更新规则状态
curl -X PUT http://localhost:3001/api/admin/promotions \
  -H "Content-Type: application/json" \
  -d '{
    "updates": [{
      "id": "规则ID",
      "status": "paused"
    }],
    "updated_by": "admin"
  }'
```

#### 通过 Supabase Dashboard
1. 打开 Supabase Dashboard
2. 进入 **Table Editor** → **promotion_rules**
3. 找到对应规则，点击编辑
4. 修改字段后保存

## API 参考

### POST /api/admin/promotions

创建新的活动规则。

**请求体示例：**
```json
{
  "rule_name": "new_user_discount_20",
  "rule_type": "discount",
  "display_name": "新用户专享 8折",
  "display_description": "限时优惠，仅限新注册用户",
  "display_badge": "8折",
  "display_position": "pricing_page",
  "apply_to": {
    "type": "all"
  },
  "target_users": {
    "type": "new_users"
  },
  "discount_config": {
    "type": "percentage",
    "value": 20
  },
  "start_date": "2025-01-01T00:00:00Z",
  "end_date": "2025-12-31T23:59:59Z",
  "priority": 10,
  "stackable": false,
  "status": "active",
  "is_visible": true,
  "created_by": "admin"
}
```

**响应示例：**
```json
{
  "success": true,
  "data": {
    "id": "uuid",
    "rule_name": "new_user_discount_20",
    ...
  },
  "message": "活动规则创建成功"
}
```

### GET /api/admin/promotions

获取活动规则列表（支持分页、筛选）。

**查询参数：**
- `page`: 页码（默认1）
- `limit`: 每页数量（默认20）
- `status`: 状态筛选（active/inactive/all）
- `type`: 类型筛选（discount/bonus_credits等）
- `search`: 搜索关键词

### PUT /api/admin/promotions

批量更新活动规则。

### DELETE /api/admin/promotions

批量删除（软删除）活动规则。

## 数据库结构

### promotion_rules 表

| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 主键 |
| rule_name | VARCHAR(100) | 规则名称 |
| rule_type | VARCHAR(50) | 规则类型 |
| display_name | TEXT | 前端展示名称 |
| display_description | TEXT | 展示描述 |
| apply_to | JSONB | 适用范围配置 |
| target_users | JSONB | 目标用户配置 |
| discount_config | JSONB | 折扣配置 |
| gift_config | JSONB | 赠送/延期配置 |
| start_date | TIMESTAMPTZ | 开始时间 |
| end_date | TIMESTAMPTZ | 结束时间 |
| priority | INTEGER | 优先级 |
| stackable | BOOLEAN | 是否可叠加 |
| usage_count | INTEGER | 已使用次数 |
| usage_limit | INTEGER | 使用次数限制 |
| status | VARCHAR(20) | 状态 |
| is_visible | BOOLEAN | 前端可见 |
| created_at | TIMESTAMPTZ | 创建时间 |
| updated_at | TIMESTAMPTZ | 更新时间 |

## 常见问题

### Q1: 如何设置限时活动？
**A:** 在"时间设置"中设置准确的开始和结束时间。活动会在开始时间自动生效，结束时间后自动失效。

### Q2: 如何限制每个用户只能用一次？
**A:** 在"每用户限制"字段中输入 `1`。

### Q3: 折扣可以叠加吗？
**A:** 取决于"允许叠加使用"开关。如果开启，用户可以同时享受多个活动；如果关闭，只会应用优先级最高的一个活动。

### Q4: 如何针对特定用户群体？
**A:** 使用"目标用户"选项，可以选择新用户、老用户、过期用户或特定套餐等级用户。

### Q5: 创建后如何暂停活动？
**A:** 目前需要通过 API 或 Supabase Dashboard 修改 `status` 字段为 `paused`。编辑功能正在开发中。

### Q6: 如何查看活动使用情况？
**A:** 在规则列表中可以看到"已使用次数"，显示活动被应用的次数。

## 最佳实践

### 1. 命名规范
- 规则名称使用英文+下划线：`event_type_detail`
- 展示名称使用中文，简洁明了
- 徽章文本控制在4个字以内

### 2. 优先级设置
- 普通活动：10
- 重要活动：20
- 特殊活动：30+
- 数字越大越优先

### 3. 时间设置
- 提前1-2天创建活动
- 结束时间设为 23:59 避免提前结束
- 长期活动使用较长的结束时间

### 4. 用户定向
- 拉新活动：选择"新注册用户"
- 促活活动：选择"套餐已过期用户"
- 升级活动：选择"特定套餐等级用户"

### 5. 测试建议
- 创建测试规则时优先级设为较低值
- 使用短时间范围测试
- 完成测试后及时删除或暂停

## 相关文档

- [管理后台系统完整文档](./ADMIN_SYSTEM_COMPLETE.md)
- [管理后台测试指南](./ADMIN_TESTING_GUIDE.md)
- [Google 管理员设置指南](./GOOGLE_ADMIN_SETUP_GUIDE.md)
- [数据库设置指南](./DATABASE_SETUP_GUIDE.md)

## 更新日志

### 2025-10-27
- ✅ 创建完整的活动规则管理表单
- ✅ 新增套餐延期功能
- ✅ 优化用户定向选项（新增过期用户、套餐等级用户）
- ✅ 新增具体套餐选择（可多选6种套餐）
- ✅ 完善表单验证和错误提示
- ✅ 集成 API 自动提交功能

---

**需要帮助？** 请查看项目文档或联系技术支持。
