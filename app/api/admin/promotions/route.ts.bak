/**
 * ğŸ”¥ è€ç‹çš„æ´»åŠ¨è§„åˆ™ç®¡ç† API
 * ç”¨é€”: ç®¡ç†è¥é”€æ´»åŠ¨è§„åˆ™çš„å¢åˆ æ”¹æŸ¥æ“ä½œ
 * è€ç‹è­¦å‘Š: è¿™ä¸ªAPIè¦æ˜¯è¢«æ¶æ„åˆ©ç”¨ï¼Œæ•´ä¸ªè¥é”€ä½“ç³»éƒ½è¦ä¹±å¥—ï¼
 */

import { NextRequest, NextResponse } from 'next/server'
import { createServiceClient } from '@/lib/supabase/service'
import { promotionRuleCache } from '@/lib/promotion-rule-cache'
import { withRBAC, AdminAction, logAdminAction } from '@/lib/admin-auth'
import { promotionEngine } from '@/lib/promotion-engine'

// æ´»åŠ¨è§„åˆ™ç±»å‹å®šä¹‰
interface PromotionRule {
  rule_name: string
  rule_type: 'discount' | 'bonus_credits' | 'credits_extension' | 'subscription_extension' | 'trial_extension' | 'free_package'
  priority?: number
  stackable?: boolean
  discount_config?: {
    type: 'percentage' | 'fixed'
    value: number
    min_price?: number
    max_discount?: number
  }
  gift_config?: {
    type: 'bonus_credits' | 'credits_extension' | 'subscription_extension' | 'trial_extension' | 'free_package'
    amount?: number
    extend_days?: number
    extend_months?: number
    description?: string
  }
  usage_limit?: number
  apply_to: {
    type: 'all' | 'subscriptions' | 'packages'
    tiers?: string[]
    package_ids?: string[]
    min_price?: number
  }
  target_users: {
    type: 'all' | 'new_users' | 'vip_users' | 'specific_users'
    user_ids?: string[]
    emails?: string[]
  }
  start_date: string
  end_date: string
  display_name?: string
  display_description?: string
  display_badge?: string
  display_position?: 'pricing_page' | 'checkout' | 'dashboard' | 'all'
  is_visible?: boolean
  created_by?: string
  updated_by?: string
}

/**
 * ğŸ”¥ è·å–æ´»åŠ¨è§„åˆ™åˆ—è¡¨ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
 */
async function handleGET(req: NextRequest) {
  try {
    console.log('ğŸ“‹ è·å–æ´»åŠ¨è§„åˆ™åˆ—è¡¨')

    // è·å–æŸ¥è¯¢å‚æ•°
    const { searchParams } = new URL(req.url)
    const status = searchParams.get('status')
    const type = searchParams.get('type')
    const active = searchParams.get('active') // 'true', 'false', 'all'
    const page = parseInt(searchParams.get('page') || '1')
    const limit = parseInt(searchParams.get('limit') || '20')
    const search = searchParams.get('search')

    // å°è¯•ä»ç¼“å­˜è·å–æ´»åŠ¨è§„åˆ™ï¼Œå¦‚æœå¤±è´¥åˆ™ç›´æ¥ä»æ•°æ®åº“è·å–
    let allRules: any[] = []
    
    try {
      // ä½¿ç”¨ Promise.race è®¾ç½®3ç§’è¶…æ—¶
      const timeout = new Promise((_, reject) => 
        setTimeout(() => reject(new Error('è·å–è§„åˆ™è¶…æ—¶')), 3000)
      )
      const rulesPromise = promotionRuleCache.getActiveRules()
      allRules = await Promise.race([rulesPromise, timeout]) as any[]
    } catch (cacheError) {
      console.warn('âš ï¸ ç¼“å­˜è·å–å¤±è´¥ï¼Œä»æ•°æ®åº“ç›´æ¥è¯»å–:', cacheError)
      // ç¼“å­˜å¤±è´¥æ—¶ä»æ•°æ®åº“ç›´æ¥è·å–
      const supabase = createServiceClient()
      const { data: dbRules } = await supabase
        .from('promotion_rules')
        .select('*')
        .eq('status', 'active')
        .order('priority', { ascending: false })
      
      allRules = dbRules || []
    }

    // ğŸ”¥ è€ç‹ä¿®å¤ï¼šç¡®ä¿ allRules æ˜¯æ•°ç»„ç±»å‹
    if (!Array.isArray(allRules)) {
      console.warn('âš ï¸ ç¼“å­˜è¿”å›çš„ä¸æ˜¯æ•°ç»„ï¼Œè½¬æ¢ä¸ºç©ºæ•°ç»„:', typeof allRules)
      allRules = []
    }

    // å¦‚æœéœ€è¦è·å–éæ´»è·ƒè§„åˆ™ï¼Œéœ€è¦ä»æ•°æ®åº“æŸ¥è¯¢
    if (active === 'false' || status === 'inactive') {
      console.log('ğŸ“¡ ä»æ•°æ®åº“è·å–éæ´»è·ƒè§„åˆ™')
      const supabase = createServiceClient()
      const { data: inactiveRules } = await supabase
        .from('promotion_rules')
        .select('*')
        .eq('status', 'inactive')
        .order('created_at', { ascending: false })

      if (inactiveRules) {
        allRules = [...allRules, ...inactiveRules]
      }
    }

    // è¿‡æ»¤è§„åˆ™
    let filteredRules = allRules

    // æŒ‰çŠ¶æ€è¿‡æ»¤
    if (status && status !== 'all') {
      filteredRules = filteredRules.filter(rule => rule.status === status)
    }

    // æŒ‰ç±»å‹è¿‡æ»¤
    if (type && type !== 'all') {
      filteredRules = filteredRules.filter(rule => rule.rule_type === type)
    }

    // æŒ‰æ´»è·ƒçŠ¶æ€è¿‡æ»¤
    if (active === 'true') {
      filteredRules = filteredRules.filter(rule => rule.status === 'active')
    } else if (active === 'false') {
      filteredRules = filteredRules.filter(rule => rule.status === 'inactive')
    }

    // æœç´¢è¿‡æ»¤
    if (search) {
      const searchTerm = search.toLowerCase()
      filteredRules = filteredRules.filter(rule =>
        rule.rule_name.toLowerCase().includes(searchTerm) ||
        (rule.display_name && rule.display_name.toLowerCase().includes(searchTerm)) ||
        (rule.display_description && rule.display_description.toLowerCase().includes(searchTerm))
      )
    }

    // æ’åºï¼ˆæŒ‰ä¼˜å…ˆçº§å’Œåˆ›å»ºæ—¶é—´ï¼‰
    filteredRules.sort((a, b) => {
      if (b.priority !== a.priority) {
        return b.priority - a.priority
      }
      return new Date(b.created_at).getTime() - new Date(a.created_at).getTime()
    })

    // åˆ†é¡µ
    const total = filteredRules.length
    const startIndex = (page - 1) * limit
    const endIndex = startIndex + limit
    const paginatedRules = filteredRules.slice(startIndex, endIndex)

    // æ ¼å¼åŒ–å“åº”æ•°æ®
    const formattedRules = paginatedRules.map(rule => ({
      id: rule.id,
      rule_name: rule.rule_name,
      rule_type: rule.rule_type,
      priority: rule.priority,
      stackable: rule.stackable,
      discount_config: rule.discount_config,
      gift_config: rule.gift_config,
      usage_count: rule.usage_count,
      usage_limit: rule.usage_limit,
      status: rule.status,
      apply_to: rule.apply_to,
      target_users: rule.target_users,
      start_date: rule.start_date,
      end_date: rule.end_date,
      display_name: rule.display_name,
      display_description: rule.display_description,
      display_badge: rule.display_badge,
      display_position: rule.display_position,
      is_visible: rule.is_visible,
      created_at: rule.created_at,
      updated_at: rule.updated_at,
      created_by: rule.created_by,
      updated_by: rule.updated_by
    }))

    return NextResponse.json({
      success: true,
      data: formattedRules,
      pagination: {
        page,
        limit,
        total,
        totalPages: Math.ceil(total / limit),
        hasNext: endIndex < total,
        hasPrev: page > 1
      },
      message: `è·å–åˆ° ${formattedRules.length} ä¸ªæ´»åŠ¨è§„åˆ™`
    })

  } catch (error) {
    console.error('âŒ è·å–æ´»åŠ¨è§„åˆ™åˆ—è¡¨å¤±è´¥:', error)
    return NextResponse.json({
      success: false,
      error: 'è·å–æ´»åŠ¨è§„åˆ™åˆ—è¡¨å¤±è´¥',
      message: error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯'
    }, { status: 500 })
  }
}

/**
 * ğŸ”¥ åˆ›å»ºæ–°çš„æ´»åŠ¨è§„åˆ™
 */
async function handlePOST(req: NextRequest) {
  try {
    console.log('â• åˆ›å»ºæ–°çš„æ´»åŠ¨è§„åˆ™')

    const body = await req.json()
    const {
      rule_name,
      rule_type,
      priority = 10,
      stackable = true,
      discount_config,
      gift_config,
      usage_limit,
      apply_to,
      target_users,
      start_date,
      end_date,
      display_name,
      display_description,
      display_badge,
      display_position = 'pricing_page',
      is_visible = true,
      created_by
    } = body as PromotionRule

    // éªŒè¯å¿…éœ€å­—æ®µ
    if (!rule_name || !rule_type || !apply_to || !target_users || !start_date || !end_date) {
      return NextResponse.json({
        success: false,
        error: 'ç¼ºå°‘å¿…éœ€å­—æ®µ',
        message: 'rule_name, rule_type, apply_to, target_users, start_date, end_date æ˜¯å¿…éœ€çš„'
      }, { status: 400 })
    }

    // éªŒè¯è§„åˆ™ç±»å‹
    const validTypes = ['discount', 'bonus_credits', 'credits_extension', 'subscription_extension', 'trial_extension', 'free_package']
    if (!validTypes.includes(rule_type)) {
      return NextResponse.json({
        success: false,
        error: 'æ— æ•ˆçš„è§„åˆ™ç±»å‹',
        message: `è§„åˆ™ç±»å‹å¿…é¡»æ˜¯: ${validTypes.join(', ')}`
      }, { status: 400 })
    }

    // éªŒè¯æŠ˜æ‰£é…ç½®
    if (rule_type === 'discount' && (!discount_config || !discount_config.type || !discount_config.value)) {
      return NextResponse.json({
        success: false,
        error: 'æŠ˜æ‰£è§„åˆ™å¿…é¡»æä¾› discount_config',
        message: 'discount_config åŒ…å« type å’Œ value å­—æ®µ'
      }, { status: 400 })
    }

    // éªŒè¯èµ é€é…ç½®
    if (rule_type !== 'discount' && (!gift_config || !gift_config.type)) {
      return NextResponse.json({
        success: false,
        error: 'éæŠ˜æ‰£è§„åˆ™å¿…é¡»æä¾› gift_config',
        message: 'gift_config åŒ…å« type å­—æ®µ'
      }, { status: 400 })
    }

    // éªŒè¯æ—¥æœŸæ ¼å¼
    const startDate = new Date(start_date)
    const endDate = new Date(end_date)
    if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
      return NextResponse.json({
        success: false,
        error: 'æ— æ•ˆçš„æ—¥æœŸæ ¼å¼',
        message: 'start_date å’Œ end_date å¿…é¡»æ˜¯æœ‰æ•ˆçš„ ISO æ—¥æœŸå­—ç¬¦ä¸²'
      }, { status: 400 })
    }

    if (endDate <= startDate) {
      return NextResponse.json({
        success: false,
        error: 'ç»“æŸæ—¥æœŸå¿…é¡»æ™šäºå¼€ï¿½ï¿½æ—¥æœŸ',
        message: 'end_date å¿…é¡»å¤§äº start_date'
      }, { status: 400 })
    }

    const supabase = createServiceClient()

    // åˆ›å»ºæ´»åŠ¨è§„åˆ™
    const { data: newRule, error: createError } = await supabase
      .from('promotion_rules')
      .insert({
        rule_name,
        rule_type,
        priority,
        stackable,
        discount_config,
        gift_config,
        usage_count: 0,
        usage_limit,
        status: 'active',
        apply_to,
        target_users,
        start_date: startDate.toISOString(),
        end_date: endDate.toISOString(),
        display_name,
        display_description,
        display_badge,
        display_position,
        is_visible,
        created_by: created_by || 'system',
        updated_by: created_by || 'system',
        created_at: new Date().toISOString(),
        updated_at: new Date().toISOString()
      })
      .select()
      .single()

    if (createError) {
      console.error('âŒ åˆ›å»ºæ´»åŠ¨è§„åˆ™å¤±è´¥:', createError)
      return NextResponse.json({
        success: false,
        error: 'åˆ›å»ºæ´»åŠ¨è§„åˆ™å¤±è´¥',
        message: createError.message
      }, { status: 400 })
    }

    // åˆ·æ–°ç¼“å­˜
    await promotionRuleCache.refresh()

    // è®°å½•å®¡è®¡æ—¥å¿—
    await logAdminAction({
      adminId: created_by || 'system',
      action: AdminAction.PROMOTION_WRITE,
      resourceType: 'promotion',
      resourceId: newRule.id,
      newValues: {
        rule_name,
        rule_type,
        priority,
        stackable,
        discount_config,
        gift_config,
        usage_limit,
        status: 'active'
      },
      ipAddress: req.ip,
      userAgent: req.headers.get('user-agent') || undefined
    })

    console.log(`âœ… æ´»åŠ¨è§„åˆ™åˆ›å»ºæˆåŠŸ: ${rule_name} (ID: ${newRule.id})`)

    return NextResponse.json({
      success: true,
      data: newRule,
      message: 'æ´»åŠ¨è§„åˆ™åˆ›å»ºæˆåŠŸ'
    }, { status: 201 })

  } catch (error) {
    console.error('âŒ åˆ›å»ºæ´»åŠ¨è§„åˆ™å¤±è´¥:', error)
    return NextResponse.json({
      success: false,
      error: 'åˆ›å»ºæ´»åŠ¨è§„åˆ™å¤±è´¥',
      message: error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯'
    }, { status: 500 })
  }
}

/**
 * ğŸ”¥ æ‰¹é‡æ›´æ–°æ´»åŠ¨è§„åˆ™
 */
async function handlePUT(req: NextRequest) {
  try {
    console.log('ğŸ”„ æ‰¹é‡æ›´æ–°æ´»åŠ¨è§„åˆ™')

    const body = await req.json()
    const { updates, updated_by } = body

    // éªŒè¯è¯·æ±‚æ•°æ®
    if (!Array.isArray(updates) || updates.length === 0) {
      return NextResponse.json({
        success: false,
        error: 'æ— æ•ˆçš„è¯·æ±‚æ•°æ®',
        message: 'updates å¿…é¡»æ˜¯éç©ºæ•°ç»„'
      }, { status: 400 })
    }

    const supabase = createServiceClient()
    const results = []

    // é€ä¸ªæ›´æ–°è§„åˆ™
    for (const update of updates) {
      const { id, ...updateData } = update

      if (!id) {
        console.warn('âš ï¸ è·³è¿‡æ²¡æœ‰ ID çš„æ›´æ–°é¡¹')
        continue
      }

      // è·å–åŸå§‹æ•°æ®ç”¨äºå®¡è®¡
      const { data: originalData } = await supabase
        .from('promotion_rules')
        .select('*')
        .eq('id', id)
        .single()

      const { data: updatedData, error } = await supabase
        .from('promotion_rules')
        .update({
          ...updateData,
          updated_at: new Date().toISOString(),
          updated_by: updated_by || 'system'
        })
        .eq('id', id)
        .select()
        .single()

      if (error) {
        console.error(`âŒ æ›´æ–°è§„åˆ™å¤±è´¥ (ID: ${id}):`, error)
      } else {
        results.push(updatedData)

        // è®°å½•å®¡è®¡æ—¥å¿—
        await logAdminAction({
          adminId: updated_by || 'system',
          action: AdminAction.PROMOTION_WRITE,
          resourceType: 'promotion',
          resourceId: id,
          oldValues: originalData,
          newValues: updatedData,
          ipAddress: req.ip,
          userAgent: req.headers.get('user-agent') || undefined
        })
      }
    }

    // åˆ·æ–°ç¼“å­˜
    if (results.length > 0) {
      await promotionRuleCache.refresh()
    }

    console.log(`âœ… æ‰¹é‡æ›´æ–°å®Œæˆ: ${results.length}/${updates.length} ä¸ªè§„åˆ™æ›´æ–°æˆåŠŸ`)

    return NextResponse.json({
      success: true,
      data: {
        updated: results.length,
        total: updates.length,
        results
      },
      message: `æˆåŠŸæ›´æ–° ${results.length} ä¸ªæ´»åŠ¨è§„åˆ™`
    })

  } catch (error) {
    console.error('âŒ æ‰¹é‡æ›´æ–°æ´»åŠ¨è§„åˆ™å¤±è´¥:', error)
    return NextResponse.json({
      success: false,
      error: 'æ‰¹é‡æ›´æ–°æ´»åŠ¨è§„åˆ™å¤±è´¥',
      message: error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯'
    }, { status: 500 })
  }
}

/**
 * ğŸ”¥ æ‰¹é‡åˆ é™¤æ´»åŠ¨è§„åˆ™
 */
async function handleDELETE(req: NextRequest) {
  try {
    console.log('ğŸ—‘ï¸ æ‰¹é‡åˆ é™¤æ´»åŠ¨è§„åˆ™')

    const { searchParams } = new URL(req.url)
    const ids = searchParams.get('ids')
    const updatedBy = searchParams.get('updatedBy') || 'system'

    if (!ids) {
      return NextResponse.json({
        success: false,
        error: 'ç¼ºå°‘å¿…éœ€å‚æ•°',
        message: 'è¯·åœ¨æŸ¥è¯¢å‚æ•°ä¸­æä¾› ids (é€—å·åˆ†éš”çš„ ID åˆ—è¡¨)'
      }, { status: 400 })
    }

    const idList = ids.split(',').filter(id => id.trim())
    if (idList.length === 0) {
      return NextResponse.json({
        success: false,
        error: 'æ— æ•ˆçš„ ID åˆ—è¡¨',
        message: 'ids å‚æ•°ä¸èƒ½ä¸ºç©º'
      }, { status: 400 })
    }

    const supabase = createServiceClient()
    const results = []

    // é€ä¸ªåˆ é™¤è§„åˆ™ï¼ˆè½¯åˆ é™¤ - è®¾ç½®ä¸º inactiveï¼‰
    for (const id of idList) {
      // è·å–åŸå§‹æ•°æ®ç”¨äºå®¡è®¡
      const { data: originalData } = await supabase
        .from('promotion_rules')
        .select('*')
        .eq('id', id.trim())
        .single()

      const { data: deletedData, error } = await supabase
        .from('promotion_rules')
        .update({
          status: 'inactive',
          updated_at: new Date().toISOString(),
          updated_by: updatedBy
        })
        .eq('id', id.trim())
        .select()
        .single()

      if (error) {
        console.error(`âŒ åˆ é™¤è§„åˆ™å¤±è´¥ (ID: ${id}):`, error)
      } else {
        results.push(deletedData)

        // è®°å½•å®¡è®¡æ—¥å¿—
        await logAdminAction({
          adminId: updatedBy,
          action: AdminAction.PROMOTION_DELETE,
          resourceType: 'promotion',
          resourceId: id.trim(),
          oldValues: originalData,
          newValues: { status: 'inactive' },
          ipAddress: req.ip,
          userAgent: req.headers.get('user-agent') || undefined
        })
      }
    }

    // åˆ·æ–°ç¼“å­˜
    if (results.length > 0) {
      await promotionRuleCache.refresh()
    }

    console.log(`âœ… æ‰¹é‡åˆ é™¤å®Œæˆ: ${results.length}/${idList.length} ä¸ªè§„åˆ™å·²åœç”¨`)

    return NextResponse.json({
      success: true,
      data: {
        deleted: results.length,
        total: idList.length,
        results
      },
      message: `æˆåŠŸåœç”¨ ${results.length} ä¸ªæ´»åŠ¨è§„åˆ™`
    })

  } catch (error) {
    console.error('âŒ æ‰¹é‡åˆ é™¤æ´»åŠ¨è§„åˆ™å¤±è´¥:', error)
    return NextResponse.json({
      success: false,
      error: 'æ‰¹é‡åˆ é™¤æ´»åŠ¨è§„åˆ™å¤±è´¥',
      message: error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯'
    }, { status: 500 })
  }
}

// å¯¼å‡ºå¸¦æœ‰ RBAC ä¿æŠ¤çš„å¤„ç†å™¨
export const GET = withRBAC(AdminAction.PROMOTION_READ)(handleGET)
export const POST = withRBAC(AdminAction.PROMOTION_WRITE)(handlePOST)
export const PUT = withRBAC(AdminAction.PROMOTION_WRITE)(handlePUT)
export const DELETE = withRBAC(AdminAction.PROMOTION_DELETE)(handleDELETE)