# 工作日志 - 2025-11-12

## 完成的工作

### 1. 修复冻结积分显示逻辑
**问题**: 订阅管理页面显示"冻结积分800"，应该是"777"（已消费23）

**原因**: `get_user_all_subscriptions` 函数用 `SUM(amount)` 而不是 `SUM(remaining_amount)`

**修复**: 创建迁移 `20251112000014_fix_frozen_credits_display.sql`
- 改用 `SUM(ct.remaining_amount)` 计算冻结积分
- 添加 `DROP FUNCTION IF EXISTS` 避免函数定义冲突

**验证**: ✅ 显示777分（800-23）

---

### 2. 修复积分到期显示逻辑
**问题**: 积分中心到期显示1977（2000-23），应该显示2000（冻结的777不显示）

**原因**: 旧函数把冻结包的消费也算到了非冻结包上

**修复**: 创建迁移 `20251112000016_simplify_expiry_use_remaining.sql`
- 直接使用 `remaining_amount` 字段
- 过滤条件: `remaining_amount > 0 AND NOT expired AND NOT frozen`
- 这样冻结的777自动被排除

**验证**: ✅ 只显示2000分（非冻结积分）

---

### 3. 修复冻结交易时间显示
**问题**: 虚拟冻结交易显示2025-10-26（800包创建时间），应该显示2025-11-12（升级时间）

**原因**: 代码直接用了 `pkg.created_at`

**修复**: 修改 `/app/api/credits/route.ts`
- 查询所有订阅，找到触发冻结的新订阅
- 使用新订阅的 `started_at` 作为冻结时间

**代码逻辑**:
```typescript
// 找到被冻结的订阅
const frozenSub = allSubscriptions?.find(s => s.id === frozenSubId)
// 找到触发冻结的新订阅（在被冻结订阅之后创建的）
const newSub = allSubscriptions?.find(s =>
  frozenSub && new Date(s.started_at) > new Date(frozenSub.started_at)
)
// 使用新订阅的开始时间
const freezeTime = newSub?.started_at || pkg.created_at
```

**验证**: ✅ 显示2025-11-12 11:05（升级时间）

---

### 4. 修复冻结剩余天数计算
**问题**: `remaining_days` 显示30天（距离解冻还有多少天），应该显示14天（包的剩余有效期）

**理解**:
- ❌ 错误理解：还有30天就解冻了
- ✅ 正确理解：解冻后这个包还能用14天（原有效期45天 - 已用31天 = 14天）

**修复**: 创建迁移 `20251112000017_fix_frozen_remaining_days.sql`
- 使用 `frozen_remaining_seconds` 字段（冻结时记录的包剩余有效期）
- 公式: `FLOOR(frozen_remaining_seconds / 86400)` = 14天

**验证**: ✅ 显示14天

---

### 5. 统一订阅显示格式
**需求**: 所有订阅都显示"剩余X个月未使用"，冻结订阅额外显示"冻结积分Y分，冻结剩余Z天"

**修改**: `/components/profile/subscription-management-section-v2.tsx`

**显示格式**:
- Max（激活）: "剩余0个月未使用"
- Pro（冻结）: "剩余11个月未使用，冻结积分777分，冻结剩余14天"

**代码**:
```typescript
{/* 所有订阅 */}
<span>剩余{sub.remainingMonths}个月未使用</span>

{/* 冻结订阅额外信息 */}
{sub.status === 'frozen' && (
  <>
    ，冻结积分 {sub.frozenCredits}分
    ，冻结剩余 {sub.remainingDays}天
  </>
)}
```

---

### 6. 修复未使用月数计算（最终修复）
**问题**: Max显示"剩余1个月"应为"0个月"，Pro显示"剩余12个月"应为"11个月"

**原因**: 之前算的是"距离到期还有多少月"，不是"未使用的月数"

**错误逻辑**:
- Max: 从NOW()到expires_at = 1个月 ❌
- Pro: 从frozen_until到expires_at = 12个月 ❌

**正确逻辑**: **未使用月数 = 总月数 - 已用月数**

**修复**: 创建迁移 `20251112000018_fix_remaining_months_logic.sql`

**计算公式**:
```sql
-- 总月数
CASE billing_cycle
  WHEN 'monthly' THEN 1
  WHEN 'yearly' THEN 12
END

-- 已用月数 = FLOOR((参考时间 - started_at) / 30天) + 1
-- 参考时间：冻结用frozen_until，激活用NOW()

-- 未使用月数 = 总月数 - 已用月数
```

**示例计算**:
- Max（月付，2025-11-12开始，现在11-12）:
  - 总月数: 1
  - 已用: FLOOR((NOW()-started_at)/30天) + 1 = 0 + 1 = 1
  - 未使用: 1 - 1 = **0个月** ✅

- Pro（年付，2025-10-26开始，11-12冻结）:
  - 总月数: 12
  - 已用: FLOOR((frozen_until-started_at)/30天) + 1 = FLOOR(17天/30) + 1 = 0 + 1 = 1
  - 未使用: 12 - 1 = **11个月** ✅

**验证**: ✅ 执行成功

---

## 创建的文件

### 数据库迁移
1. `supabase/migrations/20251112000014_fix_frozen_credits_display.sql` - 修复冻结积分显示
2. `supabase/migrations/20251112000016_simplify_expiry_use_remaining.sql` - 简化积分到期计算
3. `supabase/migrations/20251112000017_fix_frozen_remaining_days.sql` - 修复冻结剩余天数
4. `supabase/migrations/20251112000018_fix_remaining_months_logic.sql` - 修复未使用月数计算

### 验证脚本
1. `scripts/check-frozen-days.ts` - 验证冻结剩余天数计算
2. `scripts/apply-remaining-months-fix.ts` - 应用未使用月数修复

### 组件修改
1. `components/profile/subscription-management-section-v2.tsx` - 统一订阅显示格式

### API修改
1. `app/api/credits/route.ts` - 修复冻结交易时间显示

---

## 术语统一

- ✅ 使用"积分"而不是"金额"
- ✅ 注释简洁清晰，避免冗余

---

## 待验证事项（明天继续）

1. **前端显示验证**
   - 刷新订阅管理页面，确认显示格式正确
   - Max: "剩余0个月未使用"
   - Pro: "剩余11个月未使用，冻结积分777分，冻结剩余14天"

2. **积分中心验证**
   - 总获得: 3943分（1920+800+2000-777）
   - 可用积分: 3920分（4697-777）
   - 到期显示: 只显示2000分（不含冻结777）
   - 交易列表: 显示"-777 积分冻结"虚拟记录，时间2025-11-12 11:05

3. **边界情况测试**
   - 未来需要测试解冻逻辑
   - 测试多次升降级场景
   - 测试跨月计算准确性

---

## 技术要点总结

### 1. 冻结逻辑核心字段
- `is_frozen`: 是否冻结
- `frozen_until`: 冻结到何时
- `frozen_remaining_seconds`: 冻结时包的剩余有效期秒数
- `remaining_amount`: 包的实际剩余积分（会随消费减少）

### 2. PostgreSQL函数修改注意事项
- 不能直接修改返回类型，必须先DROP再CREATE
- 使用 `DROP FUNCTION IF EXISTS` 避免报错
- 确保 RETURNS TABLE 包含所有需要的字段

### 3. 虚拟交易记录生成
- 用于前端显示，不写入数据库
- ID格式: `frozen-{pkg.id}`
- 时间使用触发升级的新订阅的 `started_at`
- amount为负数表示冻结

### 4. 月数计算标准化
- **未使用月数 = 总月数 - 已用月数**
- 已用月数 = FLOOR((参考时间 - started_at) / 30天) + 1
- 参考时间：冻结用frozen_until，激活用NOW()

---

## 遗留问题

无

---

**工作完成状态**: ✅ 所有修复已完成并执行SQL成功

**下次工作**: 前端验证显示效果
