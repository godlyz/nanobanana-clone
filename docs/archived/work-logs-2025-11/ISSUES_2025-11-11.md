# 🔥 老王问题归档 - 2025-11-11

## 📋 问题清单

### ✅ 已解决的问题

#### 1. ✅ 恢复脚本未初始化 remaining_amount
- **问题**：restoration脚本创建的积分记录没有设置 `remaining_amount` 字段
- **影响**：可用积分显示为 1920 而不是 2697
- **根因**：SQL重构后，`get_user_available_credits()` 使用 `SUM(remaining_amount)` 而非 `SUM(amount)`
- **修复**：在脚本中添加 `remaining_amount: 777` (实际剩余)
- **状态**：✅ 已修复

#### 2. ✅ 历史时间戳未设置
- **问题**：积分记录的 `created_at` 显示当前时间，而非历史时间
- **影响**：时间显示为 2025-11-11 而不是 2025-10-26
- **根因**：未显式设置 `created_at`，PostgreSQL使用默认值
- **修复**：添加 `created_at: '2025-10-26T10:25:00.000Z'`
- **状态**：✅ 已修复

#### 3. ✅ 积分过期时间错误
- **问题**：年付积分过期时间设置为1年后，实际应该是1个月
- **影响**：积分过期时间显示为 2026-10-26，应该是 2025-11-26
- **根因**：误解了年付逻辑 - 年付是12次月充值，每次800积分有效1个月
- **修复**：改为 `expires_at: '2025-11-26T10:25:00.000Z'`
- **状态**：✅ 已修复

#### 4. ✅ remaining_amount 未扣除历史消费
- **问题**：800积分包的 `remaining_amount` 设置为 800，实际应该是 777
- **影响**：可用积分多计算了23积分
- **根因**：未应用FIFO逻辑到历史数据，23积分消费应该从800包扣除
- **修复**：改为 `remaining_amount: 777`
- **状态**：✅ 已修复

#### 5. ✅ 订阅开始/结束时间被自动修改
- **问题**：订阅时间显示 2025-10-27 到 2026-10-27，而不是 2025-10-26 到 2026-10-26
- **影响**：订阅时间晚了一天
- **根因**：自动充值cron任务触发，创建了新的积分记录并更新了订阅时间
- **修复**：在恢复脚本中显式设置 `started_at` 和 `expires_at`
- **状态**：✅ 已修复

#### 6. ✅ 自动充值任务过早触发
- **问题**：自动充值任务在 2025-10-27 02:25 触发，创建了不需要的积分记录
- **影响**：打乱了测试数据，订阅时间被修改
- **根因**：恢复脚本未设置 `next_refill_date`，migration自动设置为最新积分的 `expires_at`
- **修复**：添加 `next_refill_date: '2025-11-26T10:25:00.000Z'`
- **状态**：✅ 已修复

#### 7. ✅ 时区显示问题
- **问题**：前端显示 "2025年10月27日 02:25" 而不是 "2025年10月26日 18:25"
- **影响**：时间显示错误（晚了8小时+1天）
- **根因**：数据库存储UTC时间 18:25，前端转换为UTC+8 = 02:25 (次日)
- **修复**：改为存储UTC时间 10:25，前端显示UTC+8 = 18:25
- **状态**：✅ 已修复 (用户确认"正确了")

#### 8. ✅ 积分冻结逻辑测试成功
- **问题**：验证升级到Max monthly时，Pro yearly的777积分是否正确冻结
- **测试结果**：✅ 成功
  - 正确计算实际剩余777积分 (2697 - 1920 bonus)
  - 正确冻结777积分
  - 正确延长冻结时间至 2027-10-27 (Max monthly到期时间)
  - 正确记录 `frozen_remaining_seconds`
- **状态**：✅ 验证通过

---

### ⚠️ 待处理的问题

#### Bug #1: 订阅管理页面显示错误
**问题描述**：
- 当前显示：Max monthly 订阅，但日期不对
- 应该显示：
  1. 活跃订阅：Max monthly (开始 2025-11-11，结束 2027-10-27)
  2. 冻结订阅：Pro yearly (状态：冻结，解冻时间：2027-10-27)

**用户反馈**：
> "套餐时间下了1个月，这个时间应该显示是对应的至尊版的时间11号开始，下月结束，下面增加专业版时间，开始技术不变，状态冻结，结束时间延长了上面正尊版的时间"

**附件**：截图1（见用户提供）

**可能原因**：
1. 前端只显示活跃订阅，没有显示冻结订阅
2. 订阅API未返回冻结订阅信息
3. 前端组件未处理冻结订阅的显示逻辑

**调试步骤**：
1. 检查 `/app/api/subscription/status/route.ts` 返回的数据结构
2. 检查订阅管理页面组件
3. 验证数据库中是否有正确的订阅记录（活跃 + 历史）

**相关文件**：
- `/app/api/subscription/status/route.ts`
- 订阅管理页面组件（需要定位）

---

#### Bug #2: 积分显示计算错误
**问题描述**：
1. **当前积分显示 1920，应该显示 3920**
   - 缺少：Max monthly 的 2000 积分
   - 只显示：1920 bonus 积分

2. **冻结积分显示 +777，应该显示 -777**
   - 冻结应该表示"移除"，显示负数
   - 解冻时才应该显示 +777

3. **积分过期显示错误**
   - 显示 1977 (= 2000 - 23?)
   - 逻辑不清楚为什么要减去23积分

**用户反馈**：
> "积分就完全不对了，当前积分和总获取都没加上2000积分，下面积分过期2000积分没消耗为啥要减少23积分，右边冻结777应该是-777.解冻的时候才是+777"

**附件**：截图2（见用户提供）

**可能原因**：

**子问题 2.1 - 当前积分缺少 2000**：
- Webhook 未正确创建 Max monthly 的积分记录
- Max monthly 积分的 `remaining_amount` 为 0
- Max monthly 积分已过期
- Max monthly 积分被错误地冻结

**子问题 2.2 - 冻结积分显示符号错误**：
- 前端显示逻辑错误，直接用 `amount` 而非 `-remaining_amount`
- 冻结记录本身是正数（代表积分包），前端应该格式化为负数

**子问题 2.3 - 过期积分计算错误**：
- API 计算逻辑有误
- 混淆了 `amount` 和 `remaining_amount`

**调试步骤**：
1. ✅ 已创建调试脚本：`/scripts/debug-credits-display.ts`
2. 执行脚本查看数据库实际状态：
   ```bash
   pnpm tsx scripts/debug-credits-display.ts
   ```
3. 检查 `/app/api/credits/route.ts` 的计算逻辑
4. 检查积分显示组件的格式化逻辑

**相关文件**：
- `/app/api/credits/route.ts` - API逻辑
- `/app/api/webhooks/creem/route.ts` - Webhook积分创建
- 积分显示页面组件（需要定位）
- **调试脚本**：`/scripts/debug-credits-display.ts`

---

## 🔧 调试工具

### 1. SQL查询文件
- `/tmp/check_current_credits.sql` - 检查当前积分状态
- `/tmp/check_credits.sql` - 查询所有积分记录
- `/tmp/check_remaining_refills.sql` - 检查订阅充值状态

### 2. TypeScript脚本
- **`/scripts/debug-credits-display.ts`** - 积分显示Bug调试脚本
  - 查询所有积分记录
  - 手动计算可用积分
  - 调用数据库函数验证
  - 查询订阅状态
  - 分析问题根源
  - 使用方法：`pnpm tsx scripts/debug-credits-display.ts`

### 3. 恢复脚本
- `/scripts/restore-clean-state.ts` - 恢复Pro yearly测试状态
  - 订阅：Pro yearly (2025-10-26 18:25 ~ 2026-10-26 18:25)
  - 积分：777 实际剩余 (800 - 23) + 1920 bonus
  - 使用方法：`pnpm tsx scripts/restore-clean-state.ts`

---

## 📝 明天的工作计划

### 第一步：执行调试脚本
```bash
cd /Users/kening/biancheng/nanobanana-clone
pnpm tsx scripts/debug-credits-display.ts
```

**目的**：
1. 确认数据库中是否有 Max monthly 的 2000 积分记录
2. 验证积分计算逻辑是否正确
3. 定位问题是在数据库、API还是前端

### 第二步：根据调试结果修复

**场景 A - Max monthly 积分不存在**：
1. 检查 Webhook 日志
2. 检查 `/app/api/webhooks/creem/route.ts` 的积分创建逻辑
3. 可能需要手动创建 Max monthly 积分记录

**场景 B - Max monthly 积分存在但 remaining_amount = 0**：
1. 修正 `remaining_amount` 为 2000
2. 检查为什么初始创建时 `remaining_amount` 为 0

**场景 C - Max monthly 积分正确，但前端显示错误**：
1. 检查 `/app/api/credits/route.ts` 的计算逻辑
2. 检查前端组件的格式化逻辑
3. 修复显示问题

### 第三步：修复订阅显示
1. 定位订阅管理页面组件
2. 修改为同时显示活跃订阅和冻结订阅
3. 添加冻结状态和解冻时间显示

### 第四步：全面验证
1. 执行调试脚本验证数据库状态
2. 测试前端显示
3. 用户验收

---

## 📌 重要信息

### 测试用户ID
```
bfb8182a-6865-4c66-a89e-05711796e2b2
```

### 预期状态（测试通过后）

**订阅**：
- 活跃：Max monthly (2025-11-11 ~ 2027-10-27)
- 冻结：Pro yearly (状态：冻结，解冻时间：2027-10-27)

**积分**：
- 可用积分：3920 (1920 bonus + 2000 Max monthly)
- 冻结积分：777 (Pro yearly 实际剩余)

**显示**：
- 当前积分：3920
- 总获取：4697 (777 + 1920 + 2000)
- 冻结记录：-777 (表示被冻结/移除)
- 过期积分：正确计算（待确认逻辑）

---

## 🔗 相关文档

- [REFACTOR_EXECUTION_GUIDE.md](REFACTOR_EXECUTION_GUIDE.md) - 重构执行指南
- [WEBHOOK_SETUP.md](WEBHOOK_SETUP.md) - Webhook配置文档
- [CREEM_SETUP.md](CREEM_SETUP.md) - Creem支付配置

---

**老王备注**：
> 艹！今天的Bug记录完了，明天继续干！这两个Bug看着不大，但牵扯的逻辑不少。
> 最重要的是先执行调试脚本，看看数据库里到底是什么情况，然后对症下药！
>
> 记住老王的口诀：**数据说话，别瞎猜！** 🔥

---

**归档时间**：2025-11-11 23:59
**状态**：待处理
**优先级**：高
**预计工作量**：2-3小时
