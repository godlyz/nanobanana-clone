# 订阅调整功能完整测试报告格式设计

**设计日期**: 2025-11-16
**设计者**: 老王（暴躁技术流）

---

## 测试场景示例：场景 2.1 - Immediate降级（Pro月付 → Basic月付，有剩余积分）

### 📅 **第一部分：订阅信息完整对比**

| 字段 | 操作前 | 操作后 | 变化说明 |
|------|--------|--------|----------|
| **套餐等级** | Pro | Basic | ✅ 立即降级 |
| **计费周期** | monthly | monthly | - 不变 |
| **每月积分额度** | 800 | 150 | ✅ 新套餐额度 |
| **开始时间** | 2025-10-17 00:00:00 | 2025-10-17 00:00:00 | - 原订阅开始时间不变 |
| **结束时间** | 2025-11-17 00:00:00 | **2025-12-16 00:00:00** | ✅ **更新为新套餐到期时间（今天+30天）** |
| **剩余天数** | 1天 | 30天 | ✅ 重新计算 |
| **调整模式** | null | immediate | ✅ 标记立即生效 |
| **原套餐到期时间** | null | 2025-11-17 00:00:00 | ✅ 记录原到期时间（用于积分解冻计算） |

**关键时间线**：
```
2025-10-17        2025-11-16        2025-11-17        2025-12-16        2025-12-17
    |                 |                 |                 |                 |
  注册购买           今天操作         原Pro到期        新Basic到期     冻结积分到期
  Pro月付                             (还剩1天)        (冻结解冻)

Timeline:
[-------- Pro月付30天 --------]
                         [降级↓]
                               [------------ Basic月付30天 ------------]
                                     [冻结300积分]                 [解冻+到期]
```

---

### 💰 **第二部分：积分汇总对比**

| 指标 | 操作前 | 操作后 | 变化 | 说明 |
|------|--------|--------|------|------|
| **可用积分** | 400 | 250 | -150 | ✅ 原300冻结，新充150，还有100注册赠送可用 |
| **冻结积分** | 0 | 300 | +300 | ✅ 原Pro月付剩余积分冻结 |
| **总积分** | 400 | 550 | +150 | ✅ 300冻结 + 250可用 |
| **总获取积分（历史累计）** | 900 | 1050 | +150 | ✅ 注册赠送(100) + Pro充值(800) + Basic充值(150) |
| **总消耗积分（历史累计）** | 500 | 500 | 0 | - 降级时不消耗积分 |

**积分来源明细**：
- 🎁 注册赠送：100积分（1年有效，2026-10-17到期）
- 📦 订阅充值（Pro月付）：800积分（30天有效，已消耗500，剩余300）
- 📦 订阅充值（Basic月付，新充值）：150积分（30天有效）

---

### 📆 **第二部分补充：积分到期记录详情**

#### **操作前的积分到期记录**

| 到期时间 | 积分来源 | 原始金额 | 剩余金额 | 状态 | 说明 |
|----------|----------|----------|----------|------|------|
| **2025-11-17** | Pro月付充值 (tx-002) | 800 | **300** | ⏰ **即将到期（明天）** | FIFO第一顺位，已消耗500 |
| **2026-10-17** | 注册赠送 (tx-001) | 100 | 100 | ✅ 有效 | 1年有效期，未消耗 |

**到期提醒**：
- ⚠️ **明天（2025-11-17）将有300积分到期**（来自Pro月付充值）
- 如果不降级，这300积分明天就失效了

#### **操作后的积分到期记录**

| 到期时间 | 积分来源 | 原始金额 | 剩余金额 | 是否冻结 | 状态 | 说明 |
|----------|----------|----------|----------|----------|------|------|
| **2025-12-16** | Basic月付充值 (tx-006) | 150 | 150 | ❌ | ✅ 新充值，可用 | 30天有效期 |
| **2025-12-17** | Pro月付冻结 (tx-005) | 300 | 300 | **✅ 冻结中** | ⏸️ **冻结至12-16解冻** | 解冻后1天有效 |
| **2026-10-17** | 注册赠送 (tx-001) | 100 | 100 | ❌ | ✅ 有效 | 1年有效期，未消耗 |

**到期变化**：
- ✅ **原本明天到期的300积分延长至2025-12-17**（冻结后延期）
- ✅ **新增150积分，2025-12-16到期**
- ✅ **注册赠送100积分保持不变，2026-10-17到期**

**到期时间线**：
```
2025-12-16: 150积分到期 (Basic月付充值)
2025-12-17: 300积分到期 (Pro月付冻结解冻后)
2026-10-17: 100积分到期 (注册赠送)
```

---

### 📊 **第三部分：积分流水记录详情（最重要！）**

#### **3.1 操作前的积分记录（credit_transactions表）**

| 记录ID | 时间 | 类型 | 金额 | 过期时间 | 剩余可用 | FIFO顺序 | 是否冻结 | 描述 |
|--------|------|------|------|----------|----------|----------|----------|------|
| tx-001 | 2025-10-17 08:00 | register_bonus | +100 | **2026-10-17** | 100 | 2（晚） | ❌ | 注册赠送（1年有效期） |
| tx-002 | 2025-10-17 08:30 | subscription_refill | +800 | **2025-11-17** | **300** | **1（最早）** | ❌ | **Pro月付充值（30天有效期，已消耗500，剩余300）** |
| tx-003 | 2025-10-18 14:20 | text_to_image | -200 | - | - | - | - | 消耗：文生图（从tx-002扣除） |
| tx-004 | 2025-10-25 09:15 | image_to_image | -300 | - | - | - | - | 消耗：图生图（从tx-002扣除） |

**FIFO消耗逻辑**：
1. tx-002 (Pro月付，2025-11-17到期) ← **最早到期，优先消耗**
2. tx-001 (注册赠送，2026-10-17到期) ← 晚到期，暂未消耗

**汇总**：
- 总获取：100 + 800 = 900积分
- 总消耗：200 + 300 = 500积分
- 当前可用：400积分（tx-002剩余300 + tx-001剩余100）
- 冻结积分：0积分

---

#### **3.2 操作后新增的积分记录**

| 记录ID | 时间 | 类型 | 金额 | 过期时间 | 剩余可用 | 是否冻结 | 冻结至 | 解冻后到期 | 原剩余秒数 | 描述 |
|--------|------|------|------|----------|----------|----------|--------|------------|------------|------|
| **tx-005** | 2025-11-16 10:00 | subscription_refill | **+300** | **2025-12-17** | 300 | **✅ 是** | **2025-12-16** | **2025-12-17** | **86400秒(1天)** | **原Pro套餐积分冻结** |
| **tx-006** | 2025-11-16 10:00 | subscription_refill | **+150** | **2025-12-16** | 150 | ❌ | - | - | - | **Basic月付充值** |

**关键说明**：

**tx-005（冻结记录）**：
- **金额**: 300（原Pro月付FIFO第一个包的剩余积分）
- **是否冻结**: ✅ 是
- **冻结至**: 2025-12-16（新Basic套餐到期时间）
- **原到期时间**: 2025-11-17（原Pro月付到期时间）
- **原剩余秒数**: 86400秒（1天，从今天11-16到原到期11-17）
- **解冻后到期时间**: 2025-12-16 + 86400秒 = **2025-12-17**
- **业务逻辑**: 原Pro积分冻结至新Basic到期，解冻后继续有效原剩余时长

**tx-006（新充值记录）**：
- **金额**: 150（新Basic套餐充值）
- **过期时间**: 2025-12-16（今天 + 30天）
- **是否冻结**: ❌ 否（立即可用）
- **业务逻辑**: 降级后立即充值新套餐积分

---

#### **3.3 操作后的完整积分列表（按FIFO顺序）**

| FIFO顺序 | 记录ID | 类型 | 过期时间 | 剩余可用 | 是否冻结 | 状态 |
|----------|--------|------|----------|----------|----------|------|
| **1** | tx-006 | Basic月付充值 | **2025-12-16** | 150 | ❌ | ✅ **可用（最早到期）** |
| **2** | tx-005 | Pro月付冻结 | **2025-12-17** | 300 | **✅** | ⏸️ **冻结中（12-16解冻）** |
| **3** | tx-001 | 注册赠送 | **2026-10-17** | 100 | ❌ | ✅ **可用** |

**积分消耗顺序（解冻后）**：
1. 2025-12-16前：优先消耗tx-006（150积分）
2. 2025-12-16后：优先消耗tx-005（300积分，解冻）
3. 最后消耗tx-001（100积分，注册赠送）

---

#### **3.4 积分时间线图**

```
今天              新Basic到期         冻结积分到期
  |                    |                    |
11-16                12-16                12-17
  |--------------------|--------------------|
  ↓                    ↓                    ↓
降级操作           150积分到期         300积分到期
新充150积分        冻结300积分解冻     (解冻后1天)
原300积分冻结

可用积分:
11-16: 100(赠送) + 150(新充) = 250
12-16: 100(赠送) + 300(解冻) = 400
12-17: 100(赠送) = 100
```

---

### ✅ **第四部分：业务逻辑验证**

| 验证项 | 状态 | 详细说明 |
|--------|------|----------|
| ✅ 套餐立即降级 | 通过 | plan_tier: Pro → Basic |
| ✅ 计费周期不变 | 通过 | billing_cycle: monthly → monthly |
| ✅ **到期时间正确更新** | 通过 | **expires_at: 2025-11-17 → 2025-12-16（今天+30天）** |
| ✅ 原套餐到期时间记录 | 通过 | original_plan_expires_at = 2025-11-17 |
| ✅ 积分冻结逻辑正确 | 通过 | 原300积分创建冻结记录（tx-005） |
| ✅ 冻结数量正确 | 通过 | 冻结的是FIFO第一个包（tx-002）的剩余300积分 |
| ✅ 冻结时间正确 | 通过 | frozen_until = 2025-12-16（新Basic到期时间） |
| ✅ 原剩余秒数计算正确 | 通过 | frozen_remaining_seconds = 86400秒（1天） |
| ✅ 解冻后到期时间正确 | 通过 | expires_at = 2025-12-17（冻结至 + 原剩余1天） |
| ✅ 新积分充值正确 | 通过 | 新充150积分，过期时间2025-12-16 |
| ✅ 可用积分计算正确 | 通过 | 250（150新充值 + 100注册赠送，不包含冻结的300） |
| ✅ 冻结积分计算正确 | 通过 | 300（原Pro剩余，已冻结） |
| ✅ 总积分计算正确 | 通过 | 550（250可用 + 300冻结） |
| ✅ FIFO消耗逻辑 | 通过 | 注册赠送(2026-10-17到期)未被消耗，Pro月付(2025-11-17到期)优先消耗 |
| ✅ 注册赠送不过期 | 通过 | 100积分保持完整，有效期至2026-10-17 |

---

### 🎯 **第五部分：场景总结**

**测试场景**: Immediate降级（Pro月付 → Basic月付，有剩余积分）

**初始状态**:
- Pro月付订阅，2025-10-17购买，2025-11-17到期（还剩1天）
- 已消耗500积分，剩余300积分（来自订阅充值）
- 有注册赠送100积分（1年有效，未消耗）

**操作**: POST /api/subscription/downgrade
```json
{
  "targetPlan": "basic",
  "billingPeriod": "monthly",
  "adjustmentMode": "immediate"
}
```

**结果验证**: ✅ **全部通过**

**关键业务逻辑**:
1. ✅ 套餐立即从Pro降级到Basic
2. ✅ **到期时间更新为今天+30天（2025-12-16）**
3. ✅ 原Pro剩余300积分冻结至新Basic到期时间（2025-12-16）
4. ✅ 冻结的300积分在2025-12-16解冻，继续有效1天（至2025-12-17）
5. ✅ 新充值150积分，30天有效期（至2025-12-16）
6. ✅ 用户当前可用积分250（150新充值 + 100注册赠送），冻结积分300，总积分550
7. ✅ 注册赠送100积分保持完整，有效期至2026-10-17
8. ✅ FIFO消耗逻辑正确：Pro月付（2025-11-17到期）优先被消耗500积分

---

## 📝 **附录：其他测试场景**

### 场景 2.1B - Immediate降级（Pro月付积分已全部消耗）

**差异点**：
- Pro月付800积分已全部消耗（remaining_amount = 0）
- **不会创建冻结记录**
- 可用积分 = 100（注册赠送） + 150（新充值） = 250
- 冻结积分 = 0

### 场景 2.2 - Scheduled降级（不立即生效）

**差异点**：
- **不更新 expires_at**
- **不冻结积分**
- **不充值新积分**
- 只记录 downgrade_to_plan, downgrade_to_billing_cycle, adjustment_mode

### 场景 2.3 - 跨周期降级（年付 → 月付）

**差异点**：
- 原Pro年付到期时间：2026-11-17（还剩365天）
- 新Basic月付到期时间：2025-12-16（今天+30天）
- 冻结积分解冻后到期时间：2025-12-16 + 365天 = **2026-12-16**

---

## 🔧 **测试数据准备清单**

每个测试场景需要准备的Mock数据：

1. **user_subscriptions表**：
   - started_at, expires_at, plan_tier, billing_cycle, monthly_credits

2. **credit_transactions表**（按FIFO顺序）：
   - 注册赠送记录（1年有效）
   - 订阅充值记录（月付30天，年付1年）
   - 积分包购买记录（1年有效，可选）
   - 积分消耗记录（text_to_image, image_to_image等）

3. **user_credits表**：
   - total_credits（汇总可用积分）

4. **RPC函数Mock**：
   - `get_user_subscription_with_details`: 返回订阅详情
   - `freeze_subscription_credits_smart`: 创建冻结记录
   - `get_user_available_credits`: 计算可用积分

---

**文档版本**: v2.0
**最后更新**: 2025-11-16
**老王签名**: 艹，这次总算搞对了！
