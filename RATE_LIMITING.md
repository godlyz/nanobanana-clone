# API Rate Limiting ç³»ç»Ÿæ–‡æ¡£

## ğŸ”¥ è€ç‹çš„é™æµç³»ç»Ÿå®ç°

**å®ç°æ—¥æœŸ**: 2025-11-23
**ä½œè€…**: è€ç‹ï¼ˆæš´èºæŠ€æœ¯æµï¼‰
**ç®—æ³•**: Sliding Window (æ»‘åŠ¨çª—å£) + Redis
**çŠ¶æ€**: âœ… å·²å®Œæˆå¹¶æµ‹è¯•é€šè¿‡

---

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

ä¸ºæ‰€æœ‰ API ç«¯ç‚¹æä¾›åŸºäºè®¢é˜…ç­‰çº§çš„è¯·æ±‚é¢‘ç‡é™åˆ¶ï¼Œé˜²æ­¢ API æ»¥ç”¨å’ŒæœåŠ¡å™¨èµ„æºæµªè´¹ã€‚

### æ ¸å¿ƒç‰¹æ€§

- âœ… **å¤šç­‰çº§é™æµ**: æ ¹æ®ç”¨æˆ·è®¢é˜…ç­‰çº§åŠ¨æ€è°ƒæ•´é™åˆ¶
- âœ… **Sliding Window ç®—æ³•**: ç²¾ç¡®çš„æ—¶é—´çª—å£æ§åˆ¶
- âœ… **Redis æŒä¹…åŒ–**: æ”¯æŒåˆ†å¸ƒå¼éƒ¨ç½²
- âœ… **ä¼˜é›…é™çº§**: Redis å¤±è´¥æ—¶è‡ªåŠ¨é™çº§åˆ°å…è®¸è¯·æ±‚
- âœ… **æ ‡å‡†å“åº”å¤´**: ç¬¦åˆ RFC 6585 è§„èŒƒ
- âœ… **ç‹¬ç«‹ç”¨æˆ·è®¡æ•°**: ä¸åŒç”¨æˆ·äº’ä¸å½±å“

---

## ğŸ¯ é™æµé…ç½®

### è¯·æ±‚é™åˆ¶ï¼ˆæ¯åˆ†é’Ÿï¼‰

| è®¢é˜…ç­‰çº§ | é™åˆ¶ (requests/min) | è¯´æ˜ |
|---------|---------------------|------|
| **FREE** | 100 | å…è´¹ç”¨æˆ·/æœªç™»å½•ç”¨æˆ· |
| **PRO** | 500 | Pro è®¢é˜…ç”¨æˆ· |
| **MAX** | 1000 | Max è®¢é˜…ç”¨æˆ· |

### æ—¶é—´çª—å£

- **çª—å£å¤§å°**: 60 ç§’ï¼ˆ1 åˆ†é’Ÿï¼‰
- **é‡ç½®ç­–ç•¥**: æ»‘åŠ¨çª—å£ï¼ˆæ¯ç§’ç‹¬ç«‹è®¡æ•°ï¼‰

---

## ğŸ’» ä½¿ç”¨æ–¹æ³•

### 1. åŸºç¡€ä½¿ç”¨ï¼ˆæ— è®¤è¯ APIï¼‰

é€‚ç”¨äºå…¬å¼€ API ç«¯ç‚¹ï¼ŒåŸºäº IP åœ°å€é™æµï¼š

```typescript
import { withRateLimit } from '@/lib/middleware/with-rate-limit'

export const POST = withRateLimit(async (request) => {
  // ä½ çš„ API é€»è¾‘
  return NextResponse.json({ success: true })
})
```

### 2. è®¤è¯ APIï¼ˆæ¨èï¼‰

é€‚ç”¨äºéœ€è¦è®¤è¯çš„ APIï¼ŒåŸºäºç”¨æˆ· ID é™æµï¼š

```typescript
import { withAuthAndRateLimit } from '@/lib/middleware/with-rate-limit'

export const POST = withAuthAndRateLimit(async (request, user) => {
  // user å·²è®¤è¯ï¼Œä¸”é€šè¿‡äº†é™æµæ£€æŸ¥
  // æ ¹æ®ç”¨æˆ·è®¢é˜…ç­‰çº§è‡ªåŠ¨åº”ç”¨å¯¹åº”çš„é™åˆ¶
  return NextResponse.json({ success: true })
})
```

### 3. ç»„åˆä½¿ç”¨ï¼ˆé«˜çº§ï¼‰

å¦‚æœéœ€è¦è‡ªå®šä¹‰è®¤è¯é€»è¾‘ï¼š

```typescript
import { withAuth } from '@/lib/api-auth'
import { withAuthRateLimit } from '@/lib/middleware/with-rate-limit'

export const POST = withAuth(async (request, user) => {
  return withAuthRateLimit(async (req, usr) => {
    // ä½ çš„ API é€»è¾‘
    return NextResponse.json({ success: true })
  })(request, user)
})
```

---

## ğŸ” å“åº”æ ¼å¼

### æˆåŠŸå“åº”ï¼ˆé™æµé€šè¿‡ï¼‰

HTTP 200 + å“åº”å¤´ï¼š

```http
HTTP/1.1 200 OK
X-RateLimit-Limit: 100
X-RateLimit-Remaining: 95
X-RateLimit-Reset: 1700000000

{
  "success": true,
  "data": { ... }
}
```

### é™æµæ‹’ç»å“åº”

HTTP 429 + é”™è¯¯ä¿¡æ¯ï¼š

```http
HTTP/1.1 429 Too Many Requests
X-RateLimit-Limit: 100
X-RateLimit-Remaining: 0
X-RateLimit-Reset: 1700000000

{
  "success": false,
  "error": "Rate limit exceeded",
  "message": "Too many requests. You are limited to 100 requests per minute. Please try again in 45 seconds.",
  "retryAfter": 1700000000
}
```

### å“åº”å¤´è¯´æ˜

- `X-RateLimit-Limit`: å½“å‰æ—¶é—´çª—å£çš„æ€»é™åˆ¶
- `X-RateLimit-Remaining`: å‰©ä½™å¯ç”¨è¯·æ±‚æ•°
- `X-RateLimit-Reset`: é™åˆ¶é‡ç½®æ—¶é—´ï¼ˆUnix æ—¶é—´æˆ³ï¼Œç§’ï¼‰

---

## ğŸ› ï¸ æ ¸å¿ƒå®ç°

### æ–‡ä»¶ç»“æ„

```
lib/middleware/
â”œâ”€â”€ rate-limiter.ts          # é™æµæ ¸å¿ƒé€»è¾‘
â””â”€â”€ with-rate-limit.ts       # ä¸­é—´ä»¶åŒ…è£…å™¨
```

### å…³é”®å‡½æ•°

#### `checkRateLimit(identifier, limit)`

æ‰§è¡Œé™æµæ£€æŸ¥çš„æ ¸å¿ƒå‡½æ•°ã€‚

**å‚æ•°**:
- `identifier`: å®¢æˆ·ç«¯æ ‡è¯†ç¬¦ï¼ˆç”¨æˆ· ID æˆ– IP åœ°å€ï¼‰
- `limit`: è¯·æ±‚é™åˆ¶æ•°é‡

**è¿”å›å€¼**:
```typescript
{
  allowed: boolean,      // æ˜¯å¦å…è®¸è¯·æ±‚
  limit: number,         // æ€»é™åˆ¶
  remaining: number,     // å‰©ä½™é¢åº¦
  reset: number         // é‡ç½®æ—¶é—´æˆ³ï¼ˆç§’ï¼‰
}
```

#### `getUserTier(userId)`

è·å–ç”¨æˆ·è®¢é˜…ç­‰çº§ã€‚

**æµç¨‹**:
1. æŸ¥è¯¢ `user_subscriptions` è¡¨
2. æ£€æŸ¥ `status = 'active'`
3. æ ¹æ® `plan_type` è¿”å›å¯¹åº”ç­‰çº§

**è¿”å›å€¼**: `'FREE' | 'PRO' | 'MAX'`

---

## ğŸ”§ é…ç½®

### ç¯å¢ƒå˜é‡

éœ€è¦é…ç½®ä»¥ä¸‹ Redis ç¯å¢ƒå˜é‡ï¼ˆå‚è§ `.env.local.example`ï¼‰ï¼š

```bash
# Redis (Upstash)
UPSTASH_REDIS_REST_URL=https://your-redis.upstash.io
UPSTASH_REDIS_REST_TOKEN=your_token_here
```

### å¼€å‘ç¯å¢ƒ

å¦‚æœæœªé…ç½® Redisï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ä½¿ç”¨ **InMemoryRedis** ä½œä¸ºåå¤‡æ–¹æ¡ˆï¼ˆä»…ä¾›å¼€å‘/æµ‹è¯•ä½¿ç”¨ï¼‰ã€‚

âš ï¸ **ç”Ÿäº§ç¯å¢ƒå¿…é¡»é…ç½®çœŸå® Redis**ï¼Œå¦åˆ™æ— æ³•æ”¯æŒåˆ†å¸ƒå¼éƒ¨ç½²ã€‚

---

## ğŸ“Š ç›‘æ§ä¸åˆ†æ

### æ—¥å¿—è¾“å‡º

é™æµç³»ç»Ÿä¼šåœ¨ä»¥ä¸‹æƒ…å†µè¾“å‡ºæ—¥å¿—ï¼š

1. **é™æµè§¦å‘**:
   ```
   âš ï¸ é™æµè§¦å‘ [user:123]: PRO tier, 500 req/min
   ```

2. **Redis æ“ä½œå¤±è´¥**:
   ```
   âš ï¸ Redisé™æµæ“ä½œå¤±è´¥ï¼Œå…è®¸è¯·æ±‚é€šè¿‡
   ```

3. **é…ç½®ç¼ºå¤±**:
   ```
   âš ï¸ Redisé…ç½®ç¼ºå¤±ï¼Œä½¿ç”¨å†…å­˜ç¼“å­˜å®ç°
   ```

### å»ºè®®çš„ç›‘æ§æŒ‡æ ‡

- é™æµè§¦å‘æ¬¡æ•°ï¼ˆæŒ‰ç­‰çº§åˆ†ç»„ï¼‰
- å¹³å‡è¯·æ±‚è®¡æ•°
- Redis æ“ä½œå¤±è´¥ç‡
- é™æµé™çº§æ¬¡æ•°

---

## âœ… æµ‹è¯•

### è¿è¡Œæµ‹è¯•

```bash
pnpm test __tests__/lib/rate-limiter.test.ts
```

### æµ‹è¯•è¦†ç›–

- âœ… åŸºç¡€é™æµé€»è¾‘
- âœ… å¤šè¯·æ±‚è®¡æ•°
- âœ… è¾¾åˆ°é™åˆ¶æ—¶æ‹’ç»
- âœ… ç”¨æˆ·ç‹¬ç«‹è®¡æ•°
- âœ… å¤šç­‰çº§é…ç½®
- âœ… Redis å¤±è´¥é™çº§
- âœ… æ—¶é—´æˆ³æ­£ç¡®æ€§

**æµ‹è¯•ç»“æœ**: 9/9 æµ‹è¯•é€šè¿‡ âœ…

---

## ğŸš¨ æ•…éšœå¤„ç†

### Redis è¿æ¥å¤±è´¥

**ç°è±¡**: æ—¥å¿—è¾“å‡º "Redisé…ç½®ç¼ºå¤±ï¼Œä½¿ç”¨å†…å­˜ç¼“å­˜å®ç°"

**åŸå› **:
1. ç¯å¢ƒå˜é‡æœªé…ç½®
2. Redis æœåŠ¡ä¸å¯ç”¨

**å½±å“**: ä½¿ç”¨å†…å­˜ç¼“å­˜ï¼ˆå•å®ä¾‹æœ‰æ•ˆï¼‰

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥ `.env.local` é…ç½®
2. éªŒè¯ Redis è¿æ¥ï¼š`curl <UPSTASH_REDIS_REST_URL>`

### Redis æ“ä½œå¤±è´¥

**ç°è±¡**: æ—¥å¿—è¾“å‡º "Redisé™æµæ“ä½œå¤±è´¥ï¼Œå…è®¸è¯·æ±‚é€šè¿‡"

**å½±å“**: é™æµå¤±æ•ˆï¼Œä½†ä¸å½±å“ API æ­£å¸¸è¿è¡Œï¼ˆä¼˜é›…é™çº§ï¼‰

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥ Redis æœåŠ¡çŠ¶æ€
2. æ£€æŸ¥ç½‘ç»œè¿æ¥
3. æŸ¥çœ‹ Redis é”™è¯¯æ—¥å¿—

### é™æµè¯¯åˆ¤

**ç°è±¡**: ç”¨æˆ·æŠ¥å‘Šè¢«é”™è¯¯é™æµ

**æ’æŸ¥æ­¥éª¤**:
1. æ£€æŸ¥ç”¨æˆ·è®¢é˜…çŠ¶æ€ï¼ˆ`user_subscriptions` è¡¨ï¼‰
2. ç¡®è®¤ IP åœ°å€æ­£ç¡®æ€§ï¼ˆX-Forwarded-For å¤´ï¼‰
3. æŸ¥çœ‹ Redis é”®å€¼ï¼š`rate_limit:<identifier>:*`

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### Redis ä¼˜åŒ–

1. **é”®è¿‡æœŸç­–ç•¥**: è‡ªåŠ¨è®¾ç½® 60 ç§’ TTL
2. **åŸå­æ“ä½œ**: ä½¿ç”¨ INCR ç¡®ä¿å¹¶å‘å®‰å…¨
3. **æ‰¹é‡æŸ¥è¯¢**: æœªæ¥å¯è€ƒè™‘ Pipeline ä¼˜åŒ–

### ä»£ç ä¼˜åŒ–

1. **å¼‚æ­¥å¤„ç†**: æ‰€æœ‰ Redis æ“ä½œéƒ½æ˜¯å¼‚æ­¥çš„
2. **é”™è¯¯æ•è·**: å®Œæ•´çš„ try-catch ä¿æŠ¤
3. **ç±»å‹å®‰å…¨**: å®Œæ•´çš„ TypeScript ç±»å‹å®šä¹‰

---

## ğŸ”„ æœªæ¥æ”¹è¿›

### çŸ­æœŸè®¡åˆ’

- [ ] æ·»åŠ  Prometheus æŒ‡æ ‡å¯¼å‡º
- [ ] å®ç°é™æµç™½åå•ï¼ˆç®¡ç†å‘˜è±å…ï¼‰
- [ ] æ”¯æŒè‡ªå®šä¹‰æ—¶é—´çª—å£
- [ ] æ·»åŠ çªå‘æµé‡å¤„ç†ï¼ˆToken Bucketï¼‰

### é•¿æœŸè®¡åˆ’

- [ ] IP é»‘åå•è‡ªåŠ¨å°ç¦
- [ ] åŠ¨æ€é™æµè°ƒæ•´ï¼ˆåŸºäºæœåŠ¡å™¨è´Ÿè½½ï¼‰
- [ ] å¤šåŒºåŸŸ Redis éƒ¨ç½²
- [ ] é™æµæ•°æ®åˆ†æä»ªè¡¨ç›˜

---

## ğŸ“– å‚è€ƒèµ„æ–™

- [RFC 6585 - Additional HTTP Status Codes](https://tools.ietf.org/html/rfc6585)
- [Upstash Redis Documentation](https://docs.upstash.com/redis)
- [Rate Limiting Strategies](https://cloud.google.com/architecture/rate-limiting-strategies-techniques)

---

**æ–‡æ¡£ç»´æŠ¤è€…**: è€ç‹
**æœ€åæ›´æ–°**: 2025-11-23
**ç‰ˆæœ¬**: v1.0.0
