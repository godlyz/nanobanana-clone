# è§†é¢‘ç”Ÿæˆ API æ–‡æ¡£

Nano Banana è§†é¢‘ç”ŸæˆåŠŸèƒ½åŸºäº Google Veo 3.1 APIï¼Œæ”¯æŒé€šè¿‡è‡ªç„¶è¯­è¨€æç¤ºè¯ç”Ÿæˆé«˜è´¨é‡è§†é¢‘ã€‚

---

## ğŸ“‹ ç›®å½•

- [åŠŸèƒ½ç‰¹æ€§](#åŠŸèƒ½ç‰¹æ€§)
- [è§†é¢‘ç”Ÿæˆæ¨¡å¼](#è§†é¢‘ç”Ÿæˆæ¨¡å¼)
- [å‚æ•°é™åˆ¶çŸ©é˜µ](#å‚æ•°é™åˆ¶çŸ©é˜µ)
- [äººç‰©ç”Ÿæˆæ§åˆ¶](#äººç‰©ç”Ÿæˆæ§åˆ¶)
- [æŠ€æœ¯æ¶æ„](#æŠ€æœ¯æ¶æ„)
- [API ç«¯ç‚¹](#api-ç«¯ç‚¹)
- [è§†é¢‘å»¶é•¿åŠŸèƒ½](#è§†é¢‘å»¶é•¿åŠŸèƒ½)
- [ç§¯åˆ†æ¶ˆè´¹è§„åˆ™](#ç§¯åˆ†æ¶ˆè´¹è§„åˆ™)
- [ä½¿ç”¨æµç¨‹](#ä½¿ç”¨æµç¨‹)
- [é”™è¯¯å¤„ç†](#é”™è¯¯å¤„ç†)
- [æœ€ä½³å®è·µå»ºè®®](#æœ€ä½³å®è·µå»ºè®®)
- [ç¯å¢ƒé…ç½®](#ç¯å¢ƒé…ç½®)
- [æµ‹è¯•æŒ‡å—](#æµ‹è¯•æŒ‡å—)

---

## ğŸ¯ åŠŸèƒ½ç‰¹æ€§

- âœ… **å¤šç§ç”Ÿæˆæ¨¡å¼**ï¼šæ”¯æŒæ–‡ç”Ÿè§†é¢‘ã€å›¾ç”Ÿè§†é¢‘ã€å‚è€ƒå›¾ç‰‡ã€é¦–å°¾å¸§æ’å€¼ã€è§†é¢‘å»¶é•¿
- âœ… **è‡ªç„¶è¯­è¨€ç”Ÿæˆ**ï¼šé€šè¿‡æ–‡å­—æè¿°ç”Ÿæˆè§†é¢‘ï¼Œæ”¯æŒå¤æ‚é•œå¤´è¯­è¨€å’ŒéŸ³é¢‘æç¤º
- âœ… **å¤šç§åˆ†è¾¨ç‡**ï¼šæ”¯æŒ 720p å’Œ 1080pï¼ˆè§†é¢‘å»¶é•¿ä»…æ”¯æŒ 720pï¼‰
- âœ… **çµæ´»æ—¶é•¿**ï¼šæ”¯æŒ 4 ç§’ã€6 ç§’ã€8 ç§’ï¼ˆä¸åŒæ¨¡å¼æœ‰ä¸“é—¨é™åˆ¶ï¼Œè§å‚æ•°çŸ©é˜µï¼‰
- âœ… **å®½é«˜æ¯”é€‰æ‹©**ï¼š16:9ï¼ˆæ¨ªå±ï¼‰å’Œ 9:16ï¼ˆç«–å±ï¼‰
- âœ… **å‚è€ƒå›¾åƒä¸å¸§æ§åˆ¶**ï¼šæ”¯æŒ 1â€“3 å¼ å‚è€ƒå›¾ç‰‡ã€é¦–å¸§ / å°¾å¸§æ’å€¼ç”Ÿæˆ
- âœ… **äººç‰©ç”Ÿæˆæ§åˆ¶**ï¼šé€šè¿‡ `personGeneration` æ§åˆ¶æ˜¯å¦ç”Ÿæˆäººç‰©åŠå¹´é¾„æ®µï¼Œæ”¯æŒåœ°åŒºå·®å¼‚ç­–ç•¥
- âœ… **è´Ÿé¢æç¤ºè¯**ï¼šæ’é™¤ä¸éœ€è¦çš„å…ƒç´ ï¼ˆ`negativePrompt`ï¼‰
- âœ… **ç§¯åˆ†ç³»ç»Ÿ**ï¼šåŠ¨æ€è®¡è´¹ï¼Œå¤±è´¥è‡ªåŠ¨é€€æ¬¾
- âœ… **å¹¶å‘é™åˆ¶**ï¼šæ¯ç”¨æˆ·æœ€å¤š 3 ä¸ªå¹¶å‘ä»»åŠ¡
- âœ… **å¼‚æ­¥å¤„ç†**ï¼šåå°ç”Ÿæˆï¼Œè½®è¯¢æŸ¥è¯¢çŠ¶æ€

---

## ğŸ¬ è§†é¢‘ç”Ÿæˆæ¨¡å¼

Veo 3.1 API æ”¯æŒä»¥ä¸‹5ç§è§†é¢‘ç”Ÿæˆæ¨¡å¼ï¼š

| æ¨¡å¼ | è¯´æ˜ | è¾“å…¥è¦æ±‚ | å…¸å‹ç”¨é€” |
|------|------|---------|---------|
| **æ–‡ç”Ÿè§†é¢‘** (text-to-video) | çº¯æ–‡å­—æç¤ºè¯ç”Ÿæˆ | ä»…éœ€æç¤ºè¯ | åˆ›æ„å†…å®¹ç”Ÿæˆ |
| **å›¾ç”Ÿè§†é¢‘** (image-to-video) | å•å¼ å›¾ç‰‡+æç¤ºè¯ | 1å¼ å›¾ç‰‡ | é™æ€å›¾ç‰‡åŠ¨ç”»åŒ– |
| **å‚è€ƒå›¾ç‰‡** (reference-images) | å¤šå¼ å‚è€ƒå›¾+æç¤ºè¯ | 1-3å¼ å›¾ç‰‡ | é£æ ¼/è§’è‰²ä¸€è‡´æ€§ |
| **é¦–å°¾å¸§æ’å€¼** (first-last-frame) | é¦–å°¾ä¸¤å¸§å›¾ç‰‡æ’å€¼ | 2å¼ å›¾ç‰‡(é¦–+å°¾) | å¹³æ»‘è¿‡æ¸¡åŠ¨ç”» |
| **è§†é¢‘å»¶é•¿** (extend-video) | å»¶é•¿å·²ç”Ÿæˆè§†é¢‘ | å·²æœ‰Veoè§†é¢‘ | å¢åŠ è§†é¢‘é•¿åº¦ |

---

## ğŸ“Š å‚æ•°é™åˆ¶çŸ©é˜µ

ä¸åŒç”Ÿæˆæ¨¡å¼å¯¹å‚æ•°çš„æ”¯æŒæƒ…å†µï¼š

| å‚æ•° | æ–‡ç”Ÿè§†é¢‘ | å›¾ç”Ÿè§†é¢‘ | å‚è€ƒå›¾ç‰‡ | é¦–å°¾å¸§ | è§†é¢‘å»¶é•¿ |
|------|---------|---------|---------|-------|---------|
| `prompt` | âœ… å¿…éœ€ | âœ… å¿…éœ€ | âœ… å¿…éœ€ | âœ… å¿…éœ€ | âœ… å¿…éœ€ |
| `negativePrompt` | âœ… å¯é€‰ | âœ… å¯é€‰ | âœ… å¯é€‰ | âœ… å¯é€‰ | âœ… å¯é€‰ |
| `aspectRatio` | `16:9` / `9:16` | `16:9` / `9:16` | **ä»…`16:9`** | `16:9` / `9:16` | ç»§æ‰¿æºè§†é¢‘ |
| `resolution` | `720p` / `1080p` | `720p` / `1080p` | `720p` / `1080p` | `720p` / `1080p` | **ä»…`720p`** |
| `durationSeconds` | `4` / `6` / `8` | `4` / `6` / `8` | **ä»…`8`** | **ä»…`8`** | å›ºå®š+7ç§’ |
| `personGeneration` | `allow_all` | `allow_adult` | `allow_adult` | `allow_adult` | `allow_all` |
| `image` | âŒ | âœ… 1å¼  | âŒ | âœ… é¦–å¸§ | âŒ |
| `lastFrame` | âŒ | âŒ | âŒ | âœ… å°¾å¸§ | âŒ |
| `referenceImages` | âŒ | âŒ | âœ… 1-3å¼  | âŒ | âŒ |
| `video` | âŒ | âŒ | âŒ | âŒ | âœ… æºè§†é¢‘URI |

### âš ï¸ å…³é”®é™åˆ¶è¯´æ˜

**å‚è€ƒå›¾ç‰‡æ¨¡å¼ï¼ˆreference-imagesï¼‰**ï¼š
- âŒ **ä¸æ”¯æŒ9:16ç«–å±** - åªèƒ½ä½¿ç”¨16:9æ¨ªå±
- âŒ **ä¸æ”¯æŒ4ç§’/6ç§’** - æ—¶é•¿å¿…é¡»ä¸º8ç§’
- ğŸ“ **å®˜æ–¹åŸæ–‡**ï¼š*"Must be '8' when using referenceImages (only supports 16:9)"*

**é¦–å°¾å¸§æ’å€¼æ¨¡å¼ï¼ˆfirst-last-frame / interpolationï¼‰**ï¼š
- âŒ **ä¸æ”¯æŒ4ç§’/6ç§’** - æ—¶é•¿å¿…é¡»ä¸º8ç§’
- âœ… æ”¯æŒ16:9å’Œ9:16ä¸¤ç§å®½é«˜æ¯”
- ğŸ“ è¾“å…¥ä¸¤å¼ å›¾ç‰‡ï¼ˆé¦–å¸§å’Œå°¾å¸§ï¼‰ï¼ŒAPIè‡ªåŠ¨ç”Ÿæˆä¸­é—´çš„å¹³æ»‘è¿‡æ¸¡

**è§†é¢‘å»¶é•¿æ¨¡å¼ï¼ˆextend-video / extensionï¼‰**ï¼š
- âŒ **åªæ”¯æŒ720p** - ä¸æ”¯æŒ1080p
- â±ï¸ **å›ºå®šå»¶é•¿7ç§’** - æ— æ³•è‡ªå®šä¹‰å»¶é•¿æ—¶é•¿
- ğŸ“ **è§†é¢‘æœ€é•¿148ç§’** - è¶…è¿‡148ç§’çš„è§†é¢‘æ— æ³•ç»§ç»­å»¶é•¿
- ğŸ”„ **ä»4ç§’æœ€å¤šå»¶é•¿20æ¬¡** - å¯å»¶é•¿åˆ°144ç§’ï¼ˆ4+7Ã—20ï¼‰

---

## ğŸ‘¤ äººç‰©ç”Ÿæˆæ§åˆ¶ï¼ˆpersonGenerationï¼‰

æ§åˆ¶è§†é¢‘ä¸­æ˜¯å¦ç”Ÿæˆäººç‰©åŠå¹´é¾„é™åˆ¶ã€‚

### å¯é€‰å€¼

| å€¼ | è¯´æ˜ | é€‚ç”¨æ¨¡å¼ |
|---|------|---------|
| `allow_all` | å…è®¸ç”Ÿæˆæ‰€æœ‰å¹´é¾„æ®µçš„äººç‰© | æ–‡ç”Ÿè§†é¢‘ã€è§†é¢‘å»¶é•¿ |
| `allow_adult` | ä»…å…è®¸ç”Ÿæˆæˆå¹´äºº | å›¾ç”Ÿè§†é¢‘ã€å‚è€ƒå›¾ç‰‡ã€é¦–å°¾å¸§ |
| `dont_allow` | ä¸å…è®¸ç”Ÿæˆäººç‰©ï¼ˆä»…Veo 2æ”¯æŒï¼‰ | - |

### æ¨¡å¼é™åˆ¶ç¤ºä¾‹

```typescript
// âœ… æ­£ç¡®ç¤ºä¾‹
{
  mode: 'text-to-video',
  personGeneration: 'allow_all' // æˆ– 'allow_adult' / 'dont_allow'
}

{
  mode: 'reference-images',
  personGeneration: 'allow_adult' // åªèƒ½æ˜¯ allow_adult
}

// âŒ é”™è¯¯ç¤ºä¾‹
{
  mode: 'reference-images',
  personGeneration: 'allow_all' // âŒ ä¸æ”¯æŒ
}
```

### åœ°åŒºé™åˆ¶

åœ¨EUã€UKã€CHã€MENAåœ°åŒºï¼š
- **Veo 3.1**ï¼šåªèƒ½ä½¿ç”¨ `allow_adult`
- **Veo 2**ï¼šåªèƒ½ä½¿ç”¨ `allow_adult` æˆ– `dont_allow`ï¼ˆé»˜è®¤`dont_allow`ï¼‰

---

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

### æ ¸å¿ƒç»„ä»¶

```
ç”¨æˆ·è¯·æ±‚
    â†“
POST /api/v1/video/generate (åˆ›å»ºä»»åŠ¡)
    â†“
æ‰£é™¤ç§¯åˆ† â†’ è°ƒç”¨ Google Veo API
    â†“
è¿”å› task_id å’Œ operation_id
    â†“
Vercel Cron (æ¯åˆ†é’Ÿè½®è¯¢)
    â†“
æ£€æŸ¥ Google Veo çŠ¶æ€
    â†“
completed â†’ ä¸‹è½½è§†é¢‘ â†’ ä¸Šä¼  Supabase Storage
    â†“
failed â†’ è‡ªåŠ¨é€€æ¬¾
    â†“
GET /api/v1/video/status/:task_id (æŸ¥è¯¢ç»“æœ)
```

### æ•°æ®åº“è¡¨

- **`video_generation_history`**: è§†é¢‘ç”Ÿæˆä»»åŠ¡è®°å½•
- **`credit_transactions`**: ç§¯åˆ†äº¤æ˜“è®°å½•
- **`system_configs`**: è§†é¢‘å®šä»·é…ç½®

### åå°ä»»åŠ¡

- **`/api/cron/poll-video-status`**: æ¯åˆ†é’Ÿè½®è¯¢ Google Veo çŠ¶æ€
- **`/api/cron/download-video`**: ä¸‹è½½å¹¶ä¸Šä¼ è§†é¢‘åˆ° Supabase Storage

---

## ğŸ”Œ API ç«¯ç‚¹

### 1. åˆ›å»ºè§†é¢‘ç”Ÿæˆä»»åŠ¡

**POST** `/api/v1/video/generate`

#### è¯·æ±‚å¤´

```http
x-api-key: your_api_key
Content-Type: application/json
```

#### è¯·æ±‚ä½“

```json
{
  "prompt": "A beautiful sunset over the ocean with waves crashing on the beach",
  "negative_prompt": "low quality, blurry, distorted",
  "aspect_ratio": "16:9",
  "resolution": "720p",
  "duration": 4,
  "reference_image_url": "https://example.com/reference.jpg"
}
```

| å­—æ®µ | ç±»å‹ | å¿…éœ€ | è¯´æ˜ |
|-----|------|-----|------|
| `prompt` | string | âœ… | è§†é¢‘æç¤ºè¯ï¼ˆè‹±æ–‡ï¼Œå»ºè®®20-200å­—ï¼‰ |
| `negative_prompt` | string | âŒ | è´Ÿé¢æç¤ºè¯ï¼ˆä¸å¸Œæœ›å‡ºç°çš„å…ƒç´ ï¼‰ |
| `aspect_ratio` | string | âœ… | å®½é«˜æ¯”ï¼š`16:9` æˆ– `9:16` |
| `resolution` | string | âœ… | åˆ†è¾¨ç‡ï¼š`720p` æˆ– `1080p` |
| `duration` | number | âœ… | æ—¶é•¿ï¼ˆç§’ï¼‰ï¼š`4`ã€`6` æˆ– `8` |
| `reference_image_url` | string | âŒ | å‚è€ƒå›¾ç‰‡URLï¼ˆHTTPSï¼‰ |

#### æˆåŠŸå“åº” (200)

```json
{
  "success": true,
  "task_id": "550e8400-e29b-41d4-a716-446655440000",
  "operation_id": "projects/.../operations/...",
  "status": "processing",
  "credit_cost": 40,
  "estimated_completion_time": "11s-6min",
  "message": "Video generation task created successfully"
}
```

#### é”™è¯¯å“åº”

```json
// 400 - å‚æ•°é”™è¯¯
{
  "error": "Invalid aspect_ratio (must be \"16:9\" or \"9:16\")"
}

// 402 - ç§¯åˆ†ä¸è¶³
{
  "error": "INSUFFICIENT_CREDITS",
  "message": "Insufficient credits for video generation. Please purchase more credits."
}

// 429 - å¹¶å‘é™åˆ¶
{
  "error": "CONCURRENT_LIMIT_EXCEEDED",
  "message": "Maximum 3 concurrent video generation tasks allowed. Please wait for existing tasks to complete."
}
```

---

### 2. æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€

**GET** `/api/v1/video/status/:task_id`

#### è¯·æ±‚å¤´

```http
x-api-key: your_api_key
```

#### æˆåŠŸå“åº” - Processing (200)

```json
{
  "task_id": "550e8400-e29b-41d4-a716-446655440000",
  "status": "processing",
  "created_at": "2025-01-18T10:00:00Z",
  "prompt": "A beautiful sunset...",
  "aspect_ratio": "16:9",
  "resolution": "720p",
  "duration": 4,
  "credit_cost": 40,
  "message": "Video generation in progress. Estimated time: 11s-6min"
}
```

#### æˆåŠŸå“åº” - Completed (200)

```json
{
  "task_id": "550e8400-e29b-41d4-a716-446655440000",
  "status": "completed",
  "created_at": "2025-01-18T10:00:00Z",
  "completed_at": "2025-01-18T10:03:30Z",
  "prompt": "A beautiful sunset...",
  "aspect_ratio": "16:9",
  "resolution": "720p",
  "duration": 4,
  "credit_cost": 40,
  "video_url": "https://xxx.supabase.co/storage/v1/object/public/videos/...",
  "thumbnail_url": "https://xxx.supabase.co/storage/v1/object/public/videos/..."
}
```

#### å¤±è´¥å“åº” - Failed (200)

```json
{
  "task_id": "550e8400-e29b-41d4-a716-446655440000",
  "status": "failed",
  "created_at": "2025-01-18T10:00:00Z",
  "prompt": "A beautiful sunset...",
  "aspect_ratio": "16:9",
  "resolution": "720p",
  "duration": 4,
  "credit_cost": 40,
  "error_message": "Video generation failed due to API error",
  "error_code": "VEO_API_ERROR",
  "refund_confirmed": true
}
```

#### é”™è¯¯å“åº”

```json
// 400 - éæ³•ä»»åŠ¡ID
{
  "error": "INVALID_TASK_ID",
  "message": "Task ID must be a valid UUID"
}

// 403 - æ— æƒè®¿é—®
{
  "error": "UNAUTHORIZED_ACCESS",
  "message": "You do not have permission to access this task"
}

// 404 - ä»»åŠ¡ä¸å­˜åœ¨
{
  "error": "TASK_NOT_FOUND",
  "message": "Task with ID xxx not found"
}
```

---

## â±ï¸ è§†é¢‘å»¶é•¿åŠŸèƒ½ï¼ˆExtend Videoï¼‰

å°†å·²ç”Ÿæˆçš„Veoè§†é¢‘å»¶é•¿7ç§’ã€‚

### âš ï¸ é‡è¦é™åˆ¶

**è§†é¢‘æ¥æºé™åˆ¶**ï¼š
- âœ… **åªèƒ½å»¶é•¿Veoç”Ÿæˆçš„è§†é¢‘** - å¿…é¡»æ˜¯é€šè¿‡æœ¬å¹³å°Veo APIç”Ÿæˆçš„è§†é¢‘
- âŒ **ä¸æ”¯æŒå¤–éƒ¨ä¸Šä¼ çš„è§†é¢‘** - å³ä½¿æ ¼å¼ç¬¦åˆè¦æ±‚ä¹Ÿæ— æ³•å»¶é•¿
- âœ… **å¯ä»¥å»¶é•¿"å·²å»¶é•¿è¿‡çš„è§†é¢‘"** - æ”¯æŒå»¶é•¿é“¾ï¼ˆæœ€å¤š20æ¬¡ï¼‰

**æŠ€æœ¯é™åˆ¶**ï¼š
- â±ï¸ æ¯æ¬¡å›ºå®šå»¶é•¿**7ç§’**ï¼ˆæ— æ³•è‡ªå®šä¹‰æ—¶é•¿ï¼‰
- ğŸ“ è§†é¢‘æœ€é•¿**148ç§’**ï¼ˆè¶…è¿‡148ç§’æ— æ³•ç»§ç»­å»¶é•¿ï¼‰
- ğŸ“¹ åªæ”¯æŒ**720påˆ†è¾¨ç‡**ï¼ˆä¸æ”¯æŒ1080pï¼‰
- ğŸ¬ å®½é«˜æ¯”è‡ªåŠ¨ç»§æ‰¿æºè§†é¢‘ï¼ˆ16:9æˆ–9:16ï¼‰
- ğŸ‘¤ äººç‰©ç”Ÿæˆå›ºå®šä¸º`allow_all`

**å»¶é•¿æœºåˆ¶**ï¼š
- APIåˆ†ææºè§†é¢‘çš„**æœ€å1ç§’**ï¼ˆ24å¸§ï¼‰ä½œä¸ºå»¶ç»­ä¾æ®
- å¦‚æœæœ€å1ç§’æ²¡æœ‰è¯­éŸ³ï¼Œå»¶é•¿åçš„è¯­éŸ³æ•ˆæœä¼šä¸ä½³
- å»¶é•¿éƒ¨åˆ†ä¸æºè§†é¢‘æ— ç¼è¡”æ¥ï¼Œè¾“å‡ºä¸ºåˆå¹¶åçš„å®Œæ•´è§†é¢‘

### APIç«¯ç‚¹

**POST** `/api/v1/video/extend`

### è¯·æ±‚å‚æ•°

```json
{
  "source_video_id": "uuid-of-existing-video",
  "prompt": "æè¿°å»¶é•¿éƒ¨åˆ†çš„å†…å®¹...",
  "negative_prompt": "å¯é€‰çš„è´Ÿé¢æç¤ºè¯"
}
```

| å­—æ®µ | ç±»å‹ | å¿…éœ€ | è¯´æ˜ |
|-----|------|-----|------|
| `source_video_id` | string | âœ… | æºè§†é¢‘çš„æ•°æ®åº“IDï¼ˆvideo_generation_historyè¡¨çš„idï¼‰ |
| `prompt` | string | âœ… | å»¶é•¿éƒ¨åˆ†çš„æç¤ºè¯ï¼ˆå»ºè®®ä¸æºè§†é¢‘å†…å®¹è¿è´¯ï¼‰ |
| `negative_prompt` | string | âŒ | è´Ÿé¢æç¤ºè¯ |

### å›ºå®šå‚æ•°ï¼ˆç”±APIè‡ªåŠ¨è®¾ç½®ï¼‰

ä»¥ä¸‹å‚æ•°æ— æ³•è‡ªå®šä¹‰ï¼Œç”±ç³»ç»Ÿæ ¹æ®æºè§†é¢‘å’ŒAPIé™åˆ¶è‡ªåŠ¨è®¾ç½®ï¼š

- `resolution`: `720p`ï¼ˆå¼ºåˆ¶ï¼Œè§†é¢‘å»¶é•¿ä¸æ”¯æŒ1080pï¼‰
- `durationSeconds`: `8`ï¼ˆç”Ÿæˆ7ç§’æ–°å†…å®¹ + 1ç§’é‡å ï¼‰
- `aspectRatio`: ç»§æ‰¿æºè§†é¢‘çš„å®½é«˜æ¯”
- `personGeneration`: `allow_all`ï¼ˆå›ºå®šå€¼ï¼‰

### TypeScript è°ƒç”¨ç¤ºä¾‹

```typescript
async function extendVideo(sourceVideoId: string, prompt: string) {
  // 1. æ£€æŸ¥æºè§†é¢‘ä¿¡æ¯
  const sourceVideo = await getVideoById(sourceVideoId);

  if (sourceVideo.status !== 'completed') {
    throw new Error('æºè§†é¢‘æœªå®Œæˆç”Ÿæˆ');
  }

  if (sourceVideo.duration_seconds >= 148) {
    throw new Error('æºè§†é¢‘å·²è¾¾æœ€å¤§é•¿åº¦148ç§’ï¼Œæ— æ³•ç»§ç»­å»¶é•¿');
  }

  if (sourceVideo.duration_seconds + 7 > 148) {
    throw new Error('å»¶é•¿åå°†è¶…è¿‡æœ€å¤§é•¿åº¦148ç§’ï¼Œæ— æ³•å»¶é•¿');
  }

  if (!sourceVideo.gemini_video_uri) {
    throw new Error('æºè§†é¢‘ç¼ºå°‘Gemini URIï¼Œæ— æ³•å»¶é•¿');
  }

  // 2. åˆ›å»ºå»¶é•¿ä»»åŠ¡
  const response = await fetch('/api/v1/video/extend', {
    method: 'POST',
    headers: {
      'x-api-key': API_KEY,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      source_video_id: sourceVideoId,
      prompt: 'ç»§ç»­ä¹‹å‰çš„åœºæ™¯ï¼Œå¤ªé˜³å®Œå…¨å‡èµ·ï¼Œç…§äº®æ•´ä¸ªå±±è°·',
      negative_prompt: 'blurry, low quality'
    })
  });

  const { task_id, credit_cost } = await response.json();
  console.log(`å»¶é•¿ä»»åŠ¡å·²åˆ›å»ºï¼š${task_id}ï¼Œæ¶ˆè€—${credit_cost}ç§¯åˆ†`);

  // 3. è½®è¯¢çŠ¶æ€ï¼ˆåŒå¸¸è§„è§†é¢‘ç”Ÿæˆï¼‰
  const result = await pollVideoStatus(task_id);
  return result;
}
```

### æˆåŠŸå“åº” (200)

```json
{
  "success": true,
  "task_id": "new-task-uuid",
  "source_video_id": "original-video-uuid",
  "operation_id": "projects/.../operations/...",
  "status": "processing",
  "credit_cost": 40,
  "original_duration": 4,
  "new_duration": 11,
  "message": "è§†é¢‘å»¶é•¿ä»»åŠ¡å·²åˆ›å»ºï¼Œé¢„è®¡æ–°è§†é¢‘æ—¶é•¿11ç§’"
}
```

### é”™è¯¯å“åº”

```json
// 400 - æºè§†é¢‘å·²è¾¾æœ€å¤§é•¿åº¦
{
  "error": "SOURCE_VIDEO_TOO_LONG",
  "message": "Source video is 148s, cannot extend further (max 148s)"
}

// 400 - å»¶é•¿åå°†è¶…è¿‡æœ€å¤§é•¿åº¦
{
  "error": "EXTENSION_EXCEEDS_LIMIT",
  "message": "Extension would result in 155s video, exceeding maximum 148s"
}

// 400 - æºè§†é¢‘éVeoç”Ÿæˆ
{
  "error": "INVALID_SOURCE_VIDEO",
  "message": "Source video must be generated by Veo API"
}

// 404 - æºè§†é¢‘ä¸å­˜åœ¨
{
  "error": "SOURCE_VIDEO_NOT_FOUND",
  "message": "Source video with ID xxx not found"
}

// 400 - æºè§†é¢‘æœªå®Œæˆ
{
  "error": "SOURCE_VIDEO_NOT_READY",
  "message": "Source video is still processing or failed"
}
```

### UIå±•ç¤ºå»ºè®®

**æ˜¾ç¤ºå»¶é•¿æŒ‰é’®çš„æ¡ä»¶**ï¼š
```typescript
// åœ¨è§†é¢‘å¡ç‰‡ä¸Šæ˜¾ç¤º"å»¶é•¿"æŒ‰é’®
function shouldShowExtendButton(video: VideoRecord) {
  return (
    video.status === 'completed' &&           // ç”ŸæˆæˆåŠŸ
    video.resolution === '720p' &&            // ğŸ”¥ åªæ”¯æŒ720pï¼ˆ1080péšè—æ­¤åŠŸèƒ½ï¼‰
    video.duration_seconds + 7 <= 148 &&      // å»¶é•¿åä¸è¶…è¿‡148ç§’
    video.gemini_video_uri !== null           // æœ‰Gemini URI
  );
}

// ğŸ’¡ ä¸šåŠ¡è§„åˆ™è¯´æ˜ï¼š
// - å½“å‰APIåªæ”¯æŒ720pè§†é¢‘å»¶é•¿ï¼Œ1080pè§†é¢‘ä¸æ˜¾ç¤ºå»¶é•¿æŒ‰é’®
// - åç»­APIæ”¯æŒ1080på»¶é•¿åï¼Œåªéœ€ç§»é™¤ resolution === '720p' æ¡ä»¶å³å¯
```

**å»¶é•¿é“¾å¯è§†åŒ–**ï¼š
```typescript
// åœ¨å†å²è®°å½•ä¸­æ˜¾ç¤ºå»¶é•¿é“¾å…³ç³»
interface VideoWithExtendChain {
  id: string;
  duration: number;
  source_video_id: string | null;  // æŒ‡å‘æºè§†é¢‘
  extend_count: number;             // ç¬¬å‡ æ¬¡å»¶é•¿
}

// ç¤ºä¾‹ï¼š4ç§’ â†’ 11ç§’ â†’ 18ç§’ â†’ ... â†’ 144ç§’
// [åŸå§‹è§†é¢‘] â†’ [å»¶é•¿1æ¬¡] â†’ [å»¶é•¿2æ¬¡] â†’ ... â†’ [å»¶é•¿20æ¬¡]
```

### å»¶é•¿é“¾æœ€ä½³å®è·µ

**æ¸è¿›å¼å»¶é•¿ç­–ç•¥**ï¼š
```typescript
// è§„åˆ’å»¶é•¿é“¾ï¼Œç¡®ä¿å†…å®¹è¿è´¯
const extendChain = [
  { duration: 4,  prompt: "æ—¥å‡ºæ—¶çš„å±±æ™¯ï¼Œæ™¨é›¾ç¼­ç»•" },
  { duration: 11, prompt: "å¤ªé˜³é€æ¸å‡èµ·ï¼Œé›¾æ°”å¼€å§‹æ¶ˆæ•£" },
  { duration: 18, prompt: "é˜³å…‰ç…§äº®å±±è°·ï¼Œé¸Ÿå„¿å¼€å§‹é¸£å«" },
  { duration: 25, prompt: "å®Œå…¨çš„ç™½æ˜¼ï¼Œå±±è°·å……æ»¡ç”Ÿæœº" }
];

// âœ… å¥½çš„å»¶é•¿æç¤ºè¯ï¼šå†…å®¹è¿è´¯ã€åœºæ™¯å»¶ç»­
// âŒ é¿å…ï¼šçªç„¶çš„åœºæ™¯åˆ‡æ¢ã€ä¸ç›¸å…³çš„å†…å®¹
```

---

## ğŸ’° ç§¯åˆ†æ¶ˆè´¹è§„åˆ™

### è®¡ç®—å…¬å¼

```
åŸºç¡€ç§¯åˆ† = æ—¶é•¿(ç§’) Ã— 10
å®é™…æ¶ˆè´¹ = åŸºç¡€ç§¯åˆ† Ã— åˆ†è¾¨ç‡ç³»æ•°

åˆ†è¾¨ç‡ç³»æ•°:
- 720p: 1.0x
- 1080p: 1.5x
```

### ä»·æ ¼è¡¨

**å¸¸è§„ç”Ÿæˆ**ï¼š

| æ—¶é•¿ | 720p | 1080p |
|-----|------|-------|
| 4ç§’ | 40ç§¯åˆ† | 60ç§¯åˆ† |
| 6ç§’ | 60ç§¯åˆ† | 90ç§¯åˆ† |
| 8ç§’ | 80ç§¯åˆ† | 120ç§¯åˆ† |

**è§†é¢‘å»¶é•¿**ï¼š

| æ“ä½œ | 720pï¼ˆå›ºå®šï¼‰ | è¯´æ˜ |
|-----|-------------|------|
| å»¶é•¿7ç§’ | 40ç§¯åˆ† | å›ºå®šä»·æ ¼ï¼Œä¸æ”¯æŒ1080p |

ğŸ’¡ **å»¶é•¿é“¾æˆæœ¬è®¡ç®—ç¤ºä¾‹**ï¼š
- 4ç§’åŸºç¡€è§†é¢‘ï¼š40ç§¯åˆ†
- å»¶é•¿åˆ°11ç§’ï¼š+40ç§¯åˆ† = **80ç§¯åˆ†æ€»è®¡**
- å»¶é•¿åˆ°18ç§’ï¼š+40ç§¯åˆ† = **120ç§¯åˆ†æ€»è®¡**
- å»¶é•¿åˆ°25ç§’ï¼š+40ç§¯åˆ† = **160ç§¯åˆ†æ€»è®¡**
- ...
- å»¶é•¿åˆ°144ç§’ï¼ˆ20æ¬¡ï¼‰ï¼š**840ç§¯åˆ†æ€»è®¡** (40 + 40Ã—20)

### é€€æ¬¾æ”¿ç­–

- âœ… **å¤±è´¥è‡ªåŠ¨é€€æ¬¾**ï¼šä»»åŠ¡å¤±è´¥æ—¶ç§¯åˆ†100%é€€è¿˜
- âœ… **è¶…æ—¶é€€æ¬¾**ï¼šç”Ÿæˆè¶…è¿‡10åˆ†é’Ÿè‡ªåŠ¨æ ‡è®°å¤±è´¥å¹¶é€€æ¬¾
- âœ… **ä¸‹è½½å¤±è´¥é€€æ¬¾**ï¼šè§†é¢‘ä¸‹è½½å¤±è´¥æ—¶é€€æ¬¾

---

## ğŸ“ ä½¿ç”¨æµç¨‹

### å®Œæ•´ç¤ºä¾‹ï¼ˆcURLï¼‰

```bash
# 1. åˆ›å»ºè§†é¢‘ç”Ÿæˆä»»åŠ¡
TASK_ID=$(curl -X POST https://nanobanana.com/api/v1/video/generate \
  -H "x-api-key: YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "prompt": "A serene mountain landscape at dawn with mist rolling over the peaks",
    "aspect_ratio": "16:9",
    "resolution": "1080p",
    "duration": 6
  }' | jq -r '.task_id')

echo "ä»»åŠ¡ID: $TASK_ID"

# 2. è½®è¯¢ä»»åŠ¡çŠ¶æ€ï¼ˆæ¯10ç§’æ£€æŸ¥ä¸€æ¬¡ï¼‰
while true; do
  STATUS=$(curl -H "x-api-key: YOUR_API_KEY" \
    https://nanobanana.com/api/v1/video/status/$TASK_ID | jq -r '.status')

  echo "å½“å‰çŠ¶æ€: $STATUS"

  if [ "$STATUS" = "completed" ]; then
    echo "âœ… è§†é¢‘ç”Ÿæˆå®Œæˆï¼"
    curl -H "x-api-key: YOUR_API_KEY" \
      https://nanobanana.com/api/v1/video/status/$TASK_ID | jq '.video_url'
    break
  elif [ "$STATUS" = "failed" ]; then
    echo "âŒ è§†é¢‘ç”Ÿæˆå¤±è´¥"
    curl -H "x-api-key: YOUR_API_KEY" \
      https://nanobanana.com/api/v1/video/status/$TASK_ID | jq '.error_message'
    break
  fi

  sleep 10
done
```

### JavaScript/TypeScript ç¤ºä¾‹

```typescript
async function generateVideo() {
  const API_KEY = 'your_api_key';
  const BASE_URL = 'https://nanobanana.com';

  // 1. åˆ›å»ºä»»åŠ¡
  const createResponse = await fetch(`${BASE_URL}/api/v1/video/generate`, {
    method: 'POST',
    headers: {
      'x-api-key': API_KEY,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      prompt: 'A beautiful sunset over the ocean',
      aspect_ratio: '16:9',
      resolution: '720p',
      duration: 4,
    }),
  });

  const { task_id } = await createResponse.json();
  console.log('ä»»åŠ¡ID:', task_id);

  // 2. è½®è¯¢çŠ¶æ€
  while (true) {
    await new Promise((r) => setTimeout(r, 10000)); // ç­‰å¾…10ç§’

    const statusResponse = await fetch(
      `${BASE_URL}/api/v1/video/status/${task_id}`,
      {
        headers: { 'x-api-key': API_KEY },
      }
    );

    const status = await statusResponse.json();
    console.log('çŠ¶æ€:', status.status);

    if (status.status === 'completed') {
      console.log('âœ… è§†é¢‘URL:', status.video_url);
      break;
    } else if (status.status === 'failed') {
      console.error('âŒ å¤±è´¥:', status.error_message);
      break;
    }
  }
}
```

---

## âš ï¸ é”™è¯¯å¤„ç†

### å¸¸è§é”™è¯¯ç 

| é”™è¯¯ç  | HTTPçŠ¶æ€ | è¯´æ˜ | è§£å†³æ–¹æ¡ˆ |
|--------|---------|------|---------|
| `MISSING_API_KEY` | 401 | ç¼ºå°‘API Key | åœ¨è¯·æ±‚å¤´æ·»åŠ  `x-api-key` |
| `INVALID_API_KEY` | 401 | API Keyæ— æ•ˆ | æ£€æŸ¥API Keyæ˜¯å¦æ­£ç¡® |
| `INSUFFICIENT_CREDITS` | 402 | ç§¯åˆ†ä¸è¶³ | è´­ä¹°ç§¯åˆ†åŒ…æˆ–è®¢é˜… |
| `CONCURRENT_LIMIT_EXCEEDED` | 429 | å¹¶å‘è¶…é™ | ç­‰å¾…ç°æœ‰ä»»åŠ¡å®Œæˆ |
| `INVALID_TASK_ID` | 400 | ä»»åŠ¡IDæ ¼å¼é”™è¯¯ | ä½¿ç”¨æœ‰æ•ˆçš„UUID |
| `TASK_NOT_FOUND` | 404 | ä»»åŠ¡ä¸å­˜åœ¨ | æ£€æŸ¥task_idæ˜¯å¦æ­£ç¡® |
| `UNAUTHORIZED_ACCESS` | 403 | æ— æƒè®¿é—® | åªèƒ½æŸ¥è¯¢è‡ªå·±çš„ä»»åŠ¡ |
| `VEO_API_ERROR` | 503 | Google Veo APIé”™è¯¯ | å·²è‡ªåŠ¨é€€æ¬¾ï¼Œç¨åé‡è¯• |

---

## ğŸ”§ ç¯å¢ƒé…ç½®

### å¿…éœ€ç¯å¢ƒå˜é‡

```bash
# Google AI API Key
GOOGLE_AI_API_KEY=your_google_ai_api_key

# Supabase é…ç½®
NEXT_PUBLIC_SUPABASE_URL=https://xxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=xxx
SUPABASE_SERVICE_ROLE_KEY=xxx

# Cron ä»»åŠ¡å¯†é’¥
CRON_SECRET=your_random_secret_key

# åº”ç”¨URLï¼ˆç”¨äºè§¦å‘ä¸‹è½½ä»»åŠ¡ï¼‰
NEXT_PUBLIC_APP_URL=https://nanobanana.com
```

### Vercel éƒ¨ç½²é…ç½®

ç¡®ä¿ `vercel.json` åŒ…å« Cron ä»»åŠ¡é…ç½®ï¼š

```json
{
  "crons": [
    {
      "path": "/api/cron/poll-video-status",
      "schedule": "* * * * *"
    }
  ]
}
```

---

## ğŸ§ª æµ‹è¯•æŒ‡å—

### è¿è¡Œé›†æˆæµ‹è¯•

```bash
# 1. é…ç½®æµ‹è¯• API Key
export TEST_API_KEY=your_test_api_key

# 2. è¿è¡Œæµ‹è¯•è„šæœ¬
pnpm ts-node scripts/test-video-generation.ts
```

### æµ‹è¯•å†…å®¹

- âœ… åˆ›å»ºè§†é¢‘ç”Ÿæˆä»»åŠ¡
- âœ… æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€
- âœ… å‚æ•°éªŒè¯ï¼ˆç¼ºå°‘å¿…éœ€å­—æ®µï¼‰
- âœ… éæ³•å‚æ•°æ‹’ç»ï¼ˆaspect_ratio, durationï¼‰
- âœ… éæ³•ä»»åŠ¡IDéªŒè¯
- âœ… API KeyéªŒè¯

### æ‰‹åŠ¨æµ‹è¯•

```bash
# åˆ›å»ºä»»åŠ¡
curl -X POST http://localhost:3000/api/v1/video/generate \
  -H "x-api-key: YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "prompt": "A cat playing with a ball",
    "aspect_ratio": "16:9",
    "resolution": "720p",
    "duration": 4
  }'

# æŸ¥è¯¢çŠ¶æ€
curl -H "x-api-key: YOUR_API_KEY" \
  http://localhost:3000/api/v1/video/status/TASK_ID
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Google Veo 3.1 API æ–‡æ¡£](https://ai.google.dev/gemini-api/docs/veo)
- [Supabase Storage æ–‡æ¡£](https://supabase.com/docs/guides/storage)
- [Vercel Cron Jobs æ–‡æ¡£](https://vercel.com/docs/cron-jobs)

---

## ğŸ› æ•…éšœæ’æŸ¥

### ä»»åŠ¡ä¸€ç›´å¤„äº processing çŠ¶æ€

**åŸå› **ï¼šCron ä»»åŠ¡æœªè¿è¡Œæˆ–è½®è¯¢å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥ Vercel Cron ä»»åŠ¡æ—¥å¿—
2. æ‰‹åŠ¨è§¦å‘ Cron ä»»åŠ¡æµ‹è¯•ï¼š
   ```bash
   curl -X GET http://localhost:3000/api/cron/poll-video-status \
     -H "authorization: Bearer YOUR_CRON_SECRET"
   ```

### è§†é¢‘ä¸‹è½½å¤±è´¥

**åŸå› **ï¼šGoogle ä¸´æ—¶ URL è¿‡æœŸæˆ–ç½‘ç»œé—®é¢˜

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥ `temporary_video_url` æ˜¯å¦æœ‰æ•ˆ
2. æŸ¥çœ‹ä¸‹è½½ä»»åŠ¡æ—¥å¿—ï¼š`/api/cron/download-video`
3. ä»»åŠ¡ä¼šè‡ªåŠ¨æ ‡è®°ä¸ºå¤±è´¥å¹¶é€€æ¬¾

### ç§¯åˆ†æœªé€€æ¬¾

**åŸå› **ï¼šé€€æ¬¾é€»è¾‘æœªæ‰§è¡Œæˆ–é‡å¤é€€æ¬¾éªŒè¯å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥ `credit_transactions` è¡¨æ˜¯å¦æœ‰ `video_refund` è®°å½•
2. æŸ¥çœ‹ `refundFailedTask()` æ–¹æ³•æ—¥å¿—
3. æ‰‹åŠ¨è§¦å‘é€€æ¬¾ï¼ˆä»…ç®¡ç†å‘˜ï¼‰

---

**æœ€åæ›´æ–°**: 2025-01-18
**ç‰ˆæœ¬**: 1.0.0
