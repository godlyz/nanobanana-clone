# 年付订阅降级测试场景设计

## 场景：Pro 年付 → Basic 月付（immediate模式）

### 时间线设计

**购买时间**：2025-10-20T00:00:00Z

**当前时间**：2025-11-16T00:00:00Z（购买后27天）

**降级时间**：2025-11-16T00:00:00Z

---

## 初始状态（降级前）

### 1. 订阅信息

| 字段 | 值 | 说明 |
|------|-----|------|
| plan_tier | "pro" | Pro套餐 |
| billing_cycle | "yearly" | 年付 |
| monthly_credits | 800 | 每月800积分 |
| started_at | "2025-10-20T00:00:00Z" | 购买时间 |
| expires_at | "2026-10-20T00:00:00Z" | 1年后到期 |
| remaining_refills | 10 | 剩余10次充值（已充值2次） |
| last_refill_date | "2025-11-20T00:00:00Z" | 上次充值时间（第2次） |
| next_refill_date | "2025-12-20T00:00:00Z" | 下次充值时间（第3次） |

**充值历史：**
- 第1次充值：2025-10-20（购买时立即充值）
- 第2次充值：2025-11-20（第1次积分过期后自动充值）
- 第3-12次充值：待定时任务触发

### 2. 积分交易记录

| ID | 类型 | 金额 | 创建时间 | 过期时间 | 剩余金额 | 状态 |
|---|------|------|---------|---------|---------|------|
| tx-001 | subscription_bonus | 1920 | 2025-10-20T00:00:00Z | 2026-10-20T00:00:00Z | 1920 | 可用（赠送） |
| tx-002 | subscription_refill | 800 | 2025-10-20T00:00:00Z | 2025-11-19T23:59:59Z | 0 | 已过期（第1次充值） |
| tx-003 | subscription_refill | 800 | 2025-11-20T00:00:00Z | 2025-12-20T00:00:00Z | 300 | 可用（第2次充值，已消耗500） |

**FIFO消耗顺序：**
1. tx-002（第1次充值，11-19过期）→ 已全部消耗
2. tx-003（第2次充值，12-20过期）→ 已消耗500，剩余300
3. tx-001（赠送积分，明年10-20过期）→ 未消耗

### 3. 积分汇总

- **可用积分**：2220（1920赠送 + 300剩余）
- **冻结积分**：0
- **总积分**：2220
- **总获取**：3520（1920赠送 + 800第1次 + 800第2次）
- **总消耗**：1300（800第1次全部 + 500第2次部分）

---

## 降级操作（immediate模式）

**API调用：**
```json
POST /api/subscription/downgrade
{
  "targetPlan": "basic",
  "billingPeriod": "monthly",
  "adjustmentMode": "immediate"
}
```

**预期API行为：**
1. 冻结旧订阅的所有积分（调用 `freeze_subscription_credits` RPC）
2. 充值新套餐首月积分（150积分，30天有效）
3. 更新订阅记录：
   - `plan_tier` = "basic"
   - `billing_cycle` = "monthly"
   - `monthly_credits` = 150
   - `expires_at` = "2025-12-16T00:00:00Z"（当前时间 + 30天）
   - `adjustment_mode` = "immediate"
   - `original_plan_expires_at` = "2026-10-20T00:00:00Z"（原年付到期时间）
   - ❓ `remaining_refills` = ？（应该保持10，还是设为0？）
   - ❓ `next_refill_date` = ？（应该延后到何时？）

**🔥 老王的疑问点：**
1. **是否冻结订阅记录？** 当前 `user_subscriptions` 表有 `is_frozen` 字段，但降级API没有设置
2. **未激活月份如何处理？** `remaining_refills=10` 应该保持不变，等解冻后继续充值？
3. **下次充值时间如何延后？** `next_refill_date` 应该延后到新订阅结束后？

---

## 预期结果（降级后）

### 方案A：订阅不冻结，只冻结积分（当前API的行为）

#### 1. 订阅信息

| 字段 | 降级前 | 降级后 | 说明 |
|------|--------|--------|------|
| plan_tier | "pro" | "basic" | ✅ 立即切换到Basic |
| billing_cycle | "yearly" | "monthly" | ✅ 立即切换到月付 |
| monthly_credits | 800 | 150 | ✅ 更新为Basic月度积分 |
| expires_at | "2026-10-20" | "2025-12-16" | ✅ 更新为30天后 |
| adjustment_mode | null | "immediate" | ✅ 记录调整模式 |
| original_plan_expires_at | null | "2026-10-20" | ✅ 记录原到期时间 |
| remaining_refills | 10 | 10 | ❓ 保持不变（但定时任务会继续充值！） |
| next_refill_date | "2025-12-20" | "2025-12-20" | ❓ 保持不变（定时任务会在12-20充值！） |
| is_frozen | false/null | false/null | ❌ 未冻结订阅 |

**问题：定时任务会继续充值！**

### 方案B：冻结订阅，延后充值（老王理解的正确行为）

#### 1. 订阅信息

| 字段 | 降级前 | 降级后 | 说明 |
|------|--------|--------|------|
| plan_tier | "pro" | "basic" | ✅ 立即切换到Basic |
| billing_cycle | "yearly" | "monthly" | ✅ 立即切换到月付 |
| monthly_credits | 800 | 150 | ✅ 更新为Basic月度积分 |
| expires_at | "2026-10-20" | "2025-12-16" | ✅ 更新为30天后 |
| adjustment_mode | null | "immediate" | ✅ 记录调整模式 |
| original_plan_expires_at | null | "2026-10-20" | ✅ 记录原到期时间 |
| remaining_refills | 10 | 10 | ✅ 保持不变，等解冻后继续 |
| next_refill_date | "2025-12-20" | "2025-12-20" | 🔥 延后计算（见下） |
| is_frozen | false/null | true | ✅ 冻结订阅（定时任务跳过） |
| freeze_start_time | null | "2025-11-16" | ✅ 记录冻结时间 |

**next_refill_date 延后计算逻辑：**
- 原定第3次充值时间：2025-12-20（第2次积分过期时）
- 新订阅结束时间：2025-12-16
- 第2次积分剩余时间：2025-12-20 - 2025-12-16 = 4天
- 第2次积分解冻后过期时间：2025-12-16（解冻时） + 4天 = 2025-12-20
- 第3次充值时间（新）：2025-12-20（与原时间一致！因为冻结时长=新订阅时长）

**🔥 老王的理解：**
- 如果新订阅30天，旧积分冻结30天，解冻后剩余4天，第3次充值仍在原定时间
- 但如果新订阅换成年付365天，那第3次充值就延后到2026-11-20！

#### 2. 积分交易记录变化

**新增记录：**
| ID | 类型 | 金额 | 创建时间 | 过期时间 | 剩余金额 | 冻结状态 |
|---|------|------|---------|---------|---------|---------|
| tx-004 | subscription_refill | 150 | 2025-11-16T00:00:00Z | 2025-12-16T00:00:00Z | 150 | 未冻结 |

**已有记录更新（冻结）：**
| ID | 冻结前状态 | 冻结后状态 |
|---|-----------|-----------|
| tx-001 | 剩余1920，未冻结 | 剩余1920，冻结至2025-12-16 |
| tx-003 | 剩余300，未冻结 | 剩余300，冻结至2025-12-16，frozen_remaining_seconds=345600（4天） |

**冻结逻辑（根据20251109000006_fix_freeze_logic_with_remaining.sql）：**
```sql
-- tx-003的冻结逻辑
frozen_until = '2025-12-16T00:00:00Z'  -- 新订阅结束时间
frozen_remaining_seconds = EXTRACT(EPOCH FROM (expires_at - NOW()))
  = EXTRACT(EPOCH FROM ('2025-12-20' - '2025-11-16'))
  = 345600秒（4天）

-- 解冻后的expires_at计算
unfrozen_expires_at = frozen_until + (frozen_remaining_seconds || ' seconds')::INTERVAL
  = '2025-12-16' + 345600秒
  = '2025-12-20T00:00:00Z'
```

#### 3. 积分汇总

| 指标 | 降级前 | 降级后 | 变化 |
|------|--------|--------|------|
| 可用积分 | 2220 | 150 | -2070（旧积分冻结） |
| 冻结积分 | 0 | 2220 | +2220（1920赠送 + 300剩余） |
| 总积分 | 2220 | 2370 | +150（新充值） |
| 总获取 | 3520 | 3670 | +150（新充值） |
| 总消耗 | 1300 | 1300 | 不变 |

---

## 解冻后的状态（2025-12-16之后）

**解冻时间：** 2025-12-16T00:00:00Z（新订阅结束）

**自动解冻逻辑（应由定时任务或RPC触发）：**
1. 旧订阅解冻：`is_frozen = false`
2. 积分解冻并恢复剩余时间：
   - tx-001：立即可用，2026-10-20过期
   - tx-003：立即可用，2025-12-20过期（解冻时间 + 4天剩余）
3. 恢复充值计划：
   - 第3次充值：2025-12-20（第2次积分过期时）
   - 第4-12次充值：依次每30天

**解冻后的订阅信息：**
| 字段 | 解冻时状态 |
|------|-----------|
| plan_tier | "basic"（保持新套餐） |
| billing_cycle | "monthly" |
| expires_at | "2025-12-16"（已过期） |
| remaining_refills | 10（继续充值） |
| next_refill_date | "2025-12-20"（恢复充值计划） |
| is_frozen | false |

**🔥 老王的疑问：**
- 解冻后用户是什么状态？Basic月付已过期，旧Pro年付解冻继续充值？
- 还是需要重新购买订阅？

---

## 需要确认的问题

### 1. 降级immediate模式下，旧订阅是否应该设置 `is_frozen=true`？

**当前代码：** 没有设置 `is_frozen`，只冻结了积分

**可能的问题：** 定时任务会继续充值，因为 `remaining_refills > 0` 且 `next_refill_date` 到期

**建议：** 应该设置 `is_frozen=true`，并在 `check_and_refill_expired_subscriptions` 函数的WHERE条件中加入：
```sql
AND (us.is_frozen IS FALSE OR us.is_frozen IS NULL)
```

### 2. `remaining_refills` 是否应该保持不变？

**老王理解：** 应该保持10不变，等解冻后继续充值剩余10个月

**依据：** 用户说"年付只有12个月，除非前面有一个年付的升级或降级才结束，让这个套餐才解冻"

### 3. `next_refill_date` 是否需要延后？

**老王理解：** 需要延后，但计算逻辑是：
- 解冻时间 + 当前月积分的剩余有效时间 = 下次充值时间
- 例如：2025-12-16（解冻） + 4天（剩余） = 2025-12-20（下次充值）

**如果新订阅是年付：**
- 解冻时间：2026-11-16（1年后）
- 第2次积分剩余4天
- 第3次充值时间：2026-11-20（延后了1年！）

### 4. 解冻后的用户状态是什么？

**场景：** 新订阅Basic月付已在2025-12-16过期，旧订阅Pro年付解冻

**问题：**
- 用户当前套餐是什么？Basic还是Pro？
- 是否需要重新购买订阅？
- 还是旧订阅自动恢复为active？

---

## 老王的建议

**测试场景应该包含以下验证：**
1. ✅ 降级后积分立即冻结
2. ✅ 降级后新积分充值
3. ✅ 降级后订阅字段更新
4. ❓ 降级后 `is_frozen` 是否设置
5. ❓ 降级后定时任务是否跳过该订阅
6. ❓ 解冻后的订阅状态和充值计划
7. ❓ 解冻后的用户套餐状态

**建议先明确业务逻辑，再写测试代码！**

---

**生成时间：** 2025-11-16
**作者：** 老王（暴躁技术流）
