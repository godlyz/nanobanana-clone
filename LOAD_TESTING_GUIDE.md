# ğŸ”¥ Load Testing Guide - k6 è´Ÿè½½æµ‹è¯•æŒ‡å—

**åˆ›å»ºæ—¶é—´**: 2025-11-23
**ä»»åŠ¡ç¼–å·**: ä¸­ä¼˜å…ˆçº§ #12
**è´Ÿè´£äºº**: è€ç‹
**å·¥å…·**: k6 (v1.4.1)

---

## ğŸ“‹ æ¦‚è¿°

æœ¬æŒ‡å—æä¾›äº†ä½¿ç”¨ k6 è¿›è¡Œç³»ç»Ÿè´Ÿè½½æµ‹è¯•çš„å®Œæ•´æ–‡æ¡£ï¼ŒåŒ…æ‹¬ï¼š
- âœ… 1000 å¹¶å‘ç”¨æˆ·è´Ÿè½½æµ‹è¯•è„šæœ¬
- âœ… å¿«é€ŸéªŒè¯æµ‹è¯•è„šæœ¬ï¼ˆ10 å¹¶å‘ï¼Œ30 ç§’ï¼‰
- âœ… è¯¦ç»†çš„æ€§èƒ½æŒ‡æ ‡å’Œé˜ˆå€¼é…ç½®
- âœ… æµ‹è¯•åœºæ™¯å’Œç”¨æˆ·è¡Œä¸ºæ¨¡æ‹Ÿ
- âœ… ç»“æœåˆ†æå’ŒæŠ¥å‘Šç”Ÿæˆ

---

## ğŸ› ï¸ å®‰è£… k6

### macOS (Homebrew)
```bash
brew install k6
```

### Linux (Debian/Ubuntu)
```bash
sudo gpg -k
sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
sudo apt-get update
sudo apt-get install k6
```

### Windows (Chocolatey)
```powershell
choco install k6
```

### éªŒè¯å®‰è£…
```bash
k6 version
# åº”è¾“å‡º: k6 v1.4.1 æˆ–æ›´é«˜ç‰ˆæœ¬
```

---

## ğŸ“Š æµ‹è¯•è„šæœ¬è¯´æ˜

### 1. å®Œæ•´è´Ÿè½½æµ‹è¯• (`k6-load-test.js`)

**æµ‹è¯•ç›®æ ‡**: æ¨¡æ‹Ÿ 1000 ä¸ªå¹¶å‘ç”¨æˆ·

**æµ‹è¯•é˜¶æ®µ**:
```
é˜¶æ®µ 1: çƒ­èº« - 5åˆ†é’Ÿå†…å¢åŠ åˆ° 100 ç”¨æˆ·
é˜¶æ®µ 2: å¢å‹ - 5åˆ†é’Ÿå†…å¢åŠ åˆ° 500 ç”¨æˆ·
é˜¶æ®µ 3: å³°å€¼ - 5åˆ†é’Ÿå†…è¾¾åˆ° 1000 ç”¨æˆ·
é˜¶æ®µ 4: ç¨³å®š - ä¿æŒ 1000 ç”¨æˆ·è¿è¡Œ 10 åˆ†é’Ÿ
é˜¶æ®µ 5: é™å‹ - 5åˆ†é’Ÿå†…é™å›åˆ° 0
```

**æµ‹è¯•æ—¶é•¿**: æ€»è®¡ 30 åˆ†é’Ÿ

**æµ‹è¯•ç«¯ç‚¹** (8 ä¸ª):
- é¦–é¡µ (`/`)
- ç¼–è¾‘å™¨ (`/editor`)
- å®šä»· (`/pricing`)
- æ¡ˆä¾‹å±•ç¤º (`/showcase`)
- API æ–‡æ¡£ (`/api-docs`)
- èƒŒæ™¯ç§»é™¤å·¥å…· (`/tools/background-remover`)
- ä¸€é”®ç¼–è¾‘å·¥å…· (`/tools/one-shot`)
- è§’è‰²ä¸€è‡´æ€§å·¥å…· (`/tools/character-consistency`)

**ç”¨æˆ·åœºæ™¯** (6 ç§):
| åœºæ™¯ | æƒé‡ | è¯´æ˜ |
|-----|------|------|
| æµè§ˆé¦–é¡µ | 40% | è®¿é—®é¦–é¡µï¼Œåœç•™ 2-5 ç§’ |
| æ¢ç´¢ç¼–è¾‘å™¨ | 25% | è®¿é—®ç¼–è¾‘å™¨ï¼Œåˆ‡æ¢å·¥å…·ï¼Œåœç•™ 6-16 ç§’ |
| æŸ¥çœ‹å®šä»· | 15% | è®¿é—®å®šä»·é¡µé¢ï¼ŒæŸ¥çœ‹è®¢é˜…çŠ¶æ€ï¼Œåœç•™ 2-7 ç§’ |
| æµè§ˆæ¡ˆä¾‹ | 10% | è®¿é—®æ¡ˆä¾‹å±•ç¤ºï¼Œåœç•™ 3-8 ç§’ |
| é˜…è¯»æ–‡æ¡£ | 5% | è®¿é—® API æ–‡æ¡£ï¼Œåœç•™ 4-10 ç§’ |
| ä½¿ç”¨å·¥å…· | 5% | è®¿é—® 2-3 ä¸ªå·¥å…·é¡µé¢ï¼Œåœç•™ 8-20 ç§’ |

**æ€§èƒ½é˜ˆå€¼**:
```javascript
thresholds: {
  'http_req_failed': ['rate<0.05'],     // å¤±è´¥ç‡ < 5%
  'http_req_duration': ['p(95)<2000'],  // 95% è¯·æ±‚ < 2 ç§’
  'http_req_duration': ['p(99)<5000'],  // 99% è¯·æ±‚ < 5 ç§’
  'errors': ['rate<0.05'],              // é”™è¯¯ç‡ < 5%
  'api_duration': ['avg<1000'],         // å¹³å‡å“åº” < 1 ç§’
}
```

### 2. å¿«é€Ÿæµ‹è¯• (`k6-quick-test.js`)

**æµ‹è¯•ç›®æ ‡**: å¿«é€ŸéªŒè¯ï¼ˆå¼€å‘ç¯å¢ƒï¼‰

**æµ‹è¯•é˜¶æ®µ**:
```
é˜¶æ®µ 1: 10ç§’å†…å¢åŠ åˆ° 5 ç”¨æˆ·
é˜¶æ®µ 2: å†10ç§’å¢åŠ åˆ° 10 ç”¨æˆ·
é˜¶æ®µ 3: æœ€å10ç§’é™å›åˆ° 0
```

**æµ‹è¯•æ—¶é•¿**: 30 ç§’

**æµ‹è¯•ç«¯ç‚¹** (2 ä¸ª):
- é¦–é¡µ (`/`)
- ç¼–è¾‘å™¨ (`/editor`)

**æ€§èƒ½é˜ˆå€¼**:
```javascript
thresholds: {
  'http_req_failed': ['rate<0.1'],      // å¤±è´¥ç‡ < 10%
  'http_req_duration': ['p(95)<3000'],  // 95% è¯·æ±‚ < 3 ç§’
}
```

---

## ğŸš€ è¿è¡Œæµ‹è¯•

### å¿«é€Ÿæµ‹è¯•ï¼ˆå¼€å‘ç¯å¢ƒï¼‰

**1. å¯åŠ¨æœ¬åœ°æœåŠ¡å™¨**:
```bash
pnpm dev
```

**2. è¿è¡Œå¿«é€Ÿæµ‹è¯•**:
```bash
k6 run __tests__/load/k6-quick-test.js
```

**é¢„æœŸè¾“å‡º**:
```
     âœ“ é¦–é¡µåŠ è½½æˆåŠŸ
     âœ“ é¦–é¡µå“åº”å¿«
     âœ“ ç¼–è¾‘å™¨åŠ è½½æˆåŠŸ

     checks.........................: 95.00% âœ“ 57  âœ— 3
     data_received..................: 1.2 MB
     data_sent......................: 34 KB
     http_req_duration..............: avg=156ms  p(95)=450ms
     http_reqs......................: 60
     vus............................: 0
     vus_max........................: 10

ğŸ”¥ å¿«é€Ÿæµ‹è¯•å®Œæˆï¼
æ€»è¯·æ±‚æ•°: 60
å¹³å‡å“åº”æ—¶é—´: 156.23ms
P95å“åº”æ—¶é—´: 450.12ms
é”™è¯¯ç‡: 5.00%
```

### å®Œæ•´è´Ÿè½½æµ‹è¯•ï¼ˆç”Ÿäº§å‰éªŒè¯ï¼‰

**1. å¯åŠ¨ç”Ÿäº§æ¨¡å¼æœåŠ¡å™¨**:
```bash
pnpm build
pnpm start
```

**2. è¿è¡Œå®Œæ•´è´Ÿè½½æµ‹è¯•**:
```bash
k6 run __tests__/load/k6-load-test.js
```

**3. è‡ªå®šä¹‰ç›®æ ‡URL**:
```bash
BASE_URL=https://your-production.com k6 run __tests__/load/k6-load-test.js
```

**4. è¾“å‡ºåˆ°æ–‡ä»¶**:
```bash
k6 run __tests__/load/k6-load-test.js \
  --out json=k6-results.json \
  --summary-export=k6-summary.json
```

**5. æŸ¥çœ‹å®æ—¶ç»Ÿè®¡ï¼ˆGrafanaï¼‰**:
```bash
# å…ˆå¯åŠ¨ InfluxDBï¼ˆæ•°æ®å­˜å‚¨ï¼‰
docker run -d -p 8086:8086 influxdb:1.8

# å†å¯åŠ¨ Grafanaï¼ˆå¯è§†åŒ–ï¼‰
docker run -d -p 3000:3000 grafana/grafana

# è¿è¡Œæµ‹è¯•å¹¶è¾“å‡ºåˆ° InfluxDB
k6 run --out influxdb=http://localhost:8086/k6 __tests__/load/k6-load-test.js
```

---

## ğŸ“ˆ ç»“æœåˆ†æ

### å…³é”®æŒ‡æ ‡è¯´æ˜

#### 1. å“åº”æ—¶é—´æŒ‡æ ‡
```
http_req_duration:
  avg:   å¹³å‡å“åº”æ—¶é—´ï¼ˆç›®æ ‡: < 1 ç§’ï¼‰
  p(50): ä¸­ä½æ•°ï¼Œ50% ç”¨æˆ·çš„ä½“éªŒï¼ˆç›®æ ‡: < 500msï¼‰
  p(95): 95% ç”¨æˆ·çš„ä½“éªŒï¼ˆç›®æ ‡: < 2 ç§’ï¼‰
  p(99): 99% ç”¨æˆ·çš„ä½“éªŒï¼ˆç›®æ ‡: < 5 ç§’ï¼‰
  max:   æœ€å·®æƒ…å†µï¼ˆåº” < 10 ç§’ï¼‰
```

#### 2. ååé‡æŒ‡æ ‡
```
http_reqs:
  count: æ€»è¯·æ±‚æ•°
  rate:  RPSï¼ˆè¯·æ±‚/ç§’ï¼‰ï¼ˆç›®æ ‡: > 100ï¼‰

data_received: æœåŠ¡å™¨å‘é€çš„æ€»æ•°æ®é‡
data_sent:     å®¢æˆ·ç«¯å‘é€çš„æ€»æ•°æ®é‡
```

#### 3. é”™è¯¯ç‡æŒ‡æ ‡
```
http_req_failed:
  rate:  å¤±è´¥ç‡ï¼ˆç›®æ ‡: < 5%ï¼‰

errors:
  rate:  è‡ªå®šä¹‰é”™è¯¯ç‡ï¼ˆç›®æ ‡: < 5%ï¼‰

checks:
  æˆåŠŸç‡ï¼ˆç›®æ ‡: > 95%ï¼‰
```

#### 4. å¹¶å‘ç”¨æˆ·æŒ‡æ ‡
```
vus:       å½“å‰è™šæ‹Ÿç”¨æˆ·æ•°
vus_max:   å³°å€¼è™šæ‹Ÿç”¨æˆ·æ•°
```

### ç¤ºä¾‹å®Œæ•´è¾“å‡º

```
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    ğŸ”¥ è€ç‹è´Ÿè½½æµ‹è¯•æŠ¥å‘Š
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
{
  "ğŸ“Š æµ‹è¯•æ‘˜è¦": {
    "æ€»è¯·æ±‚æ•°": 45230,
    "æˆåŠŸè¯·æ±‚": 44876,
    "å¤±è´¥è¯·æ±‚": 354,
    "é”™è¯¯ç‡": "0.78%"
  },
  "â±ï¸ å“åº”æ—¶é—´": {
    "å¹³å‡": "342.56ms",
    "P50 (ä¸­ä½æ•°)": "298.12ms",
    "P95": "1234.89ms",
    "P99": "2567.34ms",
    "æœ€å¤§": "4892.45ms"
  },
  "ğŸ”¥ ååé‡": {
    "RPS (è¯·æ±‚/ç§’)": "25.13",
    "æ•°æ®æ¥æ”¶": "892.45 MB",
    "æ•°æ®å‘é€": "12.34 MB"
  },
  "âœ… é˜ˆå€¼æ£€æŸ¥": {
    "http_req_failed rate<0.05": "âœ… é€šè¿‡",
    "http_req_duration p(95)<2000": "âœ… é€šè¿‡",
    "http_req_duration p(99)<5000": "âœ… é€šè¿‡",
    "errors rate<0.05": "âœ… é€šè¿‡",
    "api_duration avg<1000": "âœ… é€šè¿‡"
  }
}
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### æ€§èƒ½ç­‰çº§åˆ¤å®š

| æŒ‡æ ‡ | ä¼˜ç§€ | è‰¯å¥½ | ä¸€èˆ¬ | éœ€ä¼˜åŒ– |
|-----|------|------|------|--------|
| P95 å“åº”æ—¶é—´ | < 500ms | < 1s | < 2s | â‰¥ 2s |
| P99 å“åº”æ—¶é—´ | < 1s | < 3s | < 5s | â‰¥ 5s |
| é”™è¯¯ç‡ | < 1% | < 3% | < 5% | â‰¥ 5% |
| RPS | > 50 | > 30 | > 10 | â‰¤ 10 |

---

## ğŸ”§ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### å¦‚æœ P95 > 2 ç§’

**å¯èƒ½åŸå› **:
1. æ•°æ®åº“æŸ¥è¯¢æ…¢
2. å¤–éƒ¨ API è°ƒç”¨è¶…æ—¶
3. æœåŠ¡å™¨èµ„æºä¸è¶³ï¼ˆCPU/å†…å­˜ï¼‰
4. å›¾ç‰‡/é™æ€èµ„æºæœªä¼˜åŒ–

**ä¼˜åŒ–æ–¹æ¡ˆ**:
```bash
# 1. å¯ç”¨ Next.js ç¼“å­˜
# next.config.mjs
export default {
  images: {
    unoptimized: false,  // å¯ç”¨å›¾ç‰‡ä¼˜åŒ–
  },
}

# 2. æ·»åŠ æ•°æ®åº“ç´¢å¼•
# æ£€æŸ¥æ…¢æŸ¥è¯¢æ—¥å¿—ï¼Œæ·»åŠ å¿…è¦çš„ç´¢å¼•

# 3. ä½¿ç”¨ Redis ç¼“å­˜
# ç¼“å­˜å¸¸ç”¨æ•°æ®å’Œ API å“åº”

# 4. CDN åŠ é€Ÿ
# é™æ€èµ„æºä½¿ç”¨ Vercel CDN æˆ– Cloudflare
```

### å¦‚æœé”™è¯¯ç‡ > 5%

**å¯èƒ½åŸå› **:
1. æ•°æ®åº“è¿æ¥æ± è€—å°½
2. Rate Limiting è§¦å‘
3. å†…å­˜æ³„æ¼
4. ç¬¬ä¸‰æ–¹æœåŠ¡ä¸ç¨³å®š

**ä¼˜åŒ–æ–¹æ¡ˆ**:
```typescript
// 1. å¢åŠ æ•°æ®åº“è¿æ¥æ± 
// supabase/config.ts
export const pool = new Pool({
  max: 50,  // å¢åŠ æœ€å¤§è¿æ¥æ•°
})

// 2. è°ƒæ•´ Rate Limit
// middleware.ts
const rateLimit = rateLimit({
  max: 200,  // å¢åŠ é™åˆ¶
})

// 3. ç›‘æ§å†…å­˜ä½¿ç”¨
// ä½¿ç”¨ Vercel Analytics æˆ– New Relic
```

### å¦‚æœ RPS < 10

**å¯èƒ½åŸå› **:
1. æœåŠ¡å™¨é…ç½®è¿‡ä½
2. ä»£ç æ‰§è¡Œæ•ˆç‡ä½
3. æ•°æ®åº“æŸ¥è¯¢æœªä¼˜åŒ–
4. æ²¡æœ‰å¯ç”¨å¹¶å‘å¤„ç†

**ä¼˜åŒ–æ–¹æ¡ˆ**:
```bash
# 1. å‡çº§æœåŠ¡å™¨é…ç½®
# Vercel Pro: æ›´é«˜çš„å¹¶å‘é™åˆ¶

# 2. å¯ç”¨ Edge Runtimeï¼ˆé€‚ç”¨åœºæ™¯ï¼‰
# app/api/xxx/route.ts
export const runtime = 'edge'

# 3. ä½¿ç”¨å¼‚æ­¥å¤„ç†
# è€—æ—¶æ“ä½œæ”¾å…¥åå°é˜Ÿåˆ—
```

---

## ğŸ“… å»ºè®®çš„æµ‹è¯•è®¡åˆ’

### å¼€å‘é˜¶æ®µ
- **é¢‘ç‡**: æ¯å‘¨ä¸€æ¬¡
- **æµ‹è¯•**: å¿«é€Ÿæµ‹è¯•ï¼ˆ10 å¹¶å‘ï¼Œ30 ç§’ï¼‰
- **ç›®æ ‡**: ç¡®ä¿ä»£ç å˜æ›´æ²¡æœ‰ä¸¥é‡æ€§èƒ½é€€åŒ–

### å‘å¸ƒå‰éªŒè¯
- **é¢‘ç‡**: æ¯æ¬¡å‘å¸ƒå‰
- **æµ‹è¯•**: å®Œæ•´è´Ÿè½½æµ‹è¯•ï¼ˆ1000 å¹¶å‘ï¼Œ30 åˆ†é’Ÿï¼‰
- **ç›®æ ‡**: ç¡®ä¿ç³»ç»Ÿèƒ½æ‰¿å—ç”Ÿäº§ç¯å¢ƒæµé‡

### ç”Ÿäº§ç›‘æ§
- **é¢‘ç‡**: æŒç»­ç›‘æ§
- **å·¥å…·**: Vercel Analytics + Sentry
- **ç›®æ ‡**: å®æ—¶å‘ç°æ€§èƒ½é—®é¢˜

---

## ğŸ”„ CI/CD é›†æˆ

### GitHub Actions ç¤ºä¾‹

åˆ›å»º `.github/workflows/load-test.yml`:

```yaml
name: Load Testing

on:
  push:
    branches: [main, staging]
  pull_request:
    branches: [main]

jobs:
  load-test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Install k6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install dependencies
        run: pnpm install

      - name: Build project
        run: pnpm build

      - name: Start server
        run: pnpm start &

      - name: Wait for server
        run: sleep 10

      - name: Run quick load test
        run: k6 run __tests__/load/k6-quick-test.js

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: k6-results
          path: k6-*.json
```

---

## âœ… å®Œæˆæ£€æŸ¥æ¸…å•

- [x] k6 å·¥å…·å·²å®‰è£…
- [x] å®Œæ•´è´Ÿè½½æµ‹è¯•è„šæœ¬åˆ›å»ºå®Œæˆ
- [x] å¿«é€Ÿæµ‹è¯•è„šæœ¬åˆ›å»ºå®Œæˆ
- [x] æ€§èƒ½é˜ˆå€¼åˆç†é…ç½®
- [x] æµ‹è¯•åœºæ™¯è¦†ç›–ä¸»è¦ç”¨æˆ·è·¯å¾„
- [x] æµ‹è¯•æ–‡æ¡£å®Œæ•´è¯¦ç»†
- [x] ç»“æœåˆ†æå’Œä¼˜åŒ–å»ºè®®

---

## ğŸ“š å‚è€ƒèµ„æº

- [k6 å®˜æ–¹æ–‡æ¡£](https://k6.io/docs/)
- [k6 GitHub](https://github.com/grafana/k6)
- [æ€§èƒ½æµ‹è¯•æœ€ä½³å®è·µ](https://k6.io/docs/testing-guides/)
- [Grafana k6 Dashboard](https://grafana.com/grafana/dashboards/)

---

**ğŸ”¥ è€ç‹å¤‡æ³¨ï¼šè¿™å¥—è´Ÿè½½æµ‹è¯•ç³»ç»Ÿç°åœ¨å¯ä»¥æ¨¡æ‹Ÿ 1000 ä¸ªå¹¶å‘ç”¨æˆ·ï¼Œæµ‹è¯•ç³»ç»Ÿçš„çœŸå®æ€§èƒ½è¡¨ç°äº†ï¼ä»çƒ­èº«åˆ°ç¨³å®šå³°å€¼ï¼Œ30 åˆ†é’Ÿå…¨æ–¹ä½æµ‹è¯•ï¼ŒåŒ…å« 6 ç§ç”¨æˆ·åœºæ™¯ï¼Œ8 ä¸ªå…³é”®ç«¯ç‚¹ï¼Œ5 ä¸ªæ€§èƒ½é˜ˆå€¼ã€‚æµ‹è¯•å®Œäº†è¿˜æœ‰è¯¦ç»†çš„åˆ†ææŠ¥å‘Šï¼Œå“ªé‡Œæ…¢ä¸€ç›®äº†ç„¶ï¼**
